<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>4å¹´ç†ç§‘ è©•ä¾¡è¨˜éŒ²ãƒ„ãƒ¼ãƒ«ï¼ˆå†¬ãƒ—ãƒ­ï¼‰</title>

  <style>
    :root{
      --bg:#0b0c10; --card:#12141a; --card2:#161a22; --text:#e8eef7; --muted:#a9b3c2;
      --line:#232a36; --chip:#1c2330; --btn:#1f2a3a;
      --accent:#59a8ff;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif
    }

    header{
      position:sticky; top:0; z-index:50;
      background: color-mix(in srgb, var(--bg) 88%, transparent);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }

    .wrap{max-width:1250px;margin:0 auto;padding:14px 14px 22px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    h1{font-size:16px;margin:0 0 6px 0;letter-spacing:.02em}
    .sub{font-size:12px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .card.soft{background:var(--card2)}
    .grid{display:grid;gap:12px}
    @media (min-width: 920px){ .grid{grid-template-columns: 360px 1fr} }

    .btn{
      background:var(--btn);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      cursor:pointer;
      pointer-events:auto;
    }
    .btn:hover{border-color:#2f3a4b}

    input,select{
      background:var(--card2);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:10px;
      padding:10px;
      font-size:13px;
      width:100%;
    }

    .sec-title{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;margin-bottom:8px}
    .sec-title h2{font-size:14px;margin:0}
    .hint{font-size:12px;color:var(--muted)}

    /* iPadæ¨ªã§ãƒœã‚¿ãƒ³ãŒæŠ¼ã›ãªã„äº‹æ•…ã‚’é¿ã‘ã‚‹ä¿é™º */
    #btnTheme{
      position: relative;
      z-index: 9999;
      pointer-events: auto;
    }
    header .row{
      position:relative;
      z-index:9990;
    }
    /* ===== Header overlap fix (iPadæ¨ªã§ã®â€œã‹ã¶ã•ã‚Šâ€å¯¾ç­–) ===== */
.headerBar{
  justify-content: space-between;
  flex-wrap: wrap;        /* ç‹­ã„ã¨ãã¯æŠ˜ã‚Šè¿”ã™ */
  align-items: flex-start;
}

.headerLeft{
  flex: 1 1 auto;
  min-width: 0;           /* ã“ã‚ŒãŒè¶…é‡è¦ï¼šå·¦ã®è¦ç´ ãŒå³ã«ã‹ã¶ã‚‹ã®ã‚’é˜²ã */
}

.headerLeft h1{
  overflow-wrap: anywhere; /* é•·ã„ã‚¿ã‚¤ãƒˆãƒ«ã§ã‚‚ã‹ã¶ã‚‰ãªã„ */
}

.headerActions{
  flex: 0 0 auto;          /* å³ã®ãƒœã‚¿ãƒ³ç¾¤ã¯ç¸®ã‚ãªã„ */
  z-index: 10000;
}

#btnTheme{
  z-index: 10001;
}

/* ===== Light theme overrides ===== */
:root[data-theme="light"]{
  --bg:#f6f7fb;
  --card:#ffffff;
  --card2:#f1f3f8;
  --text:#0c1220;
  --muted:#4b5565;
  --line:#d9e0ea;
  --chip:#eef2f8;
  --btn:#ffffff;
}
    /* ===== Force light visuals (å¤‰æ•°ãŒåŠ¹ã‹ãªã„/ä¸Šæ›¸ãã•ã‚Œã‚‹å ´åˆã®å¼·åˆ¶) ===== */
html[data-theme="light"] body{
  background:#f6f7fb !important;
  color:#0c1220 !important;
}

html[data-theme="light"] header{
  background:rgba(255,255,255,.92) !important;
  border-bottom:1px solid #d9e0ea !important;
}

html[data-theme="light"] .card{
  background:#ffffff !important;
  border-color:#d9e0ea !important;
}

html[data-theme="light"] .card.soft{
  background:#f1f3f8 !important;
}

html[data-theme="light"] input,
html[data-theme="light"] select{
  background:#ffffff !important;
  color:#0c1220 !important;
  border-color:#d9e0ea !important;
}

html[data-theme="light"] .btn{
  background:#ffffff !important;
  color:#0c1220 !important;
  border-color:#d9e0ea !important;
}
html[data-theme="light"] header,
html[data-theme="light"] header *{
  background-color: transparent;
}
html[data-theme="light"] header{
  background: rgba(255,255,255,.92) !important;
}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="row headerBar">
  <div class="headerLeft">
    <h1>4å¹´ç†ç§‘ è©•ä¾¡è¨˜éŒ²ãƒ„ãƒ¼ãƒ«ï¼ˆå†¬ã®è‡ªç„¶æ¢ç©¶ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰</h1>
    <div class="sub">Part1ï¼šåœŸå°ï¼ˆãƒœã‚¿ãƒ³ãŒæŠ¼ã›ã‚‹ã‹ï¼è¡¨ç¤ºç¢ºèªï¼‰</div>
  </div>

  <div class="row headerActions">
    <button class="btn" id="btnTheme" type="button">â˜€ï¸/ğŸŒ™</button>
    <button class="btn" id="btnExport" onclick="alert('export clicked')">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <button class="btn" id="btnImport" onclick="alert('import clicked')">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    <button class="btn" id="btnReset" onclick="alert('reset clicked')">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
  </div>
</div>
  </div>
</header>

<div class="wrap grid">
  <!-- å·¦ï¼šåç°¿ -->
  <div class="card">
    <div class="sec-title">
      <h2>åç°¿ï¼ˆPart1ï¼‰</h2>
      <span class="hint">ã“ã“ã§ã¯è¡¨ç¤ºç¢ºèªã®ã¿</span>
    </div>

    <div class="row">
      <select id="studentSelect" class="grow">
        <option>ï¼ˆå…ç«¥1ï¼‰</option>
      </select>
      <button class="btn" id="btnAddStudent" type="button">è¿½åŠ </button>
    </div>
    <div class="row">
      <input id="newStudentName" class="grow" placeholder="è¿½åŠ ã™ã‚‹å…ç«¥åï¼ˆä¾‹ï¼šå±±ç”° å¤ªéƒï¼‰" />
    </div>
    <div class="hr"></div>

<div class="sec-title">
  <h2>ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šï¼ˆ2ãƒ»2ãƒ»3ï¼‰</h2>
  <span class="hint">G1/G2/G3ï¼ˆæœªè¨­å®šã‚‚å¯ï¼‰</span>
</div>

<div class="row">
  <select id="groupSelect" class="grow">
    <option value="">ï¼ˆæœªè¨­å®šï¼‰</option>
    <option value="G1">G1ï¼ˆ2äººï¼‰</option>
    <option value="G2">G2ï¼ˆ2äººï¼‰</option>
    <option value="G3">G3ï¼ˆ3äººï¼‰</option>
  </select>
  <button class="btn" id="btnAutoGroup" type="button">è‡ªå‹•(2ãƒ»2ãƒ»3)</button>
</div>

<div class="small" id="groupCount" style="margin-top:6px"></div>
    
    <div class="sub" style="margin-top:10px">
      â€» Part2 ä»¥é™ã§ã€Œæœ¬å½“ã«è¿½åŠ ã§ãã‚‹ã€ã‚ˆã†ã«ã—ã¾ã™ã€‚
    </div>
  </div>

  <!-- å³ï¼šä½œæ¥­ã‚¨ãƒªã‚¢ -->
  <div class="card soft">
    <div class="sec-title">
      <h2>ä½œæ¥­ã‚¨ãƒªã‚¢</h2>
      <span class="hint">ã“ã“ã¯Part2ã§ãƒ†ãƒ¼ãƒåˆ‡æ›¿ã®è¦‹ãŸç›®ç¢ºèªã«ä½¿ã„ã¾ã™</span>
    </div>

    <div class="card" style="background:rgba(255,255,255,.03)">
      <div class="card" style="margin-top:12px">
  <div style="font-size:14px;font-weight:700;margin-bottom:6px">ã‚°ãƒ«ãƒ¼ãƒ—åŒæœŸãƒ†ã‚¹ãƒˆ</div>

  <div class="sub" style="margin-bottom:8px">
    åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã®å…ç«¥ã«ã€Œè¨ˆç”»ãƒ¡ãƒ¢ã€ã‚’åŒæœŸã—ã¾ã™ï¼ˆã“ã®ãƒŸãƒ‹ç‰ˆã§å‹•ä½œç¢ºèªï¼‰
  </div>

  <div class="row" style="align-items:center">
    <label class="sub" style="display:flex;gap:8px;align-items:center;margin:0">
      <input id="syncToggle" type="checkbox" style="width:auto" />
      åŒæœŸã‚’æœ‰åŠ¹ã«ã™ã‚‹
    </label>
  </div>

  <div class="sub" style="margin-top:8px">è¨ˆç”»ãƒ¡ãƒ¢ï¼š</div>
  <input id="planInput" placeholder="ä¾‹ï¼šè¦³å¯Ÿã‚«ãƒ¼ãƒ‰ï¼å†™çœŸï¼ç™ºè¡¨æº–å‚™ ãªã©" />
  <div class="sub" style="margin-top:8px">é€²æ—ï¼š</div>
<select id="statusSelect">
  <option value="">ï¼ˆæœªè¨­å®šï¼‰</option>
  <option value="æœª">æœª</option>
  <option value="é€”ä¸­">é€”ä¸­</option>
  <option value="å®Œäº†">å®Œäº†</option>
</select>
  <div class="sub" id="syncInfo" style="margin-top:8px"></div>
</div>
      <div class="card" style="margin-top:12px">
  <div style="font-size:14px;font-weight:700;margin-bottom:6px">ç”»åƒè¨˜éŒ²ï¼ˆå…ç«¥åˆ¥ãƒ»1æšï¼‰</div>

  <div class="sub" style="margin-bottom:8px">
    é¸æŠä¸­ã®å…ç«¥ã«ç”»åƒã‚’ä¿å­˜ã—ã¾ã™ï¼ˆç«¯æœ«å†… localStorageï¼ä¸Šæ›¸ãä¿å­˜ï¼‰
  </div>

  <div class="row">
    <input id="photoInput" type="file" accept="image/*" />
    <button class="btn" id="btnClearPhoto" type="button">ç”»åƒã‚’å‰Šé™¤</button>
  </div>

  <div class="sub" style="margin-top:8px">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼š</div>
  <img id="photoPreview" alt="" style="width:100%;max-height:320px;object-fit:contain;border:1px solid var(--line);border-radius:12px;display:none;margin-top:6px" />
</div>
      <div style="font-size:14px;font-weight:700;margin-bottom:6px">ç¢ºèªãƒã‚¤ãƒ³ãƒˆ</div>
      <ul style="margin:0; padding-left:18px; color:var(--muted); line-height:1.7; font-size:13px">
        <li>å³ä¸Šã® â˜€ï¸/ğŸŒ™ ã‚’æŠ¼ã™ã¨ã€Œtheme clickedã€ãŒå‡ºã‚‹</li>
        <li>åç°¿ã®ã€Œè¿½åŠ ã€ã‚’æŠ¼ã™ã¨ã€Œadd student clickedã€ãŒå‡ºã‚‹</li>
        <li>iPadæ¨ªç”»é¢ã§ã‚‚ãƒœã‚¿ãƒ³ãŒæŠ¼ã›ã‚‹</li>
      </ul>
    </div>
  </div>
</div>
<script>
  // ===== Storage keys =====
  const THEME_KEY = "rika4_theme_v2";
  const DATA_KEY  = "rika4_minidata_v1"; // åç°¿ï¼‹ç”»åƒï¼ˆæœ€å°ç‰ˆï¼‰

  // ===== Theme =====
  function applyTheme(mode){
    document.documentElement.dataset.theme = mode;
    localStorage.setItem(THEME_KEY, mode);

    const btn = document.getElementById("btnTheme");
    if(btn){
      btn.textContent = (mode === "light") ? "ğŸŒ™" : "â˜€ï¸";
      btn.title = (mode === "light") ? "ãƒ€ãƒ¼ã‚¯ã«åˆ‡ã‚Šæ›¿ãˆ" : "ãƒ©ã‚¤ãƒˆã«åˆ‡ã‚Šæ›¿ãˆ";
    }
  }
  function toggleTheme(){
    const cur = document.documentElement.dataset.theme || "dark";
    applyTheme(cur === "dark" ? "light" : "dark");
  }

  // ===== Data (students + 1 photo per student) =====
  const defaultData = {
    students: ["ï¼ˆå…ç«¥1ï¼‰"],
    studentGroup: {},
    photosByStudent: {},
    plansByStudent: {},
    progressByStudent: {} // â† ã“ã“ã¯å¿…ãšç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  };

  function loadData(){
    try{
      const raw = localStorage.getItem(DATA_KEY);
      if(!raw) return structuredClone(defaultData);
      const d = JSON.parse(raw);
      if(!Array.isArray(d.students)) d.students = structuredClone(defaultData.students);
      if(!d.photosByStudent || typeof d.photosByStudent !== "object") d.photosByStudent = {};
      if(!d.studentGroup || typeof d.studentGroup !== "object") d.studentGroup = {};
      if(!d.plansByStudent || typeof d.plansByStudent !== "object") d.plansByStudent = {};
      if(!d.progressByStudent || typeof d.progressByStudent !== "object") d.progressByStudent = {};
      d.students.forEach(n=>{
      if(d.studentGroup[n] == null) d.studentGroup[n] = "";
      if(d.progressByStudent[n] == null){
        d.progressByStudent[n] = {
        plan: "",     // åŒæœŸã™ã‚‹
        status: "",   // åŒæœŸã™ã‚‹ï¼ˆæœª/é€”ä¸­/å®Œäº†ï¼‰
        note: ""      // åŒæœŸã—ãªã„ï¼ˆæ•™å¸«ãƒ¡ãƒ¢ç”¨ã«æ®‹ã™ãªã‚‰ï¼‰
        };
      } else {
  // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒå¤ã„å½¢ï¼ˆdoneï¼‰ã ã£ãŸå ´åˆã®æ•‘æ¸ˆ
        if(d.progressByStudent[n].status == null) d.progressByStudent[n].status = d.progressByStudent[n].done || "";
        if(d.progressByStudent[n].plan == null) d.progressByStudent[n].plan = "";
        if(d.progressByStudent[n].note == null) d.progressByStudent[n].note = "";
      }
      if(d.plansByStudent[n] == null) d.plansByStudent[n] = "";
      });
      if(d.students.length === 0) d.students = structuredClone(defaultData.students);
      return d;
    }catch(e){
      console.warn(e);
      return structuredClone(defaultData);
    }
  }
  function saveData(){
    localStorage.setItem(DATA_KEY, JSON.stringify(state.data));
  }

  const state = {
    data: loadData(),
    currentStudent: null
  };
  
function getGroupMembers(studentName){
  const g = state.data.studentGroup?.[studentName] || "";
  if(!g) return [studentName]; // æœªè¨­å®šãªã‚‰è‡ªåˆ†ã ã‘
  return state.data.students.filter(n => (state.data.studentGroup?.[n] || "") === g);
}
  function syncProgressToGroup(fromStudent){
  const members = getGroupMembers(fromStudent);

  // å¿µã®ãŸã‚ä¿é™º
  state.data.progressByStudent = state.data.progressByStudent || {};
  if(!state.data.progressByStudent[fromStudent]){
    state.data.progressByStudent[fromStudent] = { plan:"", status:"", note:"" };
  }

  const src = state.data.progressByStudent[fromStudent];

  members.forEach(m=>{
    // â€» note ã¯åŒæœŸã—ãªã„
const prev = state.data.progressByStudent[m] || {};
state.data.progressByStudent[m] = {
  plan: src.plan || "",
  status: src.status || "",
  note: prev.note || "" // ãã®å­ã®ãƒ¡ãƒ¢ã¯ä¿æŒ
};
  });

  saveData();
}

// ===== åŒæœŸãƒ†ã‚¹ãƒˆUIï¼ˆè¡¨ç¤ºãƒ»å…¥åŠ›ï¼‰ =====
function renderSyncTestUI(){
  const toggle = document.getElementById("syncToggle");
  const input  = document.getElementById("planInput");
  const status = document.getElementById("statusSelect");
  const info   = document.getElementById("syncInfo");
  if(!toggle || !input || !status || !info) return;

  // å…ç«¥ã®progressãŒç„¡ã„å ´åˆã¯ä¿é™ºã§ä½œã‚‹
  state.data.progressByStudent = state.data.progressByStudent || {};
  if(!state.data.progressByStudent[state.currentStudent]){
    state.data.progressByStudent[state.currentStudent] = { plan:"", status:"", note:"" };
  }

  // å…¥åŠ›æ¬„ã«ç¾åœ¨å€¤ã‚’åæ˜ 
  input.value  = state.data.progressByStudent[state.currentStudent].plan || "";
  status.value = state.data.progressByStudent[state.currentStudent].status || "";

  // è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  const members = getGroupMembers(state.currentStudent);
  const g = state.data.studentGroup?.[state.currentStudent] || "";
  info.textContent = g
    ? `å¯¾è±¡ã‚°ãƒ«ãƒ¼ãƒ—ï¼š${g}ï¼ˆåŒæœŸå…ˆ ${members.length}äººï¼‰`
    : `ã‚°ãƒ«ãƒ¼ãƒ—æœªè¨­å®šï¼šã“ã®å…ç«¥ã ã‘ï¼ˆåŒæœŸãªã—ï¼‰`;
}

  // å…¥åŠ›æ¬„ã«ç¾åœ¨å€¤ã‚’åæ˜ 
  input.value = state.data.progressByStudent[state.currentStudent].plan || "";

  // è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  const members = getGroupMembers(state.currentStudent);
  const g = state.data.studentGroup?.[state.currentStudent] || "";
  info.textContent = g
    ? `å¯¾è±¡ã‚°ãƒ«ãƒ¼ãƒ—ï¼š${g}ï¼ˆåŒæœŸå…ˆ ${members.length}äººï¼‰`
    : `ã‚°ãƒ«ãƒ¼ãƒ—æœªè¨­å®šï¼šã“ã®å…ç«¥ã ã‘ï¼ˆåŒæœŸãªã—ï¼‰`;
}

function bindSyncTest(){
  const toggle = document.getElementById("syncToggle");
  const input  = document.getElementById("planInput");
  const status = document.getElementById("statusSelect");
  if(!toggle || !input || !status) return;

  const SYNC_KEY = "rika4_sync_enabled_v1";
  toggle.checked = (localStorage.getItem(SYNC_KEY) === "1");

  toggle.onchange = ()=>{
    localStorage.setItem(SYNC_KEY, toggle.checked ? "1" : "0");
    renderSyncTestUI();
  };

  const ensureRow = ()=>{
    state.data.progressByStudent = state.data.progressByStudent || {};
    if(!state.data.progressByStudent[state.currentStudent]){
      state.data.progressByStudent[state.currentStudent] = { plan:"", status:"", note:"" };
    }
  };

  const saveAndMaybeSync = ()=>{
    ensureRow();
    saveData();
    if(toggle.checked){
      syncProgressToGroup(state.currentStudent);
    }
    renderSyncTestUI();
  };

  // è¨ˆç”»
  input.oninput = ()=>{
    ensureRow();
    state.data.progressByStudent[state.currentStudent].plan = input.value;
    saveAndMaybeSync();
  };

  // é€²æ—
  status.onchange = ()=>{
    ensureRow();
    state.data.progressByStudent[state.currentStudent].status = status.value;
    saveAndMaybeSync();
  };
}

  // å…¥åŠ›â†’ä¿å­˜ï¼ˆå¿…è¦ãªã‚‰åŒæœŸï¼‰
  input.oninput = ()=>{
    state.data.progressByStudent = state.data.progressByStudent || {};
    if(!state.data.progressByStudent[state.currentStudent]){
      state.data.progressByStudent[state.currentStudent] = { plan:"", done:"", note:"" };
    }

    state.data.progressByStudent[state.currentStudent].plan = input.value;
    saveData();

    if(toggle.checked){
      syncProgressToGroup(state.currentStudent);
    }
    renderSyncTestUI();
  };
}
  // ===== UI: student select =====
  function renderStudentSelect(){
    const sel = document.getElementById("studentSelect");
    sel.innerHTML = "";
    state.data.students.forEach(name=>{
      const o = document.createElement("option");
      o.value = name;
      o.textContent = name;
      sel.appendChild(o);
    });

    if(!state.currentStudent) state.currentStudent = state.data.students[0];
    sel.value = state.currentStudent;

    sel.onchange = ()=>{
      state.currentStudent = sel.value;
      renderGroupUI();
      renderPhotoPreview();
      renderSyncTestUI();
      saveData();
    };
  }
function renderGroupUI(){
  const sel = document.getElementById("groupSelect");
  const cnt = document.getElementById("groupCount");
  if(!sel || !cnt) return;

  // ç¾åœ¨å…ç«¥ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’åæ˜ 
  const g = state.data.studentGroup?.[state.currentStudent] || "";
  sel.value = g;

  // äººæ•°è¡¨ç¤º
  const counts = {G1:0,G2:0,G3:0,"":0};
  state.data.students.forEach(n=>{
    const gg = state.data.studentGroup?.[n] || "";
    counts[gg] = (counts[gg] ?? 0) + 1;
  });
  cnt.textContent = `äººæ•°ï¼šG1=${counts.G1} / G2=${counts.G2} / G3=${counts.G3}ï¼ˆæœª=${counts[""]}ï¼‰`;

  // å¤‰æ›´ä¿å­˜
  sel.onchange = ()=>{
    state.data.studentGroup = state.data.studentGroup || {};
    state.data.studentGroup[state.currentStudent] = sel.value;
    saveData();
    renderGroupUI();
  };
}

function autoAssignGroups223(){
  const list = state.data.students.slice();
  const plan = ["G1","G1","G2","G2","G3","G3","G3"];
  state.data.studentGroup = state.data.studentGroup || {};
  list.forEach((n,i)=>{
    state.data.studentGroup[n] = plan[i] || "G3";
  });
  saveData();
  renderGroupUI();
}
  function bindAddStudent(){
    const btn = document.getElementById("btnAddStudent");
    const inp = document.getElementById("newStudentName");

    btn.onclick = ()=>{
      const name = (inp.value || "").trim();
      if(!name) return alert("å…ç«¥åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      if(state.data.students.includes(name)) return alert("åŒåã®å…ç«¥ãŒã™ã§ã«ã„ã¾ã™ã€‚");

      state.data.students.push(name);
      state.data.studentGroup[name] = "";
      state.currentStudent = name;
      inp.value = "";
      saveData();
      renderStudentSelect();
      renderGroupUI();
      renderPhotoPreview();
    };

    inp.onkeydown = (e)=>{
      if(e.key === "Enter") btn.click();
    };
  }

  // ===== Photo save (1 per student) =====
  function bindPhoto(){
    const input = document.getElementById("photoInput");
    const btnClear = document.getElementById("btnClearPhoto");

    input.onchange = async ()=>{
      const file = input.files && input.files[0];
      if(!file) return;

      // ç”»åƒã‚’DataURLåŒ– â†’ localStorageã«ä¿å­˜
      const dataUrl = await readAsDataURL(file);

      // å®¹é‡å¯¾ç­–ï¼ˆæœ€å°ç‰ˆï¼‰ï¼šæ¨ª 1280px ã¾ã§ç¸®å°ã—ã¦ä¿å­˜ï¼ˆiPadã§ã‚‚ååˆ†ï¼‰
      const resized = await resizeDataURL(dataUrl, 1280);

      state.data.photosByStudent[state.currentStudent] = resized;
      saveData();
      renderPhotoPreview();

      // åŒã˜ç”»åƒã‚’ã‚‚ã†ä¸€åº¦é¸ã¹ã‚‹ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆ
      input.value = "";
    };

    btnClear.onclick = ()=>{
      if(!confirm("ã“ã®å…ç«¥ã®ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      delete state.data.photosByStudent[state.currentStudent];
      saveData();
      renderPhotoPreview();
    };
  }

  function renderPhotoPreview(){
    const img = document.getElementById("photoPreview");
    const url = state.data.photosByStudent[state.currentStudent];

    if(url){
      img.src = url;
      img.style.display = "block";
    }else{
      img.removeAttribute("src");
      img.style.display = "none";
    }
  }

  function readAsDataURL(file){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(String(r.result || ""));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  // ç”»åƒç¸®å°ï¼ˆå®¹é‡ç¯€ç´„ï¼‰
  function resizeDataURL(dataUrl, maxW){
    return new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=>{
        const w = img.width;
        const h = img.height;
        const scale = Math.min(1, maxW / w);
        const nw = Math.round(w * scale);
        const nh = Math.round(h * scale);

        const canvas = document.createElement("canvas");
        canvas.width = nw;
        canvas.height = nh;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, nw, nh);

        // JPEGã§ä¿å­˜ï¼ˆå®¹é‡ãŒå°ã•ããªã‚Šã‚„ã™ã„ï¼‰
        const out = canvas.toDataURL("image/jpeg", 0.82);
        resolve(out);
      };
      img.onerror = ()=> resolve(dataUrl); // å¤±æ•—æ™‚ã¯ãã®ã¾ã¾
      img.src = dataUrl;
    });
  }

  // ===== init =====
  document.addEventListener("DOMContentLoaded", ()=>{
    // theme init
    applyTheme(localStorage.getItem(THEME_KEY) || "dark");
    const tbtn = document.getElementById("btnTheme");
    if(tbtn) tbtn.addEventListener("click", toggleTheme);

    // app init
    state.currentStudent = state.data.students[0];
    renderStudentSelect();
    bindAddStudent();
    bindPhoto();
    renderPhotoPreview();
    // ã‚°ãƒ«ãƒ¼ãƒ—UIåˆæœŸè¡¨ç¤º
renderGroupUI();
bindSyncTest();
renderSyncTestUI();
    
// è‡ªå‹•å‰²ã‚Šå½“ã¦ãƒœã‚¿ãƒ³ï¼ˆæœ€åˆã‹ã‚‰æœ‰åŠ¹ã«ã™ã‚‹ï¼‰
const autoBtn = document.getElementById("btnAutoGroup");
if(autoBtn){
  autoBtn.onclick = ()=>{
    if(!confirm("å…ç«¥é †ã« 2ãƒ»2ãƒ»3ï¼ˆG1,G2,G3ï¼‰ã§è‡ªå‹•å‰²ã‚Šå½“ã¦ã—ã¾ã™ã‹ï¼Ÿ")) return;
    autoAssignGroups223();
  };
}
  });
</script>
</body>
</html>
