<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>4年理科 評価記録ツール（冬プロ）</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#12141a; --card2:#161a22; --text:#e8eef7; --muted:#a9b3c2;
      --line:#232a36; --accent:#59a8ff; --good:#4ade80; --bad:#fb7185; --warn:#fbbf24;
      --chip:#1c2330; --btn:#1f2a3a;

      --s-miss: rgba(251,113,133,.18); /* 欠 */
      --s-todo: rgba(251,191,36,.14);  /* 未 */
      --s-doing: rgba(89,168,255,.16); /* 途中 */
      --s-done: rgba(74,222,128,.14);  /* 完了 */

      --u-star: rgba(89,168,255,.14);
      --u-bio: rgba(74,222,128,.12);
      --u-water: rgba(251,191,36,.12);
      --u-pres: rgba(168,85,247,.14);
      --u-test: rgba(251,113,133,.12);
      --u-other: rgba(255,255,255,.05);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0c10,#0a0b10 40%,#07080d);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;z-index:50;background:rgba(10,11,16,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1250px;margin:0 auto;padding:14px 14px 22px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    h1{font-size:16px;margin:0 0 6px 0;letter-spacing:.02em}
    .sub{font-size:12px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .card.soft{background:var(--card2)}
    .grow{flex:1}
    .btn{background:var(--btn);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:12px;font-size:13px;cursor:pointer}
    .btn:hover{border-color:#2f3a4b}
    .btn.primary{background:linear-gradient(180deg,#2a63ff,#1f49ff);border-color:#2a63ff}
    .btn.danger{background:linear-gradient(180deg,#ff3b66,#e11d48);border-color:#ff3b66}
    input,select,textarea{background:#0e1118;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px;font-size:13px}
    textarea{min-height:70px;resize:vertical}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:transparent;color:var(--text);cursor:pointer;font-size:13px}
    .tab.active{background:var(--chip);border-color:#2d3a50}
    .grid{display:grid;gap:12px}
    @media (min-width: 920px){ .grid{grid-template-columns: 340px 1fr} }
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .k{padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.02)}
    .k .t{font-size:12px;color:var(--muted)}
    .k .v{font-size:16px;font-weight:700;margin-top:2px;line-height:1.25}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.04);border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .sec-title{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;margin-bottom:8px}
    .sec-title h2{font-size:14px;margin:0}
    .sec-title .hint{font-size:12px;color:var(--muted)}
    .chk{display:flex;gap:10px;align-items:flex-start;padding:10px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.12)}
    .chk input{margin-top:2px}
    .two{display:grid;gap:12px}
    @media (min-width: 760px){ .two{grid-template-columns: 1fr 1fr} }
    details{border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(255,255,255,.02)}
    summary{cursor:pointer;color:var(--muted);font-size:12px}
    .note{font-size:12px;color:var(--muted);line-height:1.55}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .small{font-size:12px;color:var(--muted)}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table td{padding:10px 10px;background:rgba(255,255,255,.02);border-top:1px solid var(--line);border-bottom:1px solid var(--line);vertical-align:top}
    .table td:first-child{border-left:1px solid var(--line);border-radius:12px 0 0 12px}
    .table td:last-child{border-right:1px solid var(--line);border-radius:0 12px 12px 0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .w-110{width:110px}
    .w-140{width:140px}
    .w-170{width:170px}

    .scrollX{overflow:auto;border:1px solid var(--line);border-radius:14px}
    .ovTable{width:max-content; border-collapse:separate; border-spacing:0; min-width:100%}
    .ovTable th,.ovTable td{border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:8px 8px;font-size:12px;vertical-align:top;background:rgba(255,255,255,.02)}
    .ovTable th{position:sticky;top:0;z-index:5;background:rgba(18,20,26,.98);backdrop-filter:blur(8px);font-weight:700}
    .ovTable .sticky{position:sticky;left:0;z-index:6;background:rgba(18,20,26,.98)}
    .ovTable .sticky2{position:sticky;left:0;z-index:7;background:rgba(18,20,26,.98);font-weight:800}
    .cell{border-radius:10px;padding:6px 8px;border:1px solid rgba(255,255,255,.06)}
    .st-未{background:var(--s-todo)}
    .st-途中{background:var(--s-doing)}
    .st-完了{background:var(--s-done)}
    .st-欠{background:var(--s-miss)}
    .u-star{box-shadow: inset 0 0 0 999px var(--u-star)}
    .u-bio{box-shadow: inset 0 0 0 999px var(--u-bio)}
    .u-water{box-shadow: inset 0 0 0 999px var(--u-water)}
    .u-pres{box-shadow: inset 0 0 0 999px var(--u-pres)}
    .u-test{box-shadow: inset 0 0 0 999px var(--u-test)}
    .u-other{box-shadow: inset 0 0 0 999px var(--u-other)}
    .dot{display:inline-block;width:8px;height:8px;border-radius:999px;margin-right:6px;vertical-align:middle}
    .dot.star{background:#59a8ff}
    .dot.bio{background:#4ade80}
    .dot.water{background:#fbbf24}
    .dot.pres{background:#a855f7}
    .dot.test{background:#fb7185}
    .dot.other{background:#a9b3c2}
    .mini{font-size:11px;color:var(--muted);margin-top:4px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>4年理科 評価記録ツール（冬の自然探究プロジェクト）</h1>
        <div class="sub">オフライン／端末内保存（localStorage）・進捗＆提出物＆評価（提案＋手動調整）</div>
      </div>
      <div class="row">
        <button class="btn" id="btnExport">エクスポート(JSON)</button>
        <button class="btn" id="btnImport">インポート</button>
        <button class="btn danger" id="btnReset">全データ削除</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap grid">
  <div class="card">
    <div class="sec-title">
      <h2>名簿</h2>
      <span class="hint">児童を選んで入力</span>
    </div>

    <div class="row">
      <select id="studentSelect" class="grow"></select>
      <button class="btn" id="btnAddStudent">追加</button>
    </div>
    <div class="row">
      <input id="newStudentName" class="grow" placeholder="追加する児童名（例：山田 太郎）" />
    </div>

    <div class="hr"></div>

    <div class="sec-title">
      <h2>現在の児童：<span id="currentName"></span></h2>
      <span class="hint">提案評価（参考）</span>
    </div>

    <div class="kpi">
      <div class="k"><div class="t">冬の星</div><div class="v" id="kStar">-</div></div>
      <div class="k"><div class="t">生き物（まとめ）</div><div class="v" id="kBio">-</div></div>
      <div class="k"><div class="t">水のゆくえ</div><div class="v" id="kWater">-</div></div>
      <div class="k"><div class="t">発表（主体）</div><div class="v" id="kPres">-</div></div>
    </div>

    <div class="hr"></div>

    <div class="sec-title">
      <h2>色分け（単元）</h2>
    </div>
    <div class="note">
      <span class="dot star"></span>星　<span class="dot bio"></span>生き物　<span class="dot water"></span>水　
      <span class="dot pres"></span>発表　<span class="dot test"></span>テスト　<span class="dot other"></span>その他
    </div>

    <div class="hr"></div>

    <div class="sec-title">
      <h2>評価換算ルール（共通）</h2>
    </div>
    <div class="note">
      点数→5段階：5=A / 4=B+ / 3=B / 2=B- / 1,0=C（提案表示）。<br>
      最終調整は各項目の「最終評価」で上書きできます。
    </div>
  </div>

  <div class="card soft">
    <div class="tabs" id="tabs"></div>
    <div id="panel"></div>
  </div>
</div>

<script>
const STORAGE_KEY = "rika4_eval_winter_project_v1";

const UNITS = [
  {id:"all",  label:"（全て）"},
  {id:"star", label:"冬の星"},
  {id:"bio",  label:"生き物（まとめ）"},
  {id:"water",label:"水のゆくえ"},
  {id:"pres", label:"発表"},
  {id:"test", label:"テスト"},
  {id:"other",label:"その他"},
];

const defaultSettings = {
  sessions: [
    {id:"L1",  label:"第1時（導入・一斉）",   type:"whole", unit:"other"},
    {id:"L2",  label:"第2時（一斉）",         type:"whole", unit:"other"},
    {id:"L3",  label:"第3時（自由進度）",     type:"free",  unit:"other"},
    {id:"L4",  label:"第4時（自由進度）",     type:"free",  unit:"other"},
    {id:"L5",  label:"第5時（自由進度）",     type:"free",  unit:"other"},
    {id:"L6",  label:"第6時（一斉）",         type:"whole", unit:"other"},
    {id:"L7",  label:"第7時（自由進度）",     type:"free",  unit:"other"},
    {id:"L8",  label:"第8時（自由進度）",     type:"free",  unit:"other"},
    {id:"L9",  label:"第9時（自由進度）",     type:"free",  unit:"other"},
    {id:"L10", label:"第10時（自由進度）",    type:"free",  unit:"other"},
    {id:"L11", label:"第11時（自由進度）",    type:"free",  unit:"other"},
    {id:"L12", label:"第12時（自由進度/まとめ）", type:"free", unit:"other"},
    {id:"T1",  label:"テスト①",              type:"test",  unit:"test"},
    {id:"T2",  label:"テスト②",              type:"test",  unit:"test"},
  ],
  deliverables: [
    {id:"D1", label:"冬の星：観察カード", unit:"star"},
    {id:"D2", label:"生き物：ヘチマ観察カード", unit:"bio"},
    {id:"D3", label:"生き物：ロイロ シンキングツール", unit:"bio"},
    {id:"D4", label:"水のゆくえ：蒸発 記録カード", unit:"water"},
    {id:"D5", label:"水のゆくえ：結露 記録カード", unit:"water"},
    {id:"D6", label:"発表：ふりかえり（任意）", unit:"pres"},
  ]
};

const defaultData = {
  students: ["（児童1）","（児童2）","（児童3）","（児童4）","（児童5）","（児童6）","（児童7）"],
  byStudent: {},
  settings: structuredClone(defaultSettings)
};

function emptyRecord(){
  return {
    progress: { bySession: {} },
    deliverables: { byId: {} },

    star: {
      ksA: { c1:false, c2:false, c3:false, c4:false, obsCount:"2-3" },
      ksB: { c1:false,c2:false,c3:false,c4:false,c5:false },
      thA: { score:0 },
      thB: { score:0 },
      attitude: { suggest:"", final:"" }
    },
    bio: {
      ksA: { c1:false,c2:false,c3:false,c4:false, seasonCount:"2" },
      ksB: { c1:false,c2:false,c3:false,c4:false,c5:false },
      thA: { score:0, multiUsed:false },
      thB: { score:0, multiUsed:false },
      attitude: { checks:{c1:false,c2:false,c3:false,c4:false,c5:false}, suggest:"", final:"" }
    },
    water: {
      evap: {
        ksA:{c1:false,c2:false,c3:false,c4:false,c5:false},
        ksB:{c1:false,c2:false,c3:false,c4:false,c5:false},
        th:{ score:0 }
      },
      cond: {
        ksA:{c1:false,c2:false,c3:false,c4:false,c5:false},
        ksB:{c1:false,c2:false,c3:false,c4:false,c5:false},
        th:{ score:0 }
      },
      attitude: {
        checks:{c1:false,c2:false,c3:false,c4:false,c5:false},
        severe:false,
        suggest:"", final:""
      }
    },
    pres: {
      attitude: {
        checks:{c1:false,c2:false,c3:false,c4:false,c5:false},
        severe:false,
        suggest:"", final:""
      }
    }
  }
}

function ensureSettingsShape(settings){
  settings.sessions = settings.sessions || structuredClone(defaultSettings.sessions);
  settings.deliverables = settings.deliverables || structuredClone(defaultSettings.deliverables);
  settings.sessions.forEach(s=>{ if(!s.unit) s.unit = (s.type==="test" ? "test" : "other"); });
  settings.deliverables.forEach(d=>{ if(!d.unit) d.unit = "other"; });
}

function migrateStudentRecord(rec, settings){
  rec.progress = rec.progress || {bySession:{}};
  rec.progress.bySession = rec.progress.bySession || {};
  settings.sessions.forEach(s=>{
    if(!rec.progress.bySession[s.id]){
      rec.progress.bySession[s.id] = { status:"未", plan:"", done:"", note:"" };
    } else {
      const v = rec.progress.bySession[s.id];
      if(!v.status) v.status="未";
      if(v.plan==null) v.plan="";
      if(v.done==null) v.done="";
      if(v.note==null) v.note="";
    }
  });

  rec.deliverables = rec.deliverables || {byId:{}};
  rec.deliverables.byId = rec.deliverables.byId || {};
  settings.deliverables.forEach(d=>{
    if(!rec.deliverables.byId[d.id]){
      rec.deliverables.byId[d.id] = { submitted:false, date:"", note:"" };
    } else {
      const v = rec.deliverables.byId[d.id];
      if(v.submitted==null) v.submitted=false;
      if(v.date==null) v.date="";
      if(v.note==null) v.note="";
    }
  });
}

function loadData(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){
      const d = structuredClone(defaultData);
      d.students.forEach(n=> d.byStudent[n] = emptyRecord());
      localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
      return d;
    }
    const d = JSON.parse(raw);
    d.students = d.students || [];
    d.byStudent = d.byStudent || {};
    d.settings = d.settings || structuredClone(defaultSettings);
    ensureSettingsShape(d.settings);
    d.students.forEach(n=>{
      if(!d.byStudent[n]) d.byStudent[n] = emptyRecord();
      migrateStudentRecord(d.byStudent[n], d.settings);
    });
    return d;
  }catch(e){
    console.error(e);
    const d = structuredClone(defaultData);
    d.students.forEach(n=> d.byStudent[n] = emptyRecord());
    return d;
  }
}
function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data)); }

const state = {
  data: loadData(),
  currentStudent: null,
  currentTab: "progress",
  overviewFilterUnit: "all"
};

/** ===== helpers ===== */
const gradeFromScore = (s)=>{
  if(s>=5) return "A";
  if(s===4) return "B+";
  if(s===3) return "B";
  if(s===2) return "B-";
  return "C";
};
const clamp5 = (n)=> Math.max(0, Math.min(5, n|0));
function sumChecks(obj){ return Object.values(obj).filter(Boolean).length; }
function setDeep(obj, path, value){
  const parts = path.split(".");
  let cur = obj;
  for(let i=0;i<parts.length-1;i++){ cur = cur[parts[i]]; }
  cur[parts[parts.length-1]] = value;
}
function unitClass(unitId){
  return unitId==="star"?"u-star":
         unitId==="bio"?"u-bio":
         unitId==="water"?"u-water":
         unitId==="pres"?"u-pres":
         unitId==="test"?"u-test":"u-other";
}
function unitDotClass(unitId){
  return unitId==="star"?"star":
         unitId==="bio"?"bio":
         unitId==="water"?"water":
         unitId==="pres"?"pres":
         unitId==="test"?"test":"other";
}
function unitLabel(unitId){
  return (UNITS.find(u=>u.id===unitId)?.label) || "その他";
}
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

/** ===== CSV ===== */
function csvEscape(value){
  const s = String(value ?? "");
  if(/[,"\n\r]/.test(s)) return `"${s.replaceAll('"','""')}"`;
  return s;
}
function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
function exportProgressCSV(filterUnit="all"){
  const sessions = state.data.settings.sessions.filter(s=> filterUnit==="all" ? true : (s.unit===filterUnit));
  const header = ["児童"];
  sessions.forEach(s=>{
    header.push(`${s.id} 状態`);
    header.push(`${s.id} 計画`);
    header.push(`${s.id} 実績`);
    header.push(`${s.id} 教師メモ`);
  });

  const rows = [header];
  state.data.students.forEach(st=>{
    const r = state.data.byStudent[st];
    const row = [st];
    sessions.forEach(s=>{
      const v = r.progress.bySession[s.id] || {status:"未",plan:"",done:"",note:""};
      row.push(v.status || "");
      row.push(v.plan || "");
      row.push(v.done || "");
      row.push(v.note || "");
    });
    rows.push(row);
  });

  const csv = rows.map(r=> r.map(csvEscape).join(",")).join("\n");
  downloadText(`rika4_progress_${filterUnit}.csv`, csv);
}
function exportDeliverablesCSV(filterUnit="all"){
  const dels = state.data.settings.deliverables.filter(d=> filterUnit==="all" ? true : (d.unit===filterUnit));
  const header = ["児童"];
  dels.forEach(d=>{
    header.push(`${d.id} 提出`);
    header.push(`${d.id} 提出日`);
    header.push(`${d.id} メモ`);
  });

  const rows = [header];
  state.data.students.forEach(st=>{
    const r = state.data.byStudent[st];
    const row = [st];
    dels.forEach(d=>{
      const v = r.deliverables.byId[d.id] || {submitted:false,date:"",note:""};
      row.push(v.submitted ? "提出" : "未提出");
      row.push(v.date || "");
      row.push(v.note || "");
    });
    rows.push(row);
  });

  const csv = rows.map(r=> r.map(csvEscape).join(",")).join("\n");
  downloadText(`rika4_deliverables_${filterUnit}.csv`, csv);
}

/** ===== suggestions ===== */
function computeStarSuggest(rec){
  const ksA_checks = ["c1","c2","c3","c4"].reduce((a,k)=>a+(rec.star.ksA[k]?1:0),0);
  const bonus = (rec.star.ksA.obsCount==="4+") ? 1 : 0;
  const ksA = Math.min(5, ksA_checks + bonus);
  const ksB = sumChecks(rec.star.ksB);
  const thA = clamp5(rec.star.thA.score);
  const thB = clamp5(rec.star.thB.score);
  return { ksA:{score:ksA, grade:gradeFromScore(ksA)}, ksB:{score:ksB, grade:gradeFromScore(ksB)},
           thA:{score:thA, grade:gradeFromScore(thA)}, thB:{score:thB, grade:gradeFromScore(thB)},
           attitude:{grade: rec.star.attitude.final || rec.star.attitude.suggest || ""} };
}
function computeBioSuggest(rec){
  const ksA_checks = ["c1","c2","c3","c4"].reduce((a,k)=>a+(rec.bio.ksA[k]?1:0),0);
  const bonus = (parseInt(rec.bio.ksA.seasonCount,10) >= 3) ? 1 : 0;
  const ksA = Math.min(5, ksA_checks + bonus);
  const ksB = sumChecks(rec.bio.ksB);

  const rawA = clamp5(rec.bio.thA.score);
  const rawB = clamp5(rec.bio.thB.score);
  const advA = !!rec.bio.thA.multiUsed;
  const advB = !!rec.bio.thB.multiUsed;

  let thA_score = rawA;
  let thB_score = rawB;

  if(advA) thA_score = Math.min(5, thA_score + 1);
  if(advB) thB_score = Math.min(5, thB_score + 1);

  if(advA && thA_score <= 1) thA_score = 2;
  if(advB && thB_score <= 1) thB_score = 2;

  const thA_grade = gradeFromScore(thA_score);
  const thB_grade = gradeFromScore(thB_score);

  const attChecks = sumChecks(rec.bio.attitude.checks);
  let attGrade = gradeFromScore(Math.min(5, attChecks));
  if(advA || advB){
    if(attGrade === "C" || attGrade === "B-") attGrade = "B";
  }
  rec.bio.attitude.suggest = attGrade;

  return { ksA:{score:ksA, grade:gradeFromScore(ksA)}, ksB:{score:ksB, grade:gradeFromScore(ksB)},
           thA:{score:thA_score, grade:thA_grade, adv:advA}, thB:{score:thB_score, grade:thB_grade, adv:advB},
           attitude:{grade: rec.bio.attitude.final || rec.bio.attitude.suggest || ""} };
}
function computeWaterSuggest(rec){
  const e_ksA = sumChecks(rec.water.evap.ksA);
  const e_ksB = sumChecks(rec.water.evap.ksB);
  const e_th  = clamp5(rec.water.evap.th.score);

  const c_ksA = sumChecks(rec.water.cond.ksA);
  const c_ksB = sumChecks(rec.water.cond.ksB);
  const c_th  = clamp5(rec.water.cond.th.score);

  let attGrade = gradeFromScore(sumChecks(rec.water.attitude.checks));
  if(rec.water.attitude.severe) attGrade = "C";
  rec.water.attitude.suggest = attGrade;

  return { evap:{ ksA:{score:e_ksA, grade:gradeFromScore(e_ksA)}, ksB:{score:e_ksB, grade:gradeFromScore(e_ksB)}, th:{score:e_th, grade:gradeFromScore(e_th)} },
           cond:{ ksA:{score:c_ksA, grade:gradeFromScore(c_ksA)}, ksB:{score:c_ksB, grade:gradeFromScore(c_ksB)}, th:{score:c_th, grade:gradeFromScore(c_th)} },
           attitude:{grade: rec.water.attitude.final || rec.water.attitude.suggest || ""} };
}
function computePresSuggest(rec){
  let attGrade = gradeFromScore(sumChecks(rec.pres.attitude.checks));
  if(rec.pres.attitude.severe) attGrade = "C";
  rec.pres.attitude.suggest = attGrade;
  return { attitude:{grade: rec.pres.attitude.final || rec.pres.attitude.suggest || ""} };
}

/** ===== UI core ===== */
const tabs = [
  {id:"progress", label:"進捗・提出物（個人）"},
  {id:"overview", label:"一覧（クラス）"},
  {id:"star", label:"冬の星"},
  {id:"bio", label:"生き物（まとめ）"},
  {id:"water", label:"水のゆくえ"},
  {id:"pres", label:"発表（主体）"},
];

function init(){
  if(!state.data.students.length){
    state.data.students = ["（児童1）"];
    state.data.byStudent["（児童1）"] = emptyRecord();
  }
  ensureSettingsShape(state.data.settings);
  state.data.students.forEach(n=>{
    if(!state.data.byStudent[n]) state.data.byStudent[n] = emptyRecord();
    migrateStudentRecord(state.data.byStudent[n], state.data.settings);
  });
  state.currentStudent = state.data.students[0];

  renderStudentSelect();
  renderTabs();
  renderPanel();
  refreshKPIs();
  bindGlobalButtons();
}

function renderStudentSelect(){
  const sel = document.getElementById("studentSelect");
  sel.innerHTML = "";
  state.data.students.forEach((n)=>{
    const opt = document.createElement("option");
    opt.value = n; opt.textContent = n;
    sel.appendChild(opt);
  });
  sel.value = state.currentStudent;
  document.getElementById("currentName").textContent = state.currentStudent;

  sel.onchange = ()=>{
    state.currentStudent = sel.value;
    document.getElementById("currentName").textContent = state.currentStudent;
    renderPanel();
    refreshKPIs();
  };

  document.getElementById("btnAddStudent").onclick = ()=>{
    const name = (document.getElementById("newStudentName").value || "").trim();
    if(!name) return alert("児童名を入力してください。");
    if(state.data.students.includes(name)) return alert("同名の児童がすでにいます。");
    state.data.students.push(name);
    state.data.byStudent[name] = emptyRecord();
    migrateStudentRecord(state.data.byStudent[name], state.data.settings);
    state.currentStudent = name;
    document.getElementById("newStudentName").value = "";
    saveData();
    renderStudentSelect();
    renderPanel();
    refreshKPIs();
  };
}

function renderTabs(){
  const el = document.getElementById("tabs");
  el.innerHTML = "";
  tabs.forEach(t=>{
    const b = document.createElement("button");
    b.className = "tab" + (state.currentTab===t.id ? " active":"");
    b.textContent = t.label;
    b.onclick = ()=>{
      state.currentTab = t.id;
      renderTabs();
      renderPanel();
    };
    el.appendChild(b);
  });
}

function refreshKPIs(){
  const rec = state.data.byStudent[state.currentStudent];
  const sStar = computeStarSuggest(rec);
  const sBio = computeBioSuggest(rec);
  const sWater = computeWaterSuggest(rec);
  const sPres = computePresSuggest(rec);

  document.getElementById("kStar").textContent =
    `知A:${(rec.star.ksA.obsCount==="4+"? "★":"")}${sStar.ksA.grade} / 知B:${sStar.ksB.grade} / 思A:${sStar.thA.grade} / 思B:${sStar.thB.grade}`;

  document.getElementById("kBio").textContent =
    `知A:${sBio.ksA.grade} / 知B:${sBio.ksB.grade} / 思A:${(sBio.thA.adv?"★":"")}${sBio.thA.grade} / 思B:${(sBio.thB.adv?"★":"")}${sBio.thB.grade} / 主体:${sBio.attitude.grade||"-"}`;

  document.getElementById("kWater").textContent =
    `蒸発(知A:${sWater.evap.ksA.grade},知B:${sWater.evap.ksB.grade},思:${sWater.evap.th.grade})・結露(知A:${sWater.cond.ksA.grade},知B:${sWater.cond.ksB.grade},思:${sWater.cond.th.grade})・主体:${sWater.attitude.grade||"-"}`;

  document.getElementById("kPres").textContent = `主体:${sPres.attitude.grade || "-"}`;
  saveData();
}

function bindGlobalButtons(){
  document.getElementById("btnReset").onclick = ()=>{
    if(!confirm("本当に全データを削除しますか？（元に戻せません）")) return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  };

  document.getElementById("btnExport").onclick = ()=>{
    const blob = new Blob([JSON.stringify(state.data,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "rika4_eval_backup.json";
    a.click();
    URL.revokeObjectURL(url);
  };

  document.getElementById("btnImport").onclick = async ()=>{
    const inp = document.createElement("input");
    inp.type="file"; inp.accept="application/json";
    inp.onchange = ()=>{
      const f = inp.files?.[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const d = JSON.parse(String(r.result||""));
          if(!d.students || !d.byStudent) throw new Error("形式が違います");
          d.settings = d.settings || structuredClone(defaultSettings);
          ensureSettingsShape(d.settings);
          d.byStudent = d.byStudent || {};
          d.students.forEach(n=>{
            if(!d.byStudent[n]) d.byStudent[n]=emptyRecord();
            migrateStudentRecord(d.byStudent[n], d.settings);
          });
          state.data = d;
          state.currentStudent = state.data.students[0] || "";
          saveData();
          renderStudentSelect();
          renderTabs();
          renderPanel();
          refreshKPIs();
        }catch(e){
          alert("インポートに失敗しました： " + e.message);
        }
      };
      r.readAsText(f);
    };
    inp.click();
  };
}

function renderPanel(){
  const rec = state.data.byStudent[state.currentStudent];
  const panel = document.getElementById("panel");
  panel.innerHTML = "";

  if(state.currentTab==="progress"){
    panel.appendChild(renderProgressAndDeliverables(rec));
  } else if(state.currentTab==="overview"){
    panel.appendChild(renderOverview());
  } else if(state.currentTab==="star"){
    panel.appendChild(renderStar(rec));
  } else if(state.currentTab==="bio"){
    panel.appendChild(renderBio(rec));
  } else if(state.currentTab==="water"){
    panel.appendChild(renderWater(rec));
  } else if(state.currentTab==="pres"){
    panel.appendChild(renderPres(rec));
  }
}

/** UI parts */
function labelRow(title, right){
  const d = document.createElement("div");
  d.className="sec-title";
  const h = document.createElement("h2");
  h.textContent = title;
  const r = document.createElement("div");
  r.className="hint";
  if(right) r.innerHTML = right;
  d.appendChild(h); d.appendChild(r);
  return d;
}
function gradeSelect(value, onChange){
  const sel = document.createElement("select");
  ["","A","B+","B","B-","C"].forEach(v=>{
    const o = document.createElement("option");
    o.value=v; o.textContent = v==="" ? "（自動）" : v;
    sel.appendChild(o);
  });
  sel.value = value || "";
  sel.onchange = ()=> onChange(sel.value);
  return sel;
}
function checkItem(path, text, rec){
  const wrap = document.createElement("label");
  wrap.className="chk";
  const input = document.createElement("input");
  input.type="checkbox";
  const parts = path.split(".");
  let cur = rec;
  for(const p of parts) cur = cur[p];
  input.checked = !!cur;
  input.onchange = ()=>{
    setDeep(rec, path, input.checked);
    refreshKPIs();
    renderPanel();
  };
  const span = document.createElement("div");
  span.innerHTML = `<div>${text}</div>`;
  wrap.appendChild(input); wrap.appendChild(span);
  return wrap;
}
function numberInput(path, rec, min=0, max=5){
  const input = document.createElement("input");
  input.type="number"; input.min=min; input.max=max; input.step="1";
  const parts = path.split(".");
  let cur = rec;
  for(const p of parts) cur = cur[p];
  input.value = cur ?? 0;
  input.oninput = ()=>{
    let v = parseInt(input.value||"0",10);
    if(Number.isNaN(v)) v=0;
    v = Math.max(min, Math.min(max, v));
    setDeep(rec, path, v);
    refreshKPIs();
    renderPanel();
  };
  return input;
}
function unitSelect(value, onChange){
  const sel = document.createElement("select");
  UNITS.filter(u=>u.id!=="all").forEach(u=>{
    const o=document.createElement("option"); o.value=u.id; o.textContent=u.label; sel.appendChild(o);
  });
  sel.value = value || "other";
  sel.onchange = ()=> onChange(sel.value);
  return sel;
}

/** ===== progress/deliverables (個人) ===== */
function renderProgressAndDeliverables(rec){
  const box = document.createElement("div");
  box.appendChild(labelRow("進捗確認（授業枠）／提出物リスト（編集可）", ""));
  const setCard = document.createElement("div");
  setCard.className="card";
  const info = document.createElement("div");
  info.className="note";
  info.innerHTML = `・授業枠/提出物は編集できます（単元の色分けと一覧のフィルタに使います）。`;
  setCard.appendChild(info);

  const two = document.createElement("div"); two.className="two";

  // sessions editor
  const ses = document.createElement("div"); ses.className="card";
  ses.appendChild(labelRow("授業枠（編集）", `<span class="small">単元（色分け）も指定</span>`));
  const sesTbl = document.createElement("table"); sesTbl.className="table";
  state.data.settings.sessions.forEach((s)=>{
    const tr = document.createElement("tr");

    const td1 = document.createElement("td"); td1.className="w-170";
    td1.innerHTML = `<div class="mono">${s.id}</div>`;

    const td2 = document.createElement("td");
    const label = document.createElement("input");
    label.value = s.label;
    label.oninput = ()=>{ s.label = label.value; saveData(); };
    td2.appendChild(label);

    const td3 = document.createElement("td"); td3.className="w-140";
    const type = document.createElement("select");
    [["whole","一斉"],["free","自由"],["test","テスト"]].forEach(([v,t])=>{
      const o=document.createElement("option"); o.value=v; o.textContent=t; type.appendChild(o);
    });
    type.value = s.type;
    type.onchange = ()=>{ s.type = type.value; if(!s.unit) s.unit="other"; saveData(); renderPanel(); };
    td3.appendChild(type);

    const td4 = document.createElement("td"); td4.className="w-170";
    const uSel = unitSelect(s.unit, (v)=>{ s.unit=v; saveData(); renderPanel(); });
    td4.appendChild(uSel);

    const td5 = document.createElement("td"); td5.className="w-110";
    const del = document.createElement("button");
    del.className="btn danger"; del.textContent="削除";
    del.onclick = ()=>{
      if(!confirm(`「${s.label}」を削除しますか？`)) return;
      state.data.settings.sessions = state.data.settings.sessions.filter(x=>x.id!==s.id);
      saveData();
      renderPanel();
    };
    td5.appendChild(del);

    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5);
    sesTbl.appendChild(tr);
  });
  ses.appendChild(sesTbl);

  // add session
  const addRow = document.createElement("div"); addRow.className="row";
  const newId = document.createElement("input"); newId.placeholder="ID（例：L13）"; newId.className="w-140";
  const newLabel = document.createElement("input"); newLabel.placeholder="表示名（例：第13時）"; newLabel.className="grow";
  const newType = document.createElement("select");
  [["whole","一斉"],["free","自由"],["test","テスト"]].forEach(([v,t])=>{
    const o=document.createElement("option"); o.value=v; o.textContent=t; newType.appendChild(o);
  });
  const newUnit = unitSelect("other", ()=>{});
  const addBtn = document.createElement("button"); addBtn.className="btn primary"; addBtn.textContent="授業枠を追加";
  addBtn.onclick = ()=>{
    const id = (newId.value||"").trim();
    const label = (newLabel.value||"").trim();
    const type = newType.value;
    const unit = newUnit.value;
    if(!id || !label) return alert("IDと表示名を入力してください。");
    if(state.data.settings.sessions.some(x=>x.id===id)) return alert("同じIDが既にあります。");
    state.data.settings.sessions.push({id, label, type, unit});
    state.data.students.forEach(n=>{
      const r = state.data.byStudent[n];
      r.progress.bySession[id] = {status:"未", plan:"", done:"", note:""};
    });
    newId.value=""; newLabel.value="";
    saveData();
    renderPanel();
  };
  addRow.appendChild(newId); addRow.appendChild(newLabel); addRow.appendChild(newType); addRow.appendChild(newUnit); addRow.appendChild(addBtn);
  ses.appendChild(addRow);

  // deliverables editor
  const deliv = document.createElement("div"); deliv.className="card";
  deliv.appendChild(labelRow("提出物リスト（編集）", `<span class="small">単元（色分け）も指定</span>`));
  const dTbl = document.createElement("table"); dTbl.className="table";
  state.data.settings.deliverables.forEach((d)=>{
    const tr = document.createElement("tr");

    const td1 = document.createElement("td"); td1.className="w-170";
    td1.innerHTML = `<div class="mono">${d.id}</div>`;

    const td2 = document.createElement("td");
    const label = document.createElement("input");
    label.value = d.label;
    label.oninput = ()=>{ d.label = label.value; saveData(); };
    td2.appendChild(label);

    const td3 = document.createElement("td"); td3.className="w-170";
    const uSel = unitSelect(d.unit, (v)=>{ d.unit=v; saveData(); renderPanel(); });
    td3.appendChild(uSel);

    const td4 = document.createElement("td"); td4.className="w-110";
    const del = document.createElement("button");
    del.className="btn danger"; del.textContent="削除";
    del.onclick = ()=>{
      if(!confirm(`提出物「${d.label}」を削除しますか？`)) return;
      state.data.settings.deliverables = state.data.settings.deliverables.filter(x=>x.id!==d.id);
      saveData();
      renderPanel();
    };
    td4.appendChild(del);

    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4);
    dTbl.appendChild(tr);
  });
  deliv.appendChild(dTbl);

  const addRow2 = document.createElement("div"); addRow2.className="row";
  const newDid = document.createElement("input"); newDid.placeholder="ID（例：D7）"; newDid.className="w-140";
  const newDLabel = document.createElement("input"); newDLabel.placeholder="提出物名（例：発表スライド）"; newDLabel.className="grow";
  const newDUnit = unitSelect("other", ()=>{});
  const addBtn2 = document.createElement("button"); addBtn2.className="btn primary"; addBtn2.textContent="提出物を追加";
  addBtn2.onclick = ()=>{
    const id = (newDid.value||"").trim();
    const label = (newDLabel.value||"").trim();
    const unit = newDUnit.value;
    if(!id || !label) return alert("IDと提出物名を入力してください。");
    if(state.data.settings.deliverables.some(x=>x.id===id)) return alert("同じIDが既にあります。");
    state.data.settings.deliverables.push({id, label, unit});
    state.data.students.forEach(n=>{
      const r = state.data.byStudent[n];
      r.deliverables.byId[id] = {submitted:false, date:"", note:""};
    });
    newDid.value=""; newDLabel.value="";
    saveData();
    renderPanel();
  };
  addRow2.appendChild(newDid); addRow2.appendChild(newDLabel); addRow2.appendChild(newDUnit); addRow2.appendChild(addBtn2);
  deliv.appendChild(addRow2);

  two.appendChild(ses);
  two.appendChild(deliv);
  setCard.appendChild(two);
  box.appendChild(setCard);

  // individual progress
  box.appendChild(labelRow("12時間の進捗（児童の計画つき）", `<b>${state.currentStudent}</b>`));
  const pCard = document.createElement("div"); pCard.className="card";
  const pTbl = document.createElement("table"); pTbl.className="table";
  const statuses = ["未","途中","完了","欠"];

  state.data.settings.sessions.forEach(s=>{
    const tr = document.createElement("tr");
    const td1 = document.createElement("td"); td1.className="w-170";
    td1.innerHTML = `<div><b>${s.label}</b></div>
      <div class="small">種別：${s.type==="whole"?"一斉":(s.type==="free"?"自由":"テスト")} ／ 単元：${unitLabel(s.unit)}</div>`;

    const td2 = document.createElement("td");
    const row = document.createElement("div"); row.className="row";
    const stSel = document.createElement("select"); stSel.className="w-140";
    statuses.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; stSel.appendChild(o); });
    stSel.value = rec.progress.bySession[s.id]?.status || "未";
    stSel.onchange = ()=>{ rec.progress.bySession[s.id].status = stSel.value; saveData(); };
    row.appendChild(document.createTextNode("状態："));
    row.appendChild(stSel);
    td2.appendChild(row);

    const plan = document.createElement("textarea");
    plan.placeholder = (s.type==="free") ? "児童の計画（この時間にやること）" : "（任意）この時間のメモ";
    plan.value = rec.progress.bySession[s.id]?.plan || "";
    plan.oninput = ()=>{ rec.progress.bySession[s.id].plan = plan.value; saveData(); };

    const done = document.createElement("textarea");
    done.placeholder = (s.type==="free") ? "実績メモ（やったこと・次へ）" : "実績メモ";
    done.value = rec.progress.bySession[s.id]?.done || "";
    done.oninput = ()=>{ rec.progress.bySession[s.id].done = done.value; saveData(); };

    const note = document.createElement("input");
    note.placeholder = "教師メモ（支援・声かけ等）";
    note.value = rec.progress.bySession[s.id]?.note || "";
    note.oninput = ()=>{ rec.progress.bySession[s.id].note = note.value; saveData(); };

    td2.appendChild(plan);
    td2.appendChild(done);
    td2.appendChild(note);

    tr.appendChild(td1); tr.appendChild(td2);
    pTbl.appendChild(tr);
  });
  pCard.appendChild(pTbl);
  box.appendChild(pCard);

  // individual deliverables
  box.appendChild(labelRow("提出物確認（児童別）", `<b>${state.currentStudent}</b>`));
  const dCard = document.createElement("div"); dCard.className="card";
  const dTbl2 = document.createElement("table"); dTbl2.className="table";

  state.data.settings.deliverables.forEach(d=>{
    const tr = document.createElement("tr");
    const td1 = document.createElement("td"); td1.className="w-170";
    td1.innerHTML = `<b>${d.label}</b>
      <div class="small mono">${d.id}</div>
      <div class="small">単元：${unitLabel(d.unit)}</div>`;

    const td2 = document.createElement("td");
    const row = document.createElement("div"); row.className="row";

    const chk = document.createElement("input"); chk.type="checkbox";
    chk.checked = !!rec.deliverables.byId[d.id]?.submitted;
    chk.onchange = ()=>{ rec.deliverables.byId[d.id].submitted = chk.checked; saveData(); };
    row.appendChild(chk);
    row.appendChild(document.createTextNode("提出"));

    const date = document.createElement("input"); date.placeholder="提出日（任意）";
    date.value = rec.deliverables.byId[d.id]?.date || "";
    date.oninput = ()=>{ rec.deliverables.byId[d.id].date = date.value; saveData(); };

    const note = document.createElement("input"); note.placeholder="メモ（再提出/未完など）";
    note.value = rec.deliverables.byId[d.id]?.note || "";
    note.oninput = ()=>{ rec.deliverables.byId[d.id].note = note.value; saveData(); };

    row.appendChild(date);
    row.appendChild(note);

    td2.appendChild(row);

    tr.appendChild(td1); tr.appendChild(td2);
    dTbl2.appendChild(tr);
  });

  dCard.appendChild(dTbl2);
  box.appendChild(dCard);

  return box;
}

/** ===== overview (クラス) + フィルタ + CSV ===== */
function renderOverview(){
  const box = document.createElement("div");

  // filter + csv controls
  const controls = document.createElement("div"); controls.className="card";
  controls.appendChild(labelRow("一覧コントロール", `<span class="small">単元で絞り込み／CSV出力（Excelに貼り付けOK）</span>`));
  const row = document.createElement("div"); row.className="row";

  const filterSel = document.createElement("select");
  UNITS.forEach(u=>{
    const o=document.createElement("option"); o.value=u.id; o.textContent=u.label; filterSel.appendChild(o);
  });
  filterSel.value = state.overviewFilterUnit || "all";
  filterSel.onchange = ()=>{
    state.overviewFilterUnit = filterSel.value;
    renderPanel();
  };

  const btnP = document.createElement("button");
  btnP.className="btn";
  btnP.textContent = "進捗CSV出力";
  btnP.onclick = ()=> exportProgressCSV(state.overviewFilterUnit);

  const btnD = document.createElement("button");
  btnD.className="btn";
  btnD.textContent = "提出物CSV出力";
  btnD.onclick = ()=> exportDeliverablesCSV(state.overviewFilterUnit);

  row.appendChild(document.createTextNode("単元フィルタ："));
  row.appendChild(filterSel);
  row.appendChild(btnP);
  row.appendChild(btnD);
  controls.appendChild(row);

  const n = document.createElement("div"); n.className="note";
  n.innerHTML = `※ フィルタ「（全て）」のまま出力すると全列を出します。`;
  controls.appendChild(n);
  box.appendChild(controls);

  // summary + tables
  box.appendChild(labelRow("単元別 集計（クラス全体）", `<span class="small">※フィルタが全て以外の時は該当単元のみ表示</span>`));
  const sumCard = document.createElement("div"); sumCard.className="card";
  sumCard.appendChild(buildUnitSummaryCards(state.overviewFilterUnit));
  box.appendChild(sumCard);

  box.appendChild(labelRow("進捗一覧（全員×授業枠）", `<span class="small">横スクロールできます／セルタップで状態切替</span>`));
  const prog = document.createElement("div"); prog.className="card";
  prog.appendChild(buildProgressOverviewTable(state.overviewFilterUnit));
  box.appendChild(prog);

  box.appendChild(labelRow("提出物一覧（全員×提出物）", `<span class="small">横スクロールできます／セルタップで提出切替</span>`));
  const del = document.createElement("div"); del.className="card";
  del.appendChild(buildDeliverablesOverviewTable(state.overviewFilterUnit));
  box.appendChild(del);

  return box;
}

function buildUnitSummaryCards(filterUnit){
  const wrap = document.createElement("div"); wrap.className="two";

  const sessions = state.data.settings.sessions;
  const dels = state.data.settings.deliverables;
  const students = state.data.students;

  function unitStats(unitId){
    const sesIn = sessions.filter(s=>s.unit===unitId);
    const delIn = dels.filter(d=>d.unit===unitId);

    let totalSesCells = 0, doneSesCells = 0, absentCells=0;
    students.forEach(st=>{
      const r = state.data.byStudent[st];
      sesIn.forEach(s=>{
        const stt = r.progress.bySession[s.id]?.status || "未";
        totalSesCells += 1;
        if(stt==="完了") doneSesCells += 1;
        if(stt==="欠") absentCells += 1;
      });
    });

    let totalDelCells = 0, submittedDelCells = 0;
    students.forEach(st=>{
      const r = state.data.byStudent[st];
      delIn.forEach(d=>{
        totalDelCells += 1;
        if(!!r.deliverables.byId[d.id]?.submitted) submittedDelCells += 1;
      });
    });

    const sesRate = totalSesCells ? Math.round(doneSesCells*100/totalSesCells) : 0;
    const delRate = totalDelCells ? Math.round(submittedDelCells*100/totalDelCells) : 0;

    return {sesIn, delIn, totalSesCells, doneSesCells, absentCells, sesRate, totalDelCells, submittedDelCells, delRate};
  }

  const unitList = UNITS.filter(u=>u.id!=="all");
  const target = (filterUnit && filterUnit!=="all")
    ? unitList.filter(u=>u.id===filterUnit)
    : unitList.filter(u=>u.id!=="other");

  target.forEach(u=>{
    const st = unitStats(u.id);
    const c = document.createElement("div"); c.className="card";
    c.classList.add(unitClass(u.id));
    c.innerHTML = `
      <div><span class="dot ${unitDotClass(u.id)}"></span><b>${u.label}</b></div>
      <div class="mini">授業枠：${st.sesIn.length} ／ 提出物：${st.delIn.length}</div>
      <div class="hr"></div>
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="small">進捗 完了率</div>
          <div style="font-size:18px;font-weight:800">${st.sesRate}%</div>
          <div class="mini">完了 ${st.doneSesCells}/${st.totalSesCells}（欠 ${st.absentCells}）</div>
        </div>
        <div>
          <div class="small">提出 提出率</div>
          <div style="font-size:18px;font-weight:800">${st.delRate}%</div>
          <div class="mini">提出 ${st.submittedDelCells}/${st.totalDelCells}</div>
        </div>
      </div>
    `;
    wrap.appendChild(c);
  });

  return wrap;
}

function buildProgressOverviewTable(filterUnit="all"){
  const container = document.createElement("div"); container.className="scrollX";
  const tbl = document.createElement("table"); tbl.className="ovTable";

  const sessions = state.data.settings.sessions.filter(s=> filterUnit==="all" ? true : (s.unit===filterUnit));

  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  const th0 = document.createElement("th"); th0.className="sticky2";
  th0.textContent = "児童";
  trh.appendChild(th0);

  sessions.forEach(s=>{
    const th = document.createElement("th");
    th.innerHTML = `
      <div class="mono">${s.id}</div>
      <div>${s.label}</div>
      <div class="mini"><span class="dot ${unitDotClass(s.unit)}"></span>${unitLabel(s.unit)}</div>
    `;
    th.classList.add(unitClass(s.unit));
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  tbl.appendChild(thead);

  const tbody = document.createElement("tbody");
  state.data.students.forEach(stName=>{
    const r = state.data.byStudent[stName];
    const tr = document.createElement("tr");

    const td0 = document.createElement("td"); td0.className="sticky";
    td0.innerHTML = `<b>${stName}</b><div class="mini">タップで個人へ</div>`;
    td0.onclick = ()=>{
      state.currentStudent = stName;
      document.getElementById("studentSelect").value = stName;
      document.getElementById("currentName").textContent = stName;
      refreshKPIs();
      state.currentTab = "progress";
      renderTabs();
      renderPanel();
    };
    tr.appendChild(td0);

    sessions.forEach(s=>{
      const td = document.createElement("td");
      td.classList.add(unitClass(s.unit));
      const stt = r.progress.bySession[s.id]?.status || "未";
      const cell = document.createElement("div");
      cell.className = `cell st-${stt}`;
      const plan = (r.progress.bySession[s.id]?.plan || "").trim();
      const done = (r.progress.bySession[s.id]?.done || "").trim();
      cell.innerHTML = `<b>${stt}</b>` +
        (plan ? `<div class="mini">計画：${escapeHtml(plan).slice(0,30)}${plan.length>30?"…":""}</div>` : ``) +
        (done ? `<div class="mini">実績：${escapeHtml(done).slice(0,30)}${done.length>30?"…":""}</div>` : ``);

      td.onclick = ()=>{
        const order = ["未","途中","完了","欠"];
        const cur = r.progress.bySession[s.id].status || "未";
        const idx = order.indexOf(cur);
        r.progress.bySession[s.id].status = order[(idx+1)%order.length];
        saveData();
        renderPanel();
      };

      td.appendChild(cell);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);

  container.appendChild(tbl);

  const wrap = document.createElement("div");
  wrap.appendChild(container);
  const note = document.createElement("div"); note.className="note";
  note.innerHTML = `セルタップ：未→途中→完了→欠。計画/実績/メモの詳細は「個人」タブで。`;
  wrap.appendChild(document.createElement("div")).className="hr";
  wrap.appendChild(note);
  return wrap;
}

function buildDeliverablesOverviewTable(filterUnit="all"){
  const container = document.createElement("div"); container.className="scrollX";
  const tbl = document.createElement("table"); tbl.className="ovTable";

  const dels = state.data.settings.deliverables.filter(d=> filterUnit==="all" ? true : (d.unit===filterUnit));

  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  const th0 = document.createElement("th"); th0.className="sticky2";
  th0.textContent = "児童";
  trh.appendChild(th0);

  dels.forEach(d=>{
    const th = document.createElement("th");
    th.innerHTML = `
      <div class="mono">${d.id}</div>
      <div>${d.label}</div>
      <div class="mini"><span class="dot ${unitDotClass(d.unit)}"></span>${unitLabel(d.unit)}</div>
    `;
    th.classList.add(unitClass(d.unit));
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  tbl.appendChild(thead);

  const tbody = document.createElement("tbody");
  state.data.students.forEach(stName=>{
    const r = state.data.byStudent[stName];
    const tr = document.createElement("tr");

    const td0 = document.createElement("td"); td0.className="sticky";
    td0.innerHTML = `<b>${stName}</b><div class="mini">タップで個人へ</div>`;
    td0.onclick = ()=>{
      state.currentStudent = stName;
      document.getElementById("studentSelect").value = stName;
      document.getElementById("currentName").textContent = stName;
      refreshKPIs();
      state.currentTab = "progress";
      renderTabs();
      renderPanel();
    };
    tr.appendChild(td0);

    dels.forEach(d=>{
      const td = document.createElement("td");
      td.classList.add(unitClass(d.unit));
      const sub = !!r.deliverables.byId[d.id]?.submitted;
      const date = (r.deliverables.byId[d.id]?.date || "").trim();
      const note = (r.deliverables.byId[d.id]?.note || "").trim();

      const cell = document.createElement("div");
      cell.className = `cell ${sub ? "st-完了" : "st-未"}`;
      cell.innerHTML = `<b>${sub ? "提出" : "未提出"}</b>` +
        (date ? `<div class="mini">日：${escapeHtml(date)}</div>` : ``) +
        (note ? `<div class="mini">メモ：${escapeHtml(note).slice(0,28)}${note.length>28?"…":""}</div>` : ``);

      td.onclick = ()=>{
        r.deliverables.byId[d.id].submitted = !r.deliverables.byId[d.id].submitted;
        saveData();
        renderPanel();
      };

      td.appendChild(cell);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);

  container.appendChild(tbl);

  const wrap = document.createElement("div");
  wrap.appendChild(container);
  const note = document.createElement("div"); note.className="note";
  note.innerHTML = `セルタップ：提出/未提出。提出日・メモは「個人」タブで。`;
  wrap.appendChild(document.createElement("div")).className="hr";
  wrap.appendChild(note);
  return wrap;
}

/** ===== ここから下：評価タブ（星/生き物/水/発表） =====
 *  ※ 前回版と同じ構造。必要な分だけ載せています（動作に必要なものは全部入っています）。
 */
function renderStar(rec){
  const s = computeStarSuggest(rec);
  const box = document.createElement("div");

  box.appendChild(labelRow("冬の星｜知識・技能A（書き方）", `提案：<b>${s.ksA.grade}</b>（${s.ksA.score}/5）`));
  const a = document.createElement("div"); a.className="card";
  a.appendChild(checkItem("star.ksA.c1","観察条件（日付・時刻・場所など）が分かる", rec));
  a.appendChild(checkItem("star.ksA.c2","見たこと中心で書いている（想像と区別）", rec));
  a.appendChild(checkItem("star.ksA.c3","観察時刻ごとに分けて記録している", rec));
  a.appendChild(checkItem("star.ksA.c4","丁寧に書こうとしている（途中放棄なし）", rec));
  const row = document.createElement("div"); row.className="row";
  const sel = document.createElement("select");
  [["1","1回"],["2-3","2〜3回"],["4+","4回以上（+1・上限5）"]].forEach(([v,t])=>{
    const o=document.createElement("option"); o.value=v; o.textContent=t; sel.appendChild(o);
  });
  sel.value = rec.star.ksA.obsCount;
  sel.onchange=()=>{ rec.star.ksA.obsCount=sel.value; refreshKPIs(); renderPanel(); };
  row.appendChild(document.createTextNode("観察回数："));
  row.appendChild(sel);
  a.appendChild(row);
  box.appendChild(a);

  box.appendChild(labelRow("冬の星｜知識・技能B（技能）", `提案：<b>${s.ksB.grade}</b>（${s.ksB.score}/5）`));
  const b = document.createElement("div"); b.className="card";
  b.appendChild(checkItem("star.ksB.c1","三つ星が一直線状に捉えられている", rec));
  b.appendChild(checkItem("star.ksB.c2","三つ星＋周囲の星の位置関係が分かる", rec));
  b.appendChild(checkItem("star.ksB.c3","オリオン座全体の形が分かる", rec));
  b.appendChild(checkItem("star.ksB.c4","星同士の位置関係が大きく崩れていない", rec));
  b.appendChild(checkItem("star.ksB.c5","観察結果にもとづいて描いている（写しではない）", rec));
  box.appendChild(b);

  box.appendChild(labelRow("冬の星｜思考A（予想）", `提案：<b>${s.thA.grade}</b>（${s.thA.score}/5）`));
  const thA = document.createElement("div"); thA.className="card";
  const r1 = document.createElement("div"); r1.className="row";
  r1.appendChild(document.createTextNode("点数："));
  r1.appendChild(numberInput("star.thA.score", rec, 0, 5));
  thA.appendChild(r1);
  box.appendChild(thA);

  box.appendChild(labelRow("冬の星｜思考B（考察）", `提案：<b>${s.thB.grade}</b>（${s.thB.score}/5）`));
  const thB = document.createElement("div"); thB.className="card";
  const r2 = document.createElement("div"); r2.className="row";
  r2.appendChild(document.createTextNode("点数："));
  r2.appendChild(numberInput("star.thB.score", rec, 0, 5));
  thB.appendChild(r2);
  box.appendChild(thB);

  box.appendChild(labelRow("冬の星｜主体（授業態度）", ""));
  const att = document.createElement("div"); att.className="card";
  att.innerHTML = `<div class="note">※冬の星の主体は授業中の態度で手動評価。</div>`;
  const row3 = document.createElement("div"); row3.className="row";
  row3.appendChild(document.createTextNode("最終評価："));
  row3.appendChild(gradeSelect(rec.star.attitude.final, (v)=>{ rec.star.attitude.final=v; refreshKPIs(); }));
  att.appendChild(row3);
  box.appendChild(att);

  return box;
}
function renderBio(rec){
  const s = computeBioSuggest(rec);
  const box = document.createElement("div");
  box.appendChild(labelRow("生き物（まとめ）｜知識・技能A（観察カード）", `提案：<b>${s.ksA.grade}</b>（${s.ksA.score}/5）`));
  const a = document.createElement("div"); a.className="card";
  a.appendChild(checkItem("bio.ksA.c1","観察条件（日付・季節・場所）が分かる", rec));
  a.appendChild(checkItem("bio.ksA.c2","見たこと中心（想像や感想と区別）", rec));
  a.appendChild(checkItem("bio.ksA.c3","継続して記録している（複数時期）", rec));
  a.appendChild(checkItem("bio.ksA.c4","丁寧に書こうとしている", rec));
  box.appendChild(a);

  box.appendChild(labelRow("主体（提出物中心）", `提案：<b>${s.attitude.grade || "-"}</b>`));
  const att = document.createElement("div"); att.className="card";
  att.appendChild(checkItem("bio.attitude.checks.c1","提出物を完成させている", rec));
  att.appendChild(checkItem("bio.attitude.checks.c2","対象を自分で選んで取り組んでいる", rec));
  att.appendChild(checkItem("bio.attitude.checks.c3","修正・付け足しの跡がある", rec));
  att.appendChild(checkItem("bio.attitude.checks.c4","図や写真を活用しようとしている", rec));
  att.appendChild(checkItem("bio.attitude.checks.c5","最後までやり切っている", rec));
  const rowF = document.createElement("div"); rowF.className="row";
  rowF.appendChild(document.createTextNode("最終評価："));
  rowF.appendChild(gradeSelect(rec.bio.attitude.final, (v)=>{ rec.bio.attitude.final=v; refreshKPIs(); }));
  att.appendChild(rowF);
  box.appendChild(att);
  return box;
}
function renderWater(rec){
  const s = computeWaterSuggest(rec);
  const box = document.createElement("div");
  box.appendChild(labelRow("水のゆくえ｜主体（安全含む）", `提案：<b>${s.attitude.grade || "-"}</b>`));
  const att = document.createElement("div"); att.className="card";
  att.appendChild(checkItem("water.attitude.checks.c1","記録しようとしている", rec));
  att.appendChild(checkItem("water.attitude.checks.c2","その場で書こうとしている", rec));
  att.appendChild(checkItem("water.attitude.checks.c3","安全に配慮している", rec));
  att.appendChild(checkItem("water.attitude.checks.c4","役割を意識して行動", rec));
  att.appendChild(checkItem("water.attitude.checks.c5","片付けまでやり切る", rec));
  const severeRow = document.createElement("label"); severeRow.className="chk";
  const severe = document.createElement("input"); severe.type="checkbox"; severe.checked=!!rec.water.attitude.severe;
  severe.onchange=()=>{ rec.water.attitude.severe=severe.checked; refreshKPIs(); renderPanel(); };
  severeRow.appendChild(severe);
  severeRow.appendChild(document.createElement("div"));
  severeRow.lastChild.innerHTML = `<div><b>重大な安全違反（C固定）</b></div>`;
  att.appendChild(severeRow);
  const rowF = document.createElement("div"); rowF.className="row";
  rowF.appendChild(document.createTextNode("最終評価："));
  rowF.appendChild(gradeSelect(rec.water.attitude.final, (v)=>{ rec.water.attitude.final=v; refreshKPIs(); }));
  att.appendChild(rowF);
  box.appendChild(att);
  return box;
}
function renderPres(rec){
  const s = computePresSuggest(rec);
  const box = document.createElement("div");
  box.appendChild(labelRow("発表会｜主体のみ", `提案：<b>${s.attitude.grade || "-"}</b>`));
  const att = document.createElement("div"); att.className="card";
  att.appendChild(checkItem("pres.attitude.checks.c1","発表準備に関わっている", rec));
  att.appendChild(checkItem("pres.attitude.checks.c2","自分の役割を果たそうとしている", rec));
  att.appendChild(checkItem("pres.attitude.checks.c3","前向きに参加している", rec));
  att.appendChild(checkItem("pres.attitude.checks.c4","仲間と協力している", rec));
  att.appendChild(checkItem("pres.attitude.checks.c5","最後までやり切っている", rec));
  const rowF = document.createElement("div"); rowF.className="row";
  rowF.appendChild(document.createTextNode("最終評価："));
  rowF.appendChild(gradeSelect(rec.pres.attitude.final, (v)=>{ rec.pres.attitude.final=v; refreshKPIs(); }));
  att.appendChild(rowF);
  box.appendChild(att);
  return box;
}

init();
</script>
</body>
</html>
