<!-- ===== Part1/5 START ===== -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>4å¹´ç†ç§‘ è©•ä¾¡è¨˜éŒ²ãƒ„ãƒ¼ãƒ«ï¼ˆå†¬ãƒ—ãƒ­ï¼‰</title>

  <style>
    :root{
      --bg:#0b0c10; --card:#12141a; --card2:#161a22; --text:#e8eef7; --muted:#a9b3c2;
      --line:#232a36; --accent:#59a8ff; --good:#4ade80; --bad:#fb7185; --warn:#fbbf24;
      --chip:#1c2330; --btn:#1f2a3a;
      --s-miss: rgba(251,113,133,.18);
      --s-todo: rgba(251,191,36,.14);
      --s-doing: rgba(89,168,255,.16);
      --s-done: rgba(74,222,128,.14);
      --u-star: rgba(89,168,255,.14);
      --u-bio: rgba(74,222,128,.12);
      --u-water: rgba(251,191,36,.12);
      --u-pres: rgba(168,85,247,.14);
      --u-test: rgba(251,113,133,.12);
      --u-other: rgba(255,255,255,.05);
    }

    /* ===== Light mode ===== */
    html[data-theme="light"]{
      --bg:#f6f7fb; --card:#ffffff; --card2:#ffffff; --text:#0b1220; --muted:#536074;
      --line:#d7deea; --accent:#1b6dff; --chip:#f0f3f9; --btn:#f6f7fb;
      --s-miss: rgba(225,29,72,.12);
      --s-todo: rgba(245,158,11,.14);
      --s-doing: rgba(29,78,216,.12);
      --s-done: rgba(16,185,129,.12);
      --u-star: rgba(29,78,216,.08);
      --u-bio: rgba(16,185,129,.08);
      --u-water: rgba(245,158,11,.08);
      --u-pres: rgba(168,85,247,.08);
      --u-test: rgba(225,29,72,.07);
      --u-other: rgba(2,6,23,.04);
    }

    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg) 40%,color-mix(in srgb, var(--bg) 92%, #000 8%));color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;z-index:50;background:color-mix(in srgb, var(--bg) 92%, rgba(0,0,0,.25) 8%);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1250px;margin:0 auto;padding:14px 14px 22px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    h1{font-size:16px;margin:0 0 6px 0;letter-spacing:.02em}
    .sub{font-size:12px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .card.soft{background:var(--card2)}
    .grow{flex:1}
    .btn{background:var(--btn);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:12px;font-size:13px;cursor:pointer}
    .btn:hover{border-color:color-mix(in srgb, var(--line) 30%, var(--text) 70%)}
    .btn.primary{background:linear-gradient(180deg,#2a63ff,#1f49ff);border-color:#2a63ff;color:#fff}
    .btn.danger{background:linear-gradient(180deg,#ff3b66,#e11d48);border-color:#ff3b66;color:#fff}
    .btn.ghost{background:transparent}
    input,select,textarea{background:color-mix(in srgb, var(--bg) 60%, #000 40%);border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px;font-size:13px}
    html[data-theme="light"] input,html[data-theme="light"] select,html[data-theme="light"] textarea{background:#fff}
    textarea{min-height:70px;resize:vertical}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:transparent;color:var(--text);cursor:pointer;font-size:13px}
    .tab.active{background:var(--chip);border-color:color-mix(in srgb, var(--line) 50%, var(--text) 50%)}
    .grid{display:grid;gap:12px}
    @media (min-width: 920px){ .grid{grid-template-columns: 340px 1fr} }
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .k{padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:color-mix(in srgb, var(--bg) 96%, #fff 4%)}
    .k .t{font-size:12px;color:var(--muted)}
    .k .v{font-size:16px;font-weight:700;margin-top:2px;line-height:1.25}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:color-mix(in srgb, var(--bg) 95%, #fff 5%);border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .sec-title{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;margin-bottom:8px}
    .sec-title h2{font-size:14px;margin:0}
    .sec-title .hint{font-size:12px;color:var(--muted)}
    .chk{display:flex;gap:10px;align-items:flex-start;padding:10px;border-radius:12px;border:1px solid var(--line);background:color-mix(in srgb, var(--bg) 90%, #000 10%)}
    html[data-theme="light"] .chk{background:#fff}
    .chk input{margin-top:2px}
    .two{display:grid;gap:12px}
    @media (min-width: 760px){ .two{grid-template-columns: 1fr 1fr} }
    details{border:1px solid var(--line);border-radius:12px;padding:10px;background:color-mix(in srgb, var(--bg) 97%, #fff 3%)}
    summary{cursor:pointer;color:var(--muted);font-size:12px}
    .note{font-size:12px;color:var(--muted);line-height:1.55}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .small{font-size:12px;color:var(--muted)}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table td{padding:10px 10px;background:color-mix(in srgb, var(--bg) 97%, #fff 3%);border-top:1px solid var(--line);border-bottom:1px solid var(--line);vertical-align:top}
    .table td:first-child{border-left:1px solid var(--line);border-radius:12px 0 0 12px}
    .table td:last-child{border-right:1px solid var(--line);border-radius:0 12px 12px 0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .w-110{width:110px}
    .w-140{width:140px}
    .w-170{width:170px}

    .scrollX{overflow:auto;border:1px solid var(--line);border-radius:14px}
    .ovTable{width:max-content; border-collapse:separate; border-spacing:0; min-width:100%}
    .ovTable th,.ovTable td{border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:8px 8px;font-size:12px;vertical-align:top;background:color-mix(in srgb, var(--bg) 97%, #fff 3%)}
    .ovTable th{position:sticky;top:0;z-index:5;background:color-mix(in srgb, var(--card) 92%, rgba(0,0,0,.1) 8%);backdrop-filter:blur(8px);font-weight:700}
    .ovTable .sticky{position:sticky;left:0;z-index:6;background:color-mix(in srgb, var(--card) 92%, rgba(0,0,0,.1) 8%)}
    .ovTable .sticky2{position:sticky;left:0;z-index:7;background:color-mix(in srgb, var(--card) 92%, rgba(0,0,0,.1) 8%);font-weight:800}
    .cell{border-radius:10px;padding:6px 8px;border:1px solid color-mix(in srgb, var(--line) 60%, #fff 40%)}
    .st-æœª{background:var(--s-todo)}
    .st-é€”ä¸­{background:var(--s-doing)}
    .st-å®Œäº†{background:var(--s-done)}
    .st-æ¬ {background:var(--s-miss)}
    .u-star{box-shadow: inset 0 0 0 999px var(--u-star)}
    .u-bio{box-shadow: inset 0 0 0 999px var(--u-bio)}
    .u-water{box-shadow: inset 0 0 0 999px var(--u-water)}
    .u-pres{box-shadow: inset 0 0 0 999px var(--u-pres)}
    .u-test{box-shadow: inset 0 0 0 999px var(--u-test)}
    .u-other{box-shadow: inset 0 0 0 999px var(--u-other)}
    .dot{display:inline-block;width:8px;height:8px;border-radius:999px;margin-right:6px;vertical-align:middle}
    .dot.star{background:#59a8ff}
    .dot.bio{background:#4ade80}
    .dot.water{background:#fbbf24}
    .dot.pres{background:#a855f7}
    .dot.test{background:#fb7185}
    .dot.other{background:#a9b3c2}
    .mini{font-size:11px;color:var(--muted);margin-top:4px}

    /* ===== Photos ===== */
    .thumbs{display:flex;gap:10px;flex-wrap:wrap}
    .thumb{width:120px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:color-mix(in srgb, var(--bg) 95%, #fff 5%)}
    .thumb img{display:block;width:100%;height:86px;object-fit:cover}
    .thumb .meta{padding:8px}
    .thumb .meta .t{font-size:11px;color:var(--muted);line-height:1.2}
    .thumb .meta .b{display:flex;justify-content:space-between;gap:8px;margin-top:6px}
    .thumb button{padding:6px 8px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--text);cursor:pointer;font-size:12px}
    .thumb button:hover{border-color:color-mix(in srgb, var(--line) 30%, var(--text) 70%)}

    /* ===== iPad landscape optimization ===== */
    @media (orientation: landscape) and (min-width: 900px){
      .wrap{max-width: 1400px}
      h1{font-size:18px}
      .grid{grid-template-columns: 420px 1fr}
      .tabs{gap:10px}
      .tab{padding:11px 14px;font-size:14px}
      .btn{font-size:14px;padding:10px 14px}
      input,select,textarea{font-size:14px}
      .table td{padding:12px 12px}
      .ovTable th,.ovTable td{font-size:13px}
      .thumb{width:140px}
      .thumb img{height:96px}
    }
    @media (orientation: landscape) and (min-width: 1100px){
      .grid{grid-template-columns: 460px 1fr}
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>4å¹´ç†ç§‘ è©•ä¾¡è¨˜éŒ²ãƒ„ãƒ¼ãƒ«ï¼ˆå†¬ã®è‡ªç„¶æ¢ç©¶ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰</h1>
        <div class="sub">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ç«¯æœ«å†…ä¿å­˜ï¼ˆlocalStorageï¼‹å†™çœŸã¯IndexedDBï¼‰ãƒ»é€²æ—ï¼†æå‡ºç‰©ï¼†è©•ä¾¡ï¼ˆææ¡ˆï¼‹æ‰‹å‹•èª¿æ•´ï¼‰</div>
      </div>
      <div class="row">
        <button class="btn" id="btnTheme">â˜€ï¸/ğŸŒ™</button>
        <span class="pill" title="ã‚°ãƒ«ãƒ¼ãƒ—æ´»å‹•ã®æ™‚é–“ã§ã€åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—åã®å…ç«¥ã¸ç·¨é›†å†…å®¹ã‚’åæ˜ ã—ã¾ã™">
          <input id="toggleGroupSync" type="checkbox" style="transform:scale(1.05)" />
          ã‚°ãƒ«ãƒ¼ãƒ—åŒæœŸ
        </span>
        <button class="btn" id="btnExport">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ(JSON)</button>
        <button class="btn" id="btnImport">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <button class="btn danger" id="btnReset">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap grid">
  <div class="card">
    <div class="sec-title">
      <h2>åç°¿</h2>
      <span class="hint">å…ç«¥ã‚’é¸ã‚“ã§å…¥åŠ›</span>
    </div>

    <div class="row">
      <select id="studentSelect" class="grow"></select>
      <button class="btn" id="btnAddStudent">è¿½åŠ </button>
      <button class="btn" id="btnRenameStudent">åå‰å¤‰æ›´</button>
    </div>
    <div class="row">
      <input id="newStudentName" class="grow" placeholder="è¿½åŠ ã™ã‚‹å…ç«¥åï¼ˆä¾‹ï¼šå±±ç”° å¤ªéƒï¼‰" />
    </div>

    <div class="hr"></div>

    <div class="sec-title">
      <h2>ç¾åœ¨ã®å…ç«¥ï¼š<span id="currentName"></span></h2>
      <span class="hint">ææ¡ˆè©•ä¾¡ï¼ˆå‚è€ƒï¼‰</span>
    </div>

    <div class="kpi">
      <div class="k"><div class="t">å†¬ã®æ˜Ÿ</div><div class="v" id="kStar">-</div></div>
      <div class="k"><div class="t">ç”Ÿãç‰©ï¼ˆã¾ã¨ã‚ï¼‰</div><div class="v" id="kBio">-</div></div>
      <div class="k"><div class="t">æ°´ã®ã‚†ããˆ</div><div class="v" id="kWater">-</div></div>
      <div class="k"><div class="t">ç™ºè¡¨ï¼ˆä¸»ä½“ï¼‰</div><div class="v" id="kPres">-</div></div>
    </div>

    <div class="hr"></div>

    <div class="sec-title">
      <h2>è‰²åˆ†ã‘ï¼ˆå˜å…ƒï¼‰</h2>
    </div>
    <div class="note">
      <span class="dot star"></span>æ˜Ÿã€€<span class="dot bio"></span>ç”Ÿãç‰©ã€€<span class="dot water"></span>æ°´ã€€
      <span class="dot pres"></span>ç™ºè¡¨ã€€<span class="dot test"></span>ãƒ†ã‚¹ãƒˆã€€<span class="dot other"></span>ãã®ä»–
    </div>

    <div class="hr"></div>

    <div class="sec-title">
      <h2>è©•ä¾¡æ›ç®—ãƒ«ãƒ¼ãƒ«ï¼ˆå…±é€šï¼‰</h2>
    </div>
    <div class="note">
      ç‚¹æ•°â†’5æ®µéšï¼š5=A / 4=B+ / 3=B / 2=B- / 1,0=Cï¼ˆææ¡ˆè¡¨ç¤ºï¼‰ã€‚<br>
      æœ€çµ‚èª¿æ•´ã¯å„é …ç›®ã®ã€Œæœ€çµ‚è©•ä¾¡ã€ã§ä¸Šæ›¸ãã§ãã¾ã™ã€‚
    </div>
  </div>

  <div class="card soft">
    <div class="tabs" id="tabs"></div>
    <div id="panel"></div>
  </div>
</div>

<script>
<!-- ===== Part1/5 END ===== -->
<!-- ===== Part2/5 START ===== -->
const STORAGE_KEY = "rika4_eval_winter_project_v2";

/** ===== Theme ===== */
const THEME_KEY = STORAGE_KEY + "_theme";
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem(THEME_KEY, theme);
}
function toggleTheme(){
  const cur = localStorage.getItem(THEME_KEY) || "dark";
  applyTheme(cur==="dark" ? "light" : "dark");
}

/** ===== Group sync toggle ===== */
const GROUP_SYNC_KEY = STORAGE_KEY + "_group_sync";
function getGroupSyncEnabled(){
  return localStorage.getItem(GROUP_SYNC_KEY) === "1";
}
function setGroupSyncEnabled(v){
  localStorage.setItem(GROUP_SYNC_KEY, v ? "1" : "0");
}

/** ===== Units ===== */
const UNITS = [
  {id:"all",  label:"ï¼ˆå…¨ã¦ï¼‰"},
  {id:"star", label:"å†¬ã®æ˜Ÿ"},
  {id:"bio",  label:"ç”Ÿãç‰©ï¼ˆã¾ã¨ã‚ï¼‰"},
  {id:"water",label:"æ°´ã®ã‚†ããˆ"},
  {id:"pres", label:"ç™ºè¡¨"},
  {id:"test", label:"ãƒ†ã‚¹ãƒˆ"},
  {id:"other",label:"ãã®ä»–"},
];

/** ===== Settings ===== */
const defaultSettings = {
  sessions: [
    {id:"L1",  label:"ç¬¬1æ™‚ï¼ˆå°å…¥ãƒ»ä¸€æ–‰ï¼‰",   type:"whole", unit:"other", isGroup:false},
    {id:"L2",  label:"ç¬¬2æ™‚ï¼ˆä¸€æ–‰ï¼‰",         type:"whole", unit:"other", isGroup:false},
    {id:"L3",  label:"ç¬¬3æ™‚ï¼ˆè‡ªç”±é€²åº¦ï¼‰",     type:"free",  unit:"other", isGroup:false},
    {id:"L4",  label:"ç¬¬4æ™‚ï¼ˆè‡ªç”±é€²åº¦ï¼‰",     type:"free",  unit:"other", isGroup:false},
    {id:"L5",  label:"ç¬¬5æ™‚ï¼ˆè‡ªç”±é€²åº¦ï¼‰",     type:"free",  unit:"other", isGroup:false},
    {id:"L6",  label:"ç¬¬6æ™‚ï¼ˆä¸€æ–‰ï¼‰",         type:"whole", unit:"other", isGroup:false},
    {id:"L7",  label:"ç¬¬7æ™‚ï¼ˆè‡ªç”±é€²åº¦ï¼‰",     type:"free",  unit:"other", isGroup:true},
    {id:"L8",  label:"ç¬¬8æ™‚ï¼ˆè‡ªç”±é€²åº¦ï¼‰",     type:"free",  unit:"other", isGroup:true},
    {id:"L9",  label:"ç¬¬9æ™‚ï¼ˆè‡ªç”±é€²åº¦ï¼‰",     type:"free",  unit:"other", isGroup:true},
    {id:"L10", label:"ç¬¬10æ™‚ï¼ˆè‡ªç”±é€²åº¦ï¼‰",    type:"free",  unit:"other", isGroup:true},
    {id:"L11", label:"ç¬¬11æ™‚ï¼ˆè‡ªç”±é€²åº¦ï¼‰",    type:"free",  unit:"other", isGroup:true},
    {id:"L12", label:"ç¬¬12æ™‚ï¼ˆè‡ªç”±é€²åº¦/ã¾ã¨ã‚ï¼‰", type:"free", unit:"other", isGroup:true},
    {id:"T1",  label:"ãƒ†ã‚¹ãƒˆâ‘ ",              type:"test",  unit:"test",  isGroup:false},
    {id:"T2",  label:"ãƒ†ã‚¹ãƒˆâ‘¡",              type:"test",  unit:"test",  isGroup:false},
  ],
  deliverables: [
    {id:"D1", label:"å†¬ã®æ˜Ÿï¼šè¦³å¯Ÿã‚«ãƒ¼ãƒ‰", unit:"star"},
    {id:"D2", label:"ç”Ÿãç‰©ï¼šãƒ˜ãƒãƒè¦³å¯Ÿã‚«ãƒ¼ãƒ‰", unit:"bio"},
    {id:"D3", label:"ç”Ÿãç‰©ï¼šãƒ­ã‚¤ãƒ­ ã‚·ãƒ³ã‚­ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«", unit:"bio"},
    {id:"D4", label:"æ°´ã®ã‚†ããˆï¼šè’¸ç™º è¨˜éŒ²ã‚«ãƒ¼ãƒ‰", unit:"water"},
    {id:"D5", label:"æ°´ã®ã‚†ããˆï¼šçµéœ² è¨˜éŒ²ã‚«ãƒ¼ãƒ‰", unit:"water"},
    {id:"D6", label:"ç™ºè¡¨ï¼šãµã‚Šã‹ãˆã‚Šï¼ˆä»»æ„ï¼‰", unit:"pres"},
  ]
};

const defaultData = {
  students: ["ï¼ˆå…ç«¥1ï¼‰","ï¼ˆå…ç«¥2ï¼‰","ï¼ˆå…ç«¥3ï¼‰","ï¼ˆå…ç«¥4ï¼‰","ï¼ˆå…ç«¥5ï¼‰","ï¼ˆå…ç«¥6ï¼‰","ï¼ˆå…ç«¥7ï¼‰"],
  byStudent: {},
  settings: structuredClone(defaultSettings)
};

/** ===== Photos (IndexedDB) ===== */
const PHOTO_DB = { name: STORAGE_KEY + "_photos", version: 1, store: "photos" };

function openPhotoDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(PHOTO_DB.name, PHOTO_DB.version);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(PHOTO_DB.store)){
        const st = db.createObjectStore(PHOTO_DB.store, {keyPath:"id"});
        st.createIndex("by_student", ["student","createdAt"]);
        st.createIndex("by_session", ["sessionId","createdAt"]);
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}

function fileToBlob(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(new Blob([r.result], {type:file.type || "image/jpeg"}));
    r.onerror = ()=> reject(r.error);
    r.readAsArrayBuffer(file);
  });
}

async function addPhoto({student, sessionId, note, file}){
  const blob = await fileToBlob(file);
  const db = await openPhotoDB();
  const id = "p_" + crypto.randomUUID();
  const createdAt = Date.now();
  const rec = {id, student, sessionId: sessionId||"", note: note||"", createdAt, mime: blob.type, blob};

  return new Promise((resolve, reject)=>{
    const tx = db.transaction(PHOTO_DB.store, "readwrite");
    tx.objectStore(PHOTO_DB.store).put(rec);
    tx.oncomplete = ()=>{ db.close(); resolve(rec); };
    tx.onerror = ()=>{ db.close(); reject(tx.error); };
    tx.onabort = ()=>{ db.close(); reject(tx.error); };
  });
}

async function listPhotosByStudent(student, limit=60){
  const db = await openPhotoDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(PHOTO_DB.store, "readonly");
    const st = tx.objectStore(PHOTO_DB.store);
    const idx = st.index("by_student");
    const range = IDBKeyRange.bound([student, 0],[student, Number.MAX_SAFE_INTEGER]);
    const req = idx.getAll(range);
    req.onsuccess = ()=>{
      const items = (req.result || []).sort((a,b)=> b.createdAt - a.createdAt).slice(0, limit);
      resolve(items);
    };
    req.onerror = ()=> reject(req.error);
    tx.oncomplete = ()=> db.close();
  });
}

async function deletePhoto(photoId){
  const db = await openPhotoDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(PHOTO_DB.store, "readwrite");
    tx.objectStore(PHOTO_DB.store).delete(photoId);
    tx.oncomplete = ()=>{ db.close(); resolve(true); };
    tx.onerror = ()=>{ db.close(); reject(tx.error); };
  });
}

/** ===== helpers ===== */
const gradeFromScore = (s)=>{
  if(s>=5) return "A";
  if(s===4) return "B+";
  if(s===3) return "B";
  if(s===2) return "B-";
  return "C";
};
const clamp5 = (n)=> Math.max(0, Math.min(5, n|0));
function sumChecks(obj){ return Object.values(obj).filter(Boolean).length; }
function setDeep(obj, path, value){
  const parts = path.split(".");
  let cur = obj;
  for(let i=0;i<parts.length-1;i++){ cur = cur[parts[i]]; }
  cur[parts[parts.length-1]] = value;
}
function unitClass(unitId){
  return unitId==="star"?"u-star":
         unitId==="bio"?"u-bio":
         unitId==="water"?"u-water":
         unitId==="pres"?"u-pres":
         unitId==="test"?"u-test":"u-other";
}
function unitDotClass(unitId){
  return unitId==="star"?"star":
         unitId==="bio"?"bio":
         unitId==="water"?"water":
         unitId==="pres"?"pres":
         unitId==="test"?"test":"other";
}
function unitLabel(unitId){
  return (UNITS.find(u=>u.id===unitId)?.label) || "ãã®ä»–";
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

/** ===== student records ===== */
function emptyRecord(){
  return {
    progress: { bySession: {} },
    deliverables: { byId: {} },

    star: {
      ksA: { c1:false, c2:false, c3:false, c4:false, obsCount:"2-3" },
      ksB: { c1:false,c2:false,c3:false,c4:false,c5:false },
      thA: { score:0 },
      thB: { score:0 },
      attitude: { suggest:"", final:"" }
    },
    bio: {
      ksA: { c1:false,c2:false,c3:false,c4:false, seasonCount:"2" },
      ksB: { c1:false,c2:false,c3:false,c4:false,c5:false },
      thA: { score:0, multiUsed:false },
      thB: { score:0, multiUsed:false },
      attitude: { checks:{c1:false,c2:false,c3:false,c4:false,c5:false}, suggest:"", final:"" }
    },
    water: {
      evap: { ksA:{c1:false,c2:false,c3:false,c4:false,c5:false}, ksB:{c1:false,c2:false,c3:false,c4:false,c5:false}, th:{ score:0 } },
      cond: { ksA:{c1:false,c2:false,c3:false,c4:false,c5:false}, ksB:{c1:false,c2:false,c3:false,c4:false,c5:false}, th:{ score:0 } },
      attitude: { checks:{c1:false,c2:false,c3:false,c4:false,c5:false}, severe:false, suggest:"", final:"" }
    },
    pres: { attitude: { checks:{c1:false,c2:false,c3:false,c4:false,c5:false}, severe:false, suggest:"", final:"" } }
  };
}

function ensureSettingsShape(settings){
  settings.sessions = settings.sessions || structuredClone(defaultSettings.sessions);
  settings.deliverables = settings.deliverables || structuredClone(defaultSettings.deliverables);
  settings.sessions.forEach(s=>{
    if(!s.unit) s.unit = (s.type==="test" ? "test" : "other");
    if(s.isGroup == null) s.isGroup = false;
  });
  settings.deliverables.forEach(d=>{ if(!d.unit) d.unit = "other"; });
}

function migrateStudentRecord(rec, settings){
  rec.progress = rec.progress || {bySession:{}};
  rec.progress.bySession = rec.progress.bySession || {};
  settings.sessions.forEach(s=>{
    if(!rec.progress.bySession[s.id]){
      rec.progress.bySession[s.id] = { status:"æœª", plan:"", done:"", note:"", group:"" };
    } else {
      const v = rec.progress.bySession[s.id];
      if(!v.status) v.status="æœª";
      if(v.plan==null) v.plan="";
      if(v.done==null) v.done="";
      if(v.note==null) v.note="";
      if(v.group==null) v.group="";
    }
  });

  rec.deliverables = rec.deliverables || {byId:{}};
  rec.deliverables.byId = rec.deliverables.byId || {};
  settings.deliverables.forEach(d=>{
    if(!rec.deliverables.byId[d.id]){
      rec.deliverables.byId[d.id] = { submitted:false, date:"", note:"" };
    } else {
      const v = rec.deliverables.byId[d.id];
      if(v.submitted==null) v.submitted=false;
      if(v.date==null) v.date="";
      if(v.note==null) v.note="";
    }
  });
}

function loadData(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){
      const d = structuredClone(defaultData);
      d.students.forEach(n=> d.byStudent[n] = emptyRecord());
      localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
      return d;
    }
    const d = JSON.parse(raw);
    d.students = d.students || [];
    d.byStudent = d.byStudent || {};
    d.settings = d.settings || structuredClone(defaultSettings);
    ensureSettingsShape(d.settings);
    d.students.forEach(n=>{
      if(!d.byStudent[n]) d.byStudent[n] = emptyRecord();
      migrateStudentRecord(d.byStudent[n], d.settings);
    });
    return d;
  }catch(e){
    console.error(e);
    const d = structuredClone(defaultData);
    d.students.forEach(n=> d.byStudent[n] = emptyRecord());
    return d;
  }
}
function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data)); }

/** ===== CSV ===== */
function csvEscape(value){
  const s = String(value ?? "");
  if(/[,"\n\r]/.test(s)) return `"${s.replaceAll('"','""')}"`;
  return s;
}
function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
function exportProgressCSV(filterUnit="all"){
  const sessions = state.data.settings.sessions.filter(s=> filterUnit==="all" ? true : (s.unit===filterUnit));
  const header = ["å…ç«¥"];
  sessions.forEach(s=>{
    header.push(`${s.id} çŠ¶æ…‹`, `${s.id} ã‚°ãƒ«ãƒ¼ãƒ—`, `${s.id} è¨ˆç”»`, `${s.id} å®Ÿç¸¾`, `${s.id} æ•™å¸«ãƒ¡ãƒ¢`);
  });
  const rows = [header];
  state.data.students.forEach(st=>{
    const r = state.data.byStudent[st];
    const row = [st];
    sessions.forEach(s=>{
      const v = r.progress.bySession[s.id] || {status:"æœª",group:"",plan:"",done:"",note:""};
      row.push(v.status||"", v.group||"", v.plan||"", v.done||"", v.note||"");
    });
    rows.push(row);
  });
  const csv = rows.map(r=> r.map(csvEscape).join(",")).join("\n");
  downloadText(`rika4_progress_${filterUnit}.csv`, csv);
}
function exportDeliverablesCSV(filterUnit="all"){
  const dels = state.data.settings.deliverables.filter(d=> filterUnit==="all" ? true : (d.unit===filterUnit));
  const header = ["å…ç«¥"];
  dels.forEach(d=> header.push(`${d.id} æå‡º`, `${d.id} æå‡ºæ—¥`, `${d.id} ãƒ¡ãƒ¢`));
  const rows = [header];
  state.data.students.forEach(st=>{
    const r = state.data.byStudent[st];
    const row = [st];
    dels.forEach(d=>{
      const v = r.deliverables.byId[d.id] || {submitted:false,date:"",note:""};
      row.push(v.submitted ? "æå‡º" : "æœªæå‡º", v.date||"", v.note||"");
    });
    rows.push(row);
  });
  const csv = rows.map(r=> r.map(csvEscape).join(",")).join("\n");
  downloadText(`rika4_deliverables_${filterUnit}.csv`, csv);
}

/** ===== Group sync core ===== */
function shouldSyncGroup(sessionId){
  if(!getGroupSyncEnabled()) return false;
  const s = state.data.settings.sessions.find(x=>x.id===sessionId);
  return !!s?.isGroup;
}
function syncToSameGroup(sessionId, groupName, patchFn){
  if(!groupName) return;
  state.data.students.forEach(st=>{
    if(st===state.currentStudent) return;
    const r = state.data.byStudent[st];
    if((r.progress.bySession[sessionId]?.group||"") === groupName){
      patchFn(r.progress.bySession[sessionId]);
    }
  });
}

/** ===== student rename (with photo DB migration) ===== */
async function renamePhotosStudent(oldName, newName){
  const db = await openPhotoDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(PHOTO_DB.store, "readwrite");
    const st = tx.objectStore(PHOTO_DB.store);
    const idx = st.index("by_student");
    const range = IDBKeyRange.bound([oldName, 0],[oldName, Number.MAX_SAFE_INTEGER]);
    const req = idx.getAll(range);
    req.onsuccess = ()=>{
      (req.result||[]).forEach(p=> st.put({...p, student:newName}));
    };
    req.onerror = ()=> reject(req.error);
    tx.oncomplete = ()=>{ db.close(); resolve(true); };
    tx.onerror = ()=>{ db.close(); reject(tx.error); };
    tx.onabort = ()=>{ db.close(); reject(tx.error); };
  });
}

async function renameStudent(oldName, newName){
  newName = (newName || "").trim();
  if(!newName) return alert("æ–°ã—ã„åå‰ãŒç©ºã§ã™ã€‚");
  if(state.data.students.includes(newName)) return alert("åŒåã®å…ç«¥ãŒã™ã§ã«ã„ã¾ã™ã€‚");

  const idx = state.data.students.indexOf(oldName);
  if(idx<0) return alert("å¤‰æ›´å¯¾è±¡ã®å…ç«¥ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
  state.data.students[idx] = newName;

  state.data.byStudent[newName] = state.data.byStudent[oldName];
  delete state.data.byStudent[oldName];

  if(state.currentStudent === oldName) state.currentStudent = newName;

  try{ await renamePhotosStudent(oldName, newName); }
  catch(e){ alert("â€»å…ç«¥åã¯å¤‰æ›´ã§ãã¾ã—ãŸãŒã€å†™çœŸã®ç§»è¡Œã§ã‚¨ãƒ©ãƒ¼ï¼š" + e.message); }

  saveData();
  renderStudentSelect();
  renderPanel();
  refreshKPIs();
}

/** ===== state ===== */
const state = {
  data: loadData(),
  currentStudent: null,
  currentTab: "progress",
  overviewFilterUnit: "all"
};
<!-- ===== Part2/5 END ===== -->
<!-- ===== Part3/5 START ===== -->
/** ===== suggestions ===== */
function computeStarSuggest(rec){
  const ksA_checks = ["c1","c2","c3","c4"].reduce((a,k)=>a+(rec.star.ksA[k]?1:0),0);
  const bonus = (rec.star.ksA.obsCount==="4+") ? 1 : 0;
  const ksA = Math.min(5, ksA_checks + bonus);
  const ksB = sumChecks(rec.star.ksB);
  const thA = clamp5(rec.star.thA.score);
  const thB = clamp5(rec.star.thB.score);
  return { ksA:{score:ksA, grade:gradeFromScore(ksA)}, ksB:{score:ksB, grade:gradeFromScore(ksB)},
           thA:{score:thA, grade:gradeFromScore(thA)}, thB:{score:thB, grade:gradeFromScore(thB)},
           attitude:{grade: rec.star.attitude.final || rec.star.attitude.suggest || ""} };
}
function computeBioSuggest(rec){
  const ksA_checks = ["c1","c2","c3","c4"].reduce((a,k)=>a+(rec.bio.ksA[k]?1:0),0);
  const bonus = (parseInt(rec.bio.ksA.seasonCount,10) >= 3) ? 1 : 0;
  const ksA = Math.min(5, ksA_checks + bonus);
  const ksB = sumChecks(rec.bio.ksB);

  const rawA = clamp5(rec.bio.thA.score);
  const rawB = clamp5(rec.bio.thB.score);
  const advA = !!rec.bio.thA.multiUsed;
  const advB = !!rec.bio.thB.multiUsed;

  let thA_score = rawA;
  let thB_score = rawB;

  if(advA) thA_score = Math.min(5, thA_score + 1);
  if(advB) thB_score = Math.min(5, thB_score + 1);

  // 2ç¨®é¡ä»¥ä¸Šã§è€ƒå¯Ÿâ†’Cç„¡ã—ï¼ˆæœ€ä½2ç‚¹ï¼‰
  if(advA && thA_score <= 1) thA_score = 2;
  if(advB && thB_score <= 1) thB_score = 2;

  const attChecks = sumChecks(rec.bio.attitude.checks);
  let attGrade = gradeFromScore(Math.min(5, attChecks));
  // æ€è€ƒã§åŠ ç‚¹ã—ãŸå ´åˆã€ä¸»ä½“ã¯æœ€ä½Bä»¥ä¸Š
  if(advA || advB){
    if(attGrade === "C" || attGrade === "B-") attGrade = "B";
  }
  rec.bio.attitude.suggest = attGrade;

  return { ksA:{score:ksA, grade:gradeFromScore(ksA)}, ksB:{score:ksB, grade:gradeFromScore(ksB)},
           thA:{score:thA_score, grade:gradeFromScore(thA_score), adv:advA},
           thB:{score:thB_score, grade:gradeFromScore(thB_score), adv:advB},
           attitude:{grade: rec.bio.attitude.final || rec.bio.attitude.suggest || ""} };
}
function computeWaterSuggest(rec){
  const e_ksA = sumChecks(rec.water.evap.ksA);
  const e_ksB = sumChecks(rec.water.evap.ksB);
  const e_th  = clamp5(rec.water.evap.th.score);

  const c_ksA = sumChecks(rec.water.cond.ksA);
  const c_ksB = sumChecks(rec.water.cond.ksB);
  const c_th  = clamp5(rec.water.cond.th.score);

  let attGrade = gradeFromScore(sumChecks(rec.water.attitude.checks));
  if(rec.water.attitude.severe) attGrade = "C";
  rec.water.attitude.suggest = attGrade;

  return { evap:{ ksA:{score:e_ksA, grade:gradeFromScore(e_ksA)}, ksB:{score:e_ksB, grade:gradeFromScore(e_ksB)}, th:{score:e_th, grade:gradeFromScore(e_th)} },
           cond:{ ksA:{score:c_ksA, grade:gradeFromScore(c_ksA)}, ksB:{score:c_ksB, grade:gradeFromScore(c_ksB)}, th:{score:c_th, grade:gradeFromScore(c_th)} },
           attitude:{grade: rec.water.attitude.final || rec.water.attitude.suggest || ""} };
}
function computePresSuggest(rec){
  let attGrade = gradeFromScore(sumChecks(rec.pres.attitude.checks));
  if(rec.pres.attitude.severe) attGrade = "C";
  rec.pres.attitude.suggest = attGrade;
  return { attitude:{grade: rec.pres.attitude.final || rec.pres.attitude.suggest || ""} };
}

/** ===== UI core ===== */
const tabs = [
  {id:"progress", label:"é€²æ—ãƒ»æå‡ºç‰©ï¼ˆå€‹äººï¼‰"},
  {id:"overview", label:"ä¸€è¦§ï¼ˆã‚¯ãƒ©ã‚¹ï¼‰"},
  {id:"star", label:"å†¬ã®æ˜Ÿ"},
  {id:"bio", label:"ç”Ÿãç‰©ï¼ˆã¾ã¨ã‚ï¼‰"},
  {id:"water", label:"æ°´ã®ã‚†ããˆ"},
  {id:"pres", label:"ç™ºè¡¨ï¼ˆä¸»ä½“ï¼‰"},
];

function init(){
  function init(){
  // 1) DOMã®å¿…é ˆè¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆã“ã“ã§åˆ†ã‹ã‚‹ï¼‰
  const mustIds = ["studentSelect","btnAddStudent","newStudentName","currentName","tabs","panel"];
  const missing = mustIds.filter(id => !document.getElementById(id));
  if(missing.length){
    alert("HTMLå´ã«å¿…è¦ãªIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼š\n" + missing.join(", ") + "\n\nï¼ˆHTMLã®idåãŒJSã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã­ï¼‰");
    console.error("Missing IDs:", missing);
    return;
  }

  // 2) åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’å¿…ãšè£œå®Œï¼ˆstudentsãŒç©ºã§ã‚‚æœ€ä½1äººä½œã‚‹ï¼‰
  ensureSettingsShape(state.data.settings);
  state.data.students = Array.isArray(state.data.students) ? state.data.students : [];
  state.data.byStudent = state.data.byStudent || {};

  if(state.data.students.length === 0){
    state.data.students = ["ï¼ˆå…ç«¥1ï¼‰"];
  }
  state.data.students.forEach(n=>{
    if(!state.data.byStudent[n]) state.data.byStudent[n] = emptyRecord();
    migrateStudentRecord(state.data.byStudent[n], state.data.settings);
  });

  // currentStudentã‚‚å¿…ãšã‚»ãƒƒãƒˆ
  state.currentStudent = state.currentStudent && state.data.students.includes(state.currentStudent)
    ? state.currentStudent
    : state.data.students[0];

  // 3) UIæç”»
  renderStudentSelect();
  renderTabs();
  renderPanel();
  refreshKPIs();
  bindGlobalButtons();

  // 4) ä¿å­˜ï¼ˆã“ã“ã§åˆæœŸå…ç«¥ãŒæ°¸ç¶šåŒ–ã•ã‚Œã‚‹ï¼‰
  saveData();

  // 5) ãƒ†ãƒ¼ãƒç³»ã¯è¦ç´ ãŒã‚ã‚Œã°å¾Œã§ï¼ˆç„¡ãã¦ã‚‚è½ã¡ãªã„ï¼‰
  try{
    if(typeof applyTheme === "function"){
      applyTheme(localStorage.getItem(THEME_KEY) || "dark");
    }
    const btnTheme = document.getElementById("btnTheme");
    if(btnTheme && typeof toggleTheme === "function"){
      btnTheme.onclick = toggleTheme;
    }
    const tgs = document.getElementById("toggleGroupSync");
    if(tgs){
      tgs.checked = (typeof getGroupSyncEnabled === "function") ? getGroupSyncEnabled() : false;
      tgs.onchange = ()=> {
        if(typeof setGroupSyncEnabled === "function"){
          setGroupSyncEnabled(tgs.checked);
        }
      };
    }
  }catch(e){
    console.warn("theme/group init skipped:", e);
  }
}
  
  state.currentStudent = state.data.students[0];

  renderStudentSelect();
  renderTabs();
  renderPanel();
  refreshKPIs();
  bindGlobalButtons();
}

function renderTabs(){
  const el = document.getElementById("tabs");
  el.innerHTML = "";
  tabs.forEach(t=>{
    const b = document.createElement("button");
    b.className = "tab" + (state.currentTab===t.id ? " active":"");
    b.textContent = t.label;
    b.onclick = ()=>{
      state.currentTab = t.id;
      renderTabs();
      renderPanel();
    };
    el.appendChild(b);
  });
}

function refreshKPIs(){
  const rec = state.data.byStudent[state.currentStudent];
  const sStar = computeStarSuggest(rec);
  const sBio = computeBioSuggest(rec);
  const sWater = computeWaterSuggest(rec);
  const sPres = computePresSuggest(rec);

  document.getElementById("kStar").textContent =
    `çŸ¥A:${(rec.star.ksA.obsCount==="4+"? "â˜…":"")}${sStar.ksA.grade} / çŸ¥B:${sStar.ksB.grade} / æ€A:${sStar.thA.grade} / æ€B:${sStar.thB.grade}`;

  document.getElementById("kBio").textContent =
    `çŸ¥A:${sBio.ksA.grade} / çŸ¥B:${sBio.ksB.grade} / æ€A:${(sBio.thA.adv?"â˜…":"")}${sBio.thA.grade} / æ€B:${(sBio.thB.adv?"â˜…":"")}${sBio.thB.grade} / ä¸»ä½“:${sBio.attitude.grade||"-"}`;

  document.getElementById("kWater").textContent =
    `è’¸ç™º(çŸ¥A:${sWater.evap.ksA.grade},çŸ¥B:${sWater.evap.ksB.grade},æ€:${sWater.evap.th.grade})ãƒ»çµéœ²(çŸ¥A:${sWater.cond.ksA.grade},çŸ¥B:${sWater.cond.ksB.grade},æ€:${sWater.cond.th.grade})ãƒ»ä¸»ä½“:${sWater.attitude.grade||"-"}`;

  document.getElementById("kPres").textContent = `ä¸»ä½“:${sPres.attitude.grade || "-"}`;
  saveData();
}

function bindGlobalButtons(){
  document.getElementById("btnReset").onclick = ()=>{
    if(!confirm("æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰")) return;
    localStorage.removeItem(STORAGE_KEY);
    // ç”»åƒDBã‚‚æ¶ˆã—ãŸã„å ´åˆã¯ã“ã“ã§ indexedDB.deleteDatabase(PHOTO_DB.name) ã‚’å‘¼ã¶
    location.reload();
  };

  document.getElementById("btnExport").onclick = ()=>{
    const blob = new Blob([JSON.stringify(state.data,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "rika4_eval_backup.json";
    a.click();
    URL.revokeObjectURL(url);
  };

  document.getElementById("btnImport").onclick = async ()=>{
    const inp = document.createElement("input");
    inp.type="file"; inp.accept="application/json";
    inp.onchange = ()=>{
      const f = inp.files?.[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const d = JSON.parse(String(r.result||""));
          if(!d.students || !d.byStudent) throw new Error("å½¢å¼ãŒé•ã„ã¾ã™");
          d.settings = d.settings || structuredClone(defaultSettings);
          ensureSettingsShape(d.settings);
          d.byStudent = d.byStudent || {};
          d.students.forEach(n=>{
            if(!d.byStudent[n]) d.byStudent[n]=emptyRecord();
            migrateStudentRecord(d.byStudent[n], d.settings);
          });
          state.data = d;
          state.currentStudent = state.data.students[0] || "";
          saveData();
          renderStudentSelect();
          renderTabs();
          renderPanel();
          refreshKPIs();
        }catch(e){
          alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸï¼š " + e.message);
        }
      };
      r.readAsText(f);
    };
    inp.click();
  };
}

/** ===== åç°¿ï¼ˆè¿½åŠ ï¼‹å¤‰æ›´ï¼‰ ===== */
function renderStudentSelect(){
  const sel = document.getElementById("studentSelect");
  const btnAdd = document.getElementById("btnAddStudent");
  const inp = document.getElementById("newStudentName");
  const curName = document.getElementById("currentName");

  // ã‚¬ãƒ¼ãƒ‰ï¼ˆå¿µã®ãŸã‚ï¼‰
  if(!sel || !btnAdd || !inp || !curName){
    console.error("renderStudentSelect: missing elements", {sel, btnAdd, inp, curName});
    return;
  }

  // ã‚»ãƒ¬ã‚¯ãƒˆã‚’æç”»
  sel.innerHTML = "";
  state.data.students.forEach(n=>{
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = n;
    sel.appendChild(opt);
  });

  // currentStudentãŒç„¡åŠ¹ãªã‚‰å…ˆé ­ã«
  if(!state.currentStudent || !state.data.students.includes(state.currentStudent)){
    state.currentStudent = state.data.students[0];
  }
  sel.value = state.currentStudent;
  curName.textContent = state.currentStudent;

  sel.onchange = ()=>{
    state.currentStudent = sel.value;
    curName.textContent = state.currentStudent;
    saveData();
    renderPanel();
    refreshKPIs();
  };

  // è¿½åŠ ãƒœã‚¿ãƒ³ï¼šå¿…ãšå‹•ãã‚ˆã†ã«æ¯å› onclick ã‚’è¨­å®š
  btnAdd.onclick = ()=>{
    const name = (inp.value || "").trim();
    if(!name) return alert("å…ç«¥åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    if(state.data.students.includes(name)) return alert("åŒåã®å…ç«¥ãŒã™ã§ã«ã„ã¾ã™ã€‚");

    state.data.students.push(name);
    state.data.byStudent[name] = emptyRecord();
    migrateStudentRecord(state.data.byStudent[name], state.data.settings);

    state.currentStudent = name;
    inp.value = "";

    saveData();
    renderStudentSelect();
    renderPanel();
    refreshKPIs();
  };

  // Enterã§è¿½åŠ 
  inp.onkeydown = (e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      btnAdd.click();
    }
  };

  // åå‰å¤‰æ›´ãƒœã‚¿ãƒ³ï¼ˆã‚ã‚Œã°ï¼‰
  const btnRename = document.getElementById("btnRenameStudent");
  if(btnRename){
    btnRename.onclick = async ()=>{
      const oldName = state.currentStudent;
      const newName = prompt(`å…ç«¥åã‚’å¤‰æ›´ã—ã¾ã™ã€‚\nç¾åœ¨ï¼š${oldName}\næ–°ã—ã„åå‰ï¼š`, oldName);
      if(newName==null) return;
      await renameStudent(oldName, newName);
      saveData();
      renderStudentSelect();
      renderPanel();
      refreshKPIs();
    };
  }
}

  document.getElementById("btnAddStudent").onclick = ()=>{
    const name = (document.getElementById("newStudentName").value || "").trim();
    if(!name) return alert("å…ç«¥åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    if(state.data.students.includes(name)) return alert("åŒåã®å…ç«¥ãŒã™ã§ã«ã„ã¾ã™ã€‚");
    state.data.students.push(name);
    state.data.byStudent[name] = emptyRecord();
    migrateStudentRecord(state.data.byStudent[name], state.data.settings);
    state.currentStudent = name;
    document.getElementById("newStudentName").value = "";
    saveData();
    renderStudentSelect();
    renderPanel();
    refreshKPIs();
  };

  // â˜… å…ç«¥åå¤‰æ›´
  const btnRename = document.getElementById("btnRenameStudent");
  if(btnRename){
    btnRename.onclick = async ()=>{
      const oldName = state.currentStudent;
      const newName = prompt(`å…ç«¥åã‚’å¤‰æ›´ã—ã¾ã™ã€‚\nç¾åœ¨ï¼š${oldName}\næ–°ã—ã„åå‰ï¼š`, oldName);
      if(newName==null) return;
      await renameStudent(oldName, newName);
    };
  }

function renderPanel(){
  const rec = state.data.byStudent[state.currentStudent];
  const panel = document.getElementById("panel");
  panel.innerHTML = "";

  if(state.currentTab==="progress"){
    panel.appendChild(renderProgressAndDeliverables(rec));
  } else if(state.currentTab==="overview"){
    panel.appendChild(renderOverview());
  } else if(state.currentTab==="star"){
    panel.appendChild(renderStar(rec));
  } else if(state.currentTab==="bio"){
    panel.appendChild(renderBio(rec));
  } else if(state.currentTab==="water"){
    panel.appendChild(renderWater(rec));
  } else if(state.currentTab==="pres"){
    panel.appendChild(renderPres(rec));
  }
}

/** ===== UI parts ===== */
function labelRow(title, right){
  const d = document.createElement("div");
  d.className="sec-title";
  const h = document.createElement("h2");
  h.textContent = title;
  const r = document.createElement("div");
  r.className="hint";
  if(right) r.innerHTML = right;
  d.appendChild(h); d.appendChild(r);
  return d;
}
function gradeSelect(value, onChange){
  const sel = document.createElement("select");
  ["","A","B+","B","B-","C"].forEach(v=>{
    const o = document.createElement("option");
    o.value=v; o.textContent = v==="" ? "ï¼ˆè‡ªå‹•ï¼‰" : v;
    sel.appendChild(o);
  });
  sel.value = value || "";
  sel.onchange = ()=> onChange(sel.value);
  return sel;
}
function checkItem(path, text, rec){
  const wrap = document.createElement("label");
  wrap.className="chk";
  const input = document.createElement("input");
  input.type="checkbox";
  const parts = path.split(".");
  let cur = rec;
  for(const p of parts) cur = cur[p];
  input.checked = !!cur;
  input.onchange = ()=>{
    setDeep(rec, path, input.checked);
    refreshKPIs();
    renderPanel();
  };
  const span = document.createElement("div");
  span.innerHTML = `<div>${text}</div>`;
  wrap.appendChild(input); wrap.appendChild(span);
  return wrap;
}
function numberInput(path, rec, min=0, max=5){
  const input = document.createElement("input");
  input.type="number"; input.min=min; input.max=max; input.step="1";
  const parts = path.split(".");
  let cur = rec;
  for(const p of parts) cur = cur[p];
  input.value = cur ?? 0;
  input.oninput = ()=>{
    let v = parseInt(input.value||"0",10);
    if(Number.isNaN(v)) v=0;
    v = Math.max(min, Math.min(max, v));
    setDeep(rec, path, v);
    refreshKPIs();
    renderPanel();
  };
  return input;
}
function unitSelect(value, onChange){
  const sel = document.createElement("select");
  UNITS.filter(u=>u.id!=="all").forEach(u=>{
    const o=document.createElement("option"); o.value=u.id; o.textContent=u.label; sel.appendChild(o);
  });
  sel.value = value || "other";
  sel.onchange = ()=> onChange(sel.value);
  return sel;
}
<!-- ===== Part3/5 END ===== -->
<!-- ===== Part4/5 START ===== -->
/** ===== progress/deliverables (å€‹äºº) + å†™çœŸ ===== */
function renderProgressAndDeliverables(rec){
  const box = document.createElement("div");
  box.appendChild(labelRow("é€²æ—ç¢ºèªï¼ˆæˆæ¥­æ ï¼‰ï¼æå‡ºç‰©ãƒªã‚¹ãƒˆï¼ˆç·¨é›†å¯ï¼‰ï¼‹å†™çœŸè¨˜éŒ²", ""));
  const setCard = document.createElement("div");
  setCard.className="card";
  const info = document.createElement("div");
  info.className="note";
  info.innerHTML = `ãƒ»æˆæ¥­æ /æå‡ºç‰©ã¯ç·¨é›†ã§ãã¾ã™ï¼ˆå˜å…ƒã®è‰²åˆ†ã‘ã¨ä¸€è¦§ã®ãƒ•ã‚£ãƒ«ã‚¿ã«ä½¿ã„ã¾ã™ï¼‰ã€‚<br>
  ãƒ»æˆæ¥­æ ãŒã€Œã‚°ãƒ«ãƒ¼ãƒ—ã€ãªã‚‰ã€ã‚°ãƒ«ãƒ¼ãƒ—åãŒåŒã˜å…ç«¥ã¸ï¼ˆçŠ¶æ…‹/è¨ˆç”»/å®Ÿç¸¾/ãƒ¡ãƒ¢ï¼‰ã‚’åŒæœŸã§ãã¾ã™ï¼ˆä¸Šéƒ¨ã®ã€Œã‚°ãƒ«ãƒ¼ãƒ—åŒæœŸã€ã‚’ONï¼‰ã€‚`;
  setCard.appendChild(info);

  const two = document.createElement("div"); two.className="two";

  /** sessions editor */
  const ses = document.createElement("div"); ses.className="card";
  ses.appendChild(labelRow("æˆæ¥­æ ï¼ˆç·¨é›†ï¼‰", `<span class="small">å˜å…ƒï¼ˆè‰²åˆ†ã‘ï¼‰ï¼‹ã‚°ãƒ«ãƒ¼ãƒ—æ </span>`));
  const sesTbl = document.createElement("table"); sesTbl.className="table";

  state.data.settings.sessions.forEach((s)=>{
    const tr = document.createElement("tr");

    const td1 = document.createElement("td"); td1.className="w-170";
    td1.innerHTML = `<div class="mono">${s.id}</div>`;

    const td2 = document.createElement("td");
    const label = document.createElement("input");
    label.value = s.label;
    label.oninput = ()=>{ s.label = label.value; saveData(); };
    td2.appendChild(label);

    const td3 = document.createElement("td"); td3.className="w-140";
    const type = document.createElement("select");
    [["whole","ä¸€æ–‰"],["free","è‡ªç”±"],["test","ãƒ†ã‚¹ãƒˆ"]].forEach(([v,t])=>{
      const o=document.createElement("option"); o.value=v; o.textContent=t; type.appendChild(o);
    });
    type.value = s.type;
    type.onchange = ()=>{ s.type = type.value; if(!s.unit) s.unit="other"; saveData(); renderPanel(); };
    td3.appendChild(type);

    const td4 = document.createElement("td"); td4.className="w-170";
    td4.appendChild(unitSelect(s.unit, (v)=>{ s.unit=v; saveData(); renderPanel(); }));

    const td5 = document.createElement("td"); td5.className="w-140";
    const g = document.createElement("label");
    g.className="pill";
    g.style.cursor="pointer";
    const chk = document.createElement("input"); chk.type="checkbox"; chk.checked=!!s.isGroup;
    chk.onchange = ()=>{ s.isGroup = chk.checked; saveData(); renderPanel(); };
    g.appendChild(chk);
    g.appendChild(document.createTextNode("ã‚°ãƒ«ãƒ¼ãƒ—æ "));
    td5.appendChild(g);

    const td6 = document.createElement("td"); td6.className="w-110";
    const del = document.createElement("button");
    del.className="btn danger"; del.textContent="å‰Šé™¤";
    del.onclick = ()=>{
      if(!confirm(`ã€Œ${s.label}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      state.data.settings.sessions = state.data.settings.sessions.filter(x=>x.id!==s.id);
      saveData();
      renderPanel();
    };
    td6.appendChild(del);

    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4); tr.appendChild(td5); tr.appendChild(td6);
    sesTbl.appendChild(tr);
  });
  ses.appendChild(sesTbl);

  // add session
const addRow = document.createElement("div"); addRow.className="row";
const newId = document.createElement("input"); newId.placeholder="IDï¼ˆä¾‹ï¼šL13ï¼‰"; newId.className="w-140";
const newLabel = document.createElement("input"); newLabel.placeholder="è¡¨ç¤ºåï¼ˆä¾‹ï¼šç¬¬13æ™‚ï¼‰"; newLabel.className="grow";
const newType = document.createElement("select");
[["whole","ä¸€æ–‰"],["free","è‡ªç”±"],["test","ãƒ†ã‚¹ãƒˆ"]].forEach(([v,t])=>{
  const o=document.createElement("option"); o.value=v; o.textContent=t; newType.appendChild(o);
});
const newUnit = unitSelect("other", ()=>{});

const addSessionBtn = document.createElement("button");
addSessionBtn.className="btn primary";
addSessionBtn.textContent="æˆæ¥­æ ã‚’è¿½åŠ ";
addSessionBtn.onclick = ()=>{
  const id = (newId.value||"").trim();
  const label = (newLabel.value||"").trim();
  const type = newType.value;
  const unit = newUnit.value;
  if(!id || !label) return alert("IDã¨è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  if(state.data.settings.sessions.some(x=>x.id===id)) return alert("åŒã˜IDãŒæ—¢ã«ã‚ã‚Šã¾ã™ã€‚");
  state.data.settings.sessions.push({id, label, type, unit});
  state.data.students.forEach(n=>{
    const r = state.data.byStudent[n];
    r.progress.bySession[id] = {status:"æœª", plan:"", done:"", note:""};
  });
  newId.value=""; newLabel.value="";
  saveData();
  renderPanel();
};

addRow.appendChild(newId);
addRow.appendChild(newLabel);
addRow.appendChild(newType);
addRow.appendChild(newUnit);
addRow.appendChild(addSessionBtn);
ses.appendChild(addRow);

  /** deliverables editor */
  const deliv = document.createElement("div"); deliv.className="card";
  deliv.appendChild(labelRow("æå‡ºç‰©ãƒªã‚¹ãƒˆï¼ˆç·¨é›†ï¼‰", `<span class="small">å˜å…ƒï¼ˆè‰²åˆ†ã‘ï¼‰ã‚‚æŒ‡å®š</span>`));
  const dTbl = document.createElement("table"); dTbl.className="table";
  state.data.settings.deliverables.forEach((d)=>{
    const tr = document.createElement("tr");

    const td1 = document.createElement("td"); td1.className="w-170";
    td1.innerHTML = `<div class="mono">${d.id}</div>`;

    const td2 = document.createElement("td");
    const label = document.createElement("input");
    label.value = d.label;
    label.oninput = ()=>{ d.label = label.value; saveData(); };
    td2.appendChild(label);

    const td3 = document.createElement("td"); td3.className="w-170";
    td3.appendChild(unitSelect(d.unit, (v)=>{ d.unit=v; saveData(); renderPanel(); }));

    const td4 = document.createElement("td"); td4.className="w-110";
    const del = document.createElement("button");
    del.className="btn danger"; del.textContent="å‰Šé™¤";
    del.onclick = ()=>{
      if(!confirm(`æå‡ºç‰©ã€Œ${d.label}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      state.data.settings.deliverables = state.data.settings.deliverables.filter(x=>x.id!==d.id);
      saveData();
      renderPanel();
    };
    td4.appendChild(del);

    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4);
    dTbl.appendChild(tr);
  });
  deliv.appendChild(dTbl);

  const addRow2 = document.createElement("div"); addRow2.className="row";
  const newDid = document.createElement("input"); newDid.placeholder="IDï¼ˆä¾‹ï¼šD7ï¼‰"; newDid.className="w-140";
  const newDLabel = document.createElement("input"); newDLabel.placeholder="æå‡ºç‰©åï¼ˆä¾‹ï¼šç™ºè¡¨ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰"; newDLabel.className="grow";
  const newDUnit = unitSelect("other", ()=>{});
  const addBtn2 = document.createElement("button"); addBtn2.className="btn primary"; addBtn2.textContent="æå‡ºç‰©ã‚’è¿½åŠ ";
  addBtn2.onclick = ()=>{
    const id = (newDid.value||"").trim();
    const label = (newDLabel.value||"").trim();
    const unit = newDUnit.value;
    if(!id || !label) return alert("IDã¨æå‡ºç‰©åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    if(state.data.settings.deliverables.some(x=>x.id===id)) return alert("åŒã˜IDãŒæ—¢ã«ã‚ã‚Šã¾ã™ã€‚");
    state.data.settings.deliverables.push({id, label, unit});
    state.data.students.forEach(n=>{
      const r = state.data.byStudent[n];
      r.deliverables.byId[id] = {submitted:false, date:"", note:""};
    });
    newDid.value=""; newDLabel.value="";
    saveData();
    renderPanel();
  };
  addRow2.appendChild(newDid); addRow2.appendChild(newDLabel); addRow2.appendChild(newDUnit); addRow2.appendChild(addBtn2);
  deliv.appendChild(addRow2);

  two.appendChild(ses);
  two.appendChild(deliv);
  setCard.appendChild(two);
  box.appendChild(setCard);

  /** individual progress */
  box.appendChild(labelRow("12æ™‚é–“ã®é€²æ—ï¼ˆå…ç«¥ã®è¨ˆç”»ã¤ãï¼‰", `<b>${state.currentStudent}</b>`));
  const pCard = document.createElement("div"); pCard.className="card";
  const pTbl = document.createElement("table"); pTbl.className="table";
  const statuses = ["æœª","é€”ä¸­","å®Œäº†","æ¬ "];

  state.data.settings.sessions.forEach(s=>{
    const tr = document.createElement("tr");
    const td1 = document.createElement("td"); td1.className="w-170";
    td1.innerHTML = `<div><b>${s.label}</b></div>
      <div class="small">ç¨®åˆ¥ï¼š${s.type==="whole"?"ä¸€æ–‰":(s.type==="free"?"è‡ªç”±":"ãƒ†ã‚¹ãƒˆ")} ï¼ å˜å…ƒï¼š${unitLabel(s.unit)} ${s.isGroup? "ï¼ <b>ã‚°ãƒ«ãƒ¼ãƒ—</b>":""}</div>`;

    const td2 = document.createElement("td");

    // çŠ¶æ…‹
    const row = document.createElement("div"); row.className="row";
    const stSel = document.createElement("select"); stSel.className="w-140";
    statuses.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; stSel.appendChild(o); });
    stSel.value = rec.progress.bySession[s.id]?.status || "æœª";
    stSel.onchange = ()=>{
      rec.progress.bySession[s.id].status = stSel.value;

      // ã‚°ãƒ«ãƒ¼ãƒ—åŒæœŸ
      const groupName = (rec.progress.bySession[s.id].group||"").trim();
      if(shouldSyncGroup(s.id) && groupName){
        syncToSameGroup(s.id, groupName, (target)=>{
          target.status = stSel.value;
        });
      }
      saveData();
      renderPanel();
    };
    row.appendChild(document.createTextNode("çŠ¶æ…‹ï¼š"));
    row.appendChild(stSel);

    // ã‚°ãƒ«ãƒ¼ãƒ—åï¼ˆã‚°ãƒ«ãƒ¼ãƒ—æ ã®ã¿è¡¨ç¤ºï¼‰
    if(s.isGroup){
      const gInp = document.createElement("input");
      gInp.placeholder = "ã‚°ãƒ«ãƒ¼ãƒ—åï¼ˆä¾‹ï¼šAç­ï¼‰";
      gInp.className = "w-140";
      gInp.value = rec.progress.bySession[s.id]?.group || "";
      gInp.oninput = ()=>{
        rec.progress.bySession[s.id].group = gInp.value;
        saveData();
      };
      row.appendChild(document.createTextNode(" ã‚°ãƒ«ãƒ¼ãƒ—ï¼š"));
      row.appendChild(gInp);
    }

    td2.appendChild(row);

    const plan = document.createElement("textarea");
    plan.placeholder = (s.type==="free") ? "å…ç«¥ã®è¨ˆç”»ï¼ˆã“ã®æ™‚é–“ã«ã‚„ã‚‹ã“ã¨ï¼‰" : "ï¼ˆä»»æ„ï¼‰ã“ã®æ™‚é–“ã®ãƒ¡ãƒ¢";
    plan.value = rec.progress.bySession[s.id]?.plan || "";
    plan.oninput = ()=>{
      rec.progress.bySession[s.id].plan = plan.value;

      const groupName = (rec.progress.bySession[s.id].group||"").trim();
      if(shouldSyncGroup(s.id) && groupName){
        syncToSameGroup(s.id, groupName, (target)=>{
          target.plan = plan.value;
        });
      }
      saveData();
    };

    const done = document.createElement("textarea");
    done.placeholder = (s.type==="free") ? "å®Ÿç¸¾ãƒ¡ãƒ¢ï¼ˆã‚„ã£ãŸã“ã¨ãƒ»æ¬¡ã¸ï¼‰" : "å®Ÿç¸¾ãƒ¡ãƒ¢";
    done.value = rec.progress.bySession[s.id]?.done || "";
    done.oninput = ()=>{
      rec.progress.bySession[s.id].done = done.value;

      const groupName = (rec.progress.bySession[s.id].group||"").trim();
      if(shouldSyncGroup(s.id) && groupName){
        syncToSameGroup(s.id, groupName, (target)=>{
          target.done = done.value;
        });
      }
      saveData();
    };

    const note = document.createElement("input");
    note.placeholder = "æ•™å¸«ãƒ¡ãƒ¢ï¼ˆæ”¯æ´ãƒ»å£°ã‹ã‘ç­‰ï¼‰";
    note.value = rec.progress.bySession[s.id]?.note || "";
    note.oninput = ()=>{
      rec.progress.bySession[s.id].note = note.value;

      const groupName = (rec.progress.bySession[s.id].group||"").trim();
      if(shouldSyncGroup(s.id) && groupName){
        syncToSameGroup(s.id, groupName, (target)=>{
          target.note = note.value;
        });
      }
      saveData();
    };

    td2.appendChild(plan);
    td2.appendChild(done);
    td2.appendChild(note);

    tr.appendChild(td1); tr.appendChild(td2);
    pTbl.appendChild(tr);
  });

  pCard.appendChild(pTbl);
  box.appendChild(pCard);

  /** individual deliverables */
  box.appendChild(labelRow("æå‡ºç‰©ç¢ºèªï¼ˆå…ç«¥åˆ¥ï¼‰", `<b>${state.currentStudent}</b>`));
  const dCard = document.createElement("div"); dCard.className="card";
  const dTbl2 = document.createElement("table"); dTbl2.className="table";

  state.data.settings.deliverables.forEach(d=>{
    const tr = document.createElement("tr");
    const td1 = document.createElement("td"); td1.className="w-170";
    td1.innerHTML = `<b>${d.label}</b>
      <div class="small mono">${d.id}</div>
      <div class="small">å˜å…ƒï¼š${unitLabel(d.unit)}</div>`;

    const td2 = document.createElement("td");
    const row = document.createElement("div"); row.className="row";

    const chk = document.createElement("input"); chk.type="checkbox";
    chk.checked = !!rec.deliverables.byId[d.id]?.submitted;
    chk.onchange = ()=>{ rec.deliverables.byId[d.id].submitted = chk.checked; saveData(); };

    const date = document.createElement("input"); date.placeholder="æå‡ºæ—¥ï¼ˆä»»æ„ï¼‰";
    date.value = rec.deliverables.byId[d.id]?.date || "";
    date.oninput = ()=>{ rec.deliverables.byId[d.id].date = date.value; saveData(); };

    const note = document.createElement("input"); note.placeholder="ãƒ¡ãƒ¢ï¼ˆå†æå‡º/æœªå®Œãªã©ï¼‰";
    note.value = rec.deliverables.byId[d.id]?.note || "";
    note.oninput = ()=>{ rec.deliverables.byId[d.id].note = note.value; saveData(); };

    row.appendChild(chk);
    row.appendChild(document.createTextNode("æå‡º"));
    row.appendChild(date);
    row.appendChild(note);

    td2.appendChild(row);
    tr.appendChild(td1); tr.appendChild(td2);
    dTbl2.appendChild(tr);
  });

  dCard.appendChild(dTbl2);
  box.appendChild(dCard);

  /** photos */
  box.appendChild(labelRow("æˆæ¥­ã®æ§˜å­ï¼ˆå†™çœŸä¿å­˜ï¼‰", `<span class="small">ç«¯æœ«å†…ä¿å­˜ï¼ˆIndexedDBï¼‰</span>`));
  const phCard = document.createElement("div"); phCard.className="card";

  const phRow = document.createElement("div"); phRow.className="row";
  const sessionSel = document.createElement("select");
  state.data.settings.sessions.forEach(s=>{
    const o=document.createElement("option");
    o.value=s.id;
    o.textContent=`${s.id}ï½œ${s.label}`;
    sessionSel.appendChild(o);
  });

  const fileInp = document.createElement("input");
  fileInp.type="file";
  fileInp.accept="image/*";
  fileInp.capture="environment";

  const noteInp = document.createElement("input");
  noteInp.placeholder="å†™çœŸãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰";
  noteInp.className="grow";

  const addBtn = document.createElement("button");
  addBtn.className="btn primary";
  addBtn.textContent="å†™çœŸã‚’ä¿å­˜";
  addBtn.onclick = async ()=>{
    const f = fileInp.files?.[0];
    if(!f) return alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    addBtn.disabled = true;
    try{
      await addPhoto({
        student: state.currentStudent,
        sessionId: sessionSel.value,
        note: noteInp.value,
        file: f
      });
      fileInp.value="";
      noteInp.value="";
      await renderPhotosList(phCard);
    }catch(e){
      alert("å†™çœŸä¿å­˜ã«å¤±æ•—ï¼š" + e.message);
    }finally{
      addBtn.disabled = false;
    }
  };

  phRow.appendChild(document.createTextNode("æˆæ¥­æ ï¼š"));
  phRow.appendChild(sessionSel);
  phRow.appendChild(fileInp);
  phRow.appendChild(noteInp);
  phRow.appendChild(addBtn);
  phCard.appendChild(phRow);

  const phListWrap = document.createElement("div");
  phListWrap.className="hr";
  phCard.appendChild(phListWrap);

  const thumbs = document.createElement("div");
  thumbs.className="thumbs";
  thumbs.id = "thumbsArea";
  phCard.appendChild(thumbs);

  box.appendChild(phCard);

  // åˆå›è¡¨ç¤º
  renderPhotosList(phCard);

  return box;
}

async function renderPhotosList(containerCard){
  const thumbs = containerCard.querySelector("#thumbsArea");
  if(!thumbs) return;
  thumbs.innerHTML = `<div class="note">èª­ã¿è¾¼ã¿ä¸­â€¦</div>`;
  const items = await listPhotosByStudent(state.currentStudent, 80);
  if(!items.length){
    thumbs.innerHTML = `<div class="note">ã¾ã å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
    return;
  }
  thumbs.innerHTML = "";
  items.forEach(p=>{
    const url = URL.createObjectURL(p.blob);
    const d = document.createElement("div");
    d.className="thumb";
    d.innerHTML = `
      <img src="${url}" alt="photo">
      <div class="meta">
        <div class="t">${escapeHtml(new Date(p.createdAt).toLocaleString())}</div>
        <div class="t">æ ï¼š${escapeHtml(p.sessionId||"-")}</div>
        <div class="t">${escapeHtml(p.note||"")}</div>
        <div class="b">
          <button data-act="open">é–‹ã</button>
          <button data-act="del">å‰Šé™¤</button>
        </div>
      </div>
    `;
    d.querySelector('[data-act="open"]').onclick = ()=>{
      window.open(url, "_blank");
    };
    d.querySelector('[data-act="del"]').onclick = async ()=>{
      if(!confirm("ã“ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      await deletePhoto(p.id);
      URL.revokeObjectURL(url);
      await renderPhotosList(containerCard);
    };
    thumbs.appendChild(d);
  });
}

/** ===== overview (ã‚¯ãƒ©ã‚¹) ===== */
function renderOverview(){
  const box = document.createElement("div");

  const controls = document.createElement("div"); controls.className="card";
  controls.appendChild(labelRow("ä¸€è¦§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«", `<span class="small">å˜å…ƒã§çµã‚Šè¾¼ã¿ï¼CSVå‡ºåŠ›</span>`));
  const row = document.createElement("div"); row.className="row";

  const filterSel = document.createElement("select");
  UNITS.forEach(u=>{
    const o=document.createElement("option"); o.value=u.id; o.textContent=u.label; filterSel.appendChild(o);
  });
  filterSel.value = state.overviewFilterUnit || "all";
  filterSel.onchange = ()=>{
    state.overviewFilterUnit = filterSel.value;
    renderPanel();
  };

  const btnP = document.createElement("button");
  btnP.className="btn";
  btnP.textContent = "é€²æ—CSVå‡ºåŠ›";
  btnP.onclick = ()=> exportProgressCSV(state.overviewFilterUnit);

  const btnD = document.createElement("button");
  btnD.className="btn";
  btnD.textContent = "æå‡ºç‰©CSVå‡ºåŠ›";
  btnD.onclick = ()=> exportDeliverablesCSV(state.overviewFilterUnit);

  row.appendChild(document.createTextNode("å˜å…ƒãƒ•ã‚£ãƒ«ã‚¿ï¼š"));
  row.appendChild(filterSel);
  row.appendChild(btnP);
  row.appendChild(btnD);
  controls.appendChild(row);
  box.appendChild(controls);

  box.appendChild(labelRow("é€²æ—ä¸€è¦§ï¼ˆå…¨å“¡Ã—æˆæ¥­æ ï¼‰", `<span class="small">æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ã‚»ãƒ«ã‚¿ãƒƒãƒ—ã§çŠ¶æ…‹åˆ‡æ›¿</span>`));
  const prog = document.createElement("div"); prog.className="card";
  prog.appendChild(buildProgressOverviewTable(state.overviewFilterUnit));
  box.appendChild(prog);

  box.appendChild(labelRow("æå‡ºç‰©ä¸€è¦§ï¼ˆå…¨å“¡Ã—æå‡ºç‰©ï¼‰", `<span class="small">æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ã‚»ãƒ«ã‚¿ãƒƒãƒ—ã§æå‡ºåˆ‡æ›¿</span>`));
  const del = document.createElement("div"); del.className="card";
  del.appendChild(buildDeliverablesOverviewTable(state.overviewFilterUnit));
  box.appendChild(del);

  return box;
}

function buildProgressOverviewTable(filterUnit="all"){
  const container = document.createElement("div"); container.className="scrollX";
  const tbl = document.createElement("table"); tbl.className="ovTable";

  const sessions = state.data.settings.sessions.filter(s=> filterUnit==="all" ? true : (s.unit===filterUnit));

  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  const th0 = document.createElement("th"); th0.className="sticky2";
  th0.textContent = "å…ç«¥";
  trh.appendChild(th0);

  sessions.forEach(s=>{
    const th = document.createElement("th");
    th.innerHTML = `
      <div class="mono">${s.id}</div>
      <div>${s.label}</div>
      <div class="mini"><span class="dot ${unitDotClass(s.unit)}"></span>${unitLabel(s.unit)}${s.isGroup?"ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—":""}</div>
    `;
    th.classList.add(unitClass(s.unit));
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  tbl.appendChild(thead);

  const tbody = document.createElement("tbody");
  state.data.students.forEach(stName=>{
    const r = state.data.byStudent[stName];
    const tr = document.createElement("tr");

    const td0 = document.createElement("td"); td0.className="sticky";
    td0.innerHTML = `<b>${stName}</b><div class="mini">ã‚¿ãƒƒãƒ—ã§å€‹äººã¸</div>`;
    td0.onclick = ()=>{
      state.currentStudent = stName;
      document.getElementById("studentSelect").value = stName;
      document.getElementById("currentName").textContent = stName;
      refreshKPIs();
      state.currentTab = "progress";
      renderTabs();
      renderPanel();
    };
    tr.appendChild(td0);

    sessions.forEach(s=>{
      const td = document.createElement("td");
      td.classList.add(unitClass(s.unit));
      const stt = r.progress.bySession[s.id]?.status || "æœª";
      const cell = document.createElement("div");
      cell.className = `cell st-${stt}`;
      cell.innerHTML = `<b>${stt}</b>` + (s.isGroup ? `<div class="mini">Grp:${escapeHtml(r.progress.bySession[s.id]?.group||"")}</div>` : ``);

      td.onclick = ()=>{
        const order = ["æœª","é€”ä¸­","å®Œäº†","æ¬ "];
        const cur = r.progress.bySession[s.id].status || "æœª";
        const idx = order.indexOf(cur);
        r.progress.bySession[s.id].status = order[(idx+1)%order.length];
        saveData();
        renderPanel();
      };

      td.appendChild(cell);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);

  container.appendChild(tbl);
  return container;
}

function buildDeliverablesOverviewTable(filterUnit="all"){
  const container = document.createElement("div"); container.className="scrollX";
  const tbl = document.createElement("table"); tbl.className="ovTable";

  const dels = state.data.settings.deliverables.filter(d=> filterUnit==="all" ? true : (d.unit===filterUnit));

  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  const th0 = document.createElement("th"); th0.className="sticky2";
  th0.textContent = "å…ç«¥";
  trh.appendChild(th0);

  dels.forEach(d=>{
    const th = document.createElement("th");
    th.innerHTML = `
      <div class="mono">${d.id}</div>
      <div>${d.label}</div>
      <div class="mini"><span class="dot ${unitDotClass(d.unit)}"></span>${unitLabel(d.unit)}</div>
    `;
    th.classList.add(unitClass(d.unit));
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  tbl.appendChild(thead);

  const tbody = document.createElement("tbody");
  state.data.students.forEach(stName=>{
    const r = state.data.byStudent[stName];
    const tr = document.createElement("tr");

    const td0 = document.createElement("td"); td0.className="sticky";
    td0.innerHTML = `<b>${stName}</b><div class="mini">ã‚¿ãƒƒãƒ—ã§å€‹äººã¸</div>`;
    td0.onclick = ()=>{
      state.currentStudent = stName;
      document.getElementById("studentSelect").value = stName;
      document.getElementById("currentName").textContent = stName;
      refreshKPIs();
      state.currentTab = "progress";
      renderTabs();
      renderPanel();
    };
    tr.appendChild(td0);

    dels.forEach(d=>{
      const td = document.createElement("td");
      td.classList.add(unitClass(d.unit));
      const sub = !!r.deliverables.byId[d.id]?.submitted;
      const cell = document.createElement("div");
      cell.className = `cell ${sub ? "st-å®Œäº†" : "st-æœª"}`;
      cell.innerHTML = `<b>${sub ? "æå‡º" : "æœªæå‡º"}</b>`;

      td.onclick = ()=>{
        r.deliverables.byId[d.id].submitted = !r.deliverables.byId[d.id].submitted;
        saveData();
        renderPanel();
      };

      td.appendChild(cell);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);

  container.appendChild(tbl);
  return container;
}
<!-- ===== Part4/5 END ===== -->
<!-- ===== Part5/5 START ===== -->
/** ===== è©•ä¾¡ã‚¿ãƒ–ï¼šå†¬ã®æ˜Ÿ ===== */
function renderStar(rec){
  const s = computeStarSuggest(rec);
  const box = document.createElement("div");

  box.appendChild(labelRow("å†¬ã®æ˜Ÿï½œçŸ¥è­˜ãƒ»æŠ€èƒ½Aï¼ˆæ›¸ãæ–¹ï¼‰", `ææ¡ˆï¼š<b>${s.ksA.grade}</b>ï¼ˆ${s.ksA.score}/5ï¼‰`));
  const a = document.createElement("div"); a.className="card";
  a.appendChild(checkItem("star.ksA.c1","è¦³å¯Ÿæ¡ä»¶ï¼ˆæ—¥ä»˜ãƒ»æ™‚åˆ»ãƒ»å ´æ‰€ãªã©ï¼‰ãŒåˆ†ã‹ã‚‹", rec));
  a.appendChild(checkItem("star.ksA.c2","è¦‹ãŸã“ã¨ä¸­å¿ƒã§æ›¸ã„ã¦ã„ã‚‹ï¼ˆæƒ³åƒã¨åŒºåˆ¥ï¼‰", rec));
  a.appendChild(checkItem("star.ksA.c3","è¦³å¯Ÿæ™‚åˆ»ã”ã¨ã«åˆ†ã‘ã¦è¨˜éŒ²ã—ã¦ã„ã‚‹", rec));
  a.appendChild(checkItem("star.ksA.c4","ä¸å¯§ã«æ›¸ã“ã†ã¨ã—ã¦ã„ã‚‹ï¼ˆé€”ä¸­æ”¾æ£„ãªã—ï¼‰", rec));
  const row = document.createElement("div"); row.className="row";
  const sel = document.createElement("select");
  [["1","1å›"],["2-3","2ã€œ3å›"],["4+","4å›ä»¥ä¸Šï¼ˆ+1ãƒ»ä¸Šé™5ï¼‰"]].forEach(([v,t])=>{
    const o=document.createElement("option"); o.value=v; o.textContent=t; sel.appendChild(o);
  });
  sel.value = rec.star.ksA.obsCount;
  sel.onchange=()=>{ rec.star.ksA.obsCount=sel.value; refreshKPIs(); renderPanel(); };
  row.appendChild(document.createTextNode("è¦³å¯Ÿå›æ•°ï¼š"));
  row.appendChild(sel);
  a.appendChild(row);
  box.appendChild(a);

  box.appendChild(labelRow("å†¬ã®æ˜Ÿï½œçŸ¥è­˜ãƒ»æŠ€èƒ½Bï¼ˆæŠ€èƒ½ï¼‰", `ææ¡ˆï¼š<b>${s.ksB.grade}</b>ï¼ˆ${s.ksB.score}/5ï¼‰`));
  const b = document.createElement("div"); b.className="card";
  b.appendChild(checkItem("star.ksB.c1","ä¸‰ã¤æ˜ŸãŒä¸€ç›´ç·šçŠ¶ã«æ‰ãˆã‚‰ã‚Œã¦ã„ã‚‹", rec));
  b.appendChild(checkItem("star.ksB.c2","ä¸‰ã¤æ˜Ÿï¼‹å‘¨å›²ã®æ˜Ÿã®ä½ç½®é–¢ä¿‚ãŒåˆ†ã‹ã‚‹", rec));
  b.appendChild(checkItem("star.ksB.c3","ã‚ªãƒªã‚ªãƒ³åº§å…¨ä½“ã®å½¢ãŒåˆ†ã‹ã‚‹", rec));
  b.appendChild(checkItem("star.ksB.c4","æ˜ŸåŒå£«ã®ä½ç½®é–¢ä¿‚ãŒå¤§ããå´©ã‚Œã¦ã„ãªã„", rec));
  b.appendChild(checkItem("star.ksB.c5","è¦³å¯Ÿçµæœã«ã‚‚ã¨ã¥ã„ã¦æã„ã¦ã„ã‚‹ï¼ˆå†™ã—ã§ã¯ãªã„ï¼‰", rec));
  box.appendChild(b);

  box.appendChild(labelRow("å†¬ã®æ˜Ÿï½œæ€è€ƒAï¼ˆäºˆæƒ³ï¼‰", `ææ¡ˆï¼š<b>${s.thA.grade}</b>ï¼ˆ${s.thA.score}/5ï¼‰`));
  const thA = document.createElement("div"); thA.className="card";
  const r1 = document.createElement("div"); r1.className="row";
  r1.appendChild(document.createTextNode("ç‚¹æ•°ï¼š"));
  r1.appendChild(numberInput("star.thA.score", rec, 0, 5));
  thA.appendChild(r1);
  box.appendChild(thA);

  box.appendChild(labelRow("å†¬ã®æ˜Ÿï½œæ€è€ƒBï¼ˆè€ƒå¯Ÿï¼‰", `ææ¡ˆï¼š<b>${s.thB.grade}</b>ï¼ˆ${s.thB.score}/5ï¼‰`));
  const thB = document.createElement("div"); thB.className="card";
  const r2 = document.createElement("div"); r2.className="row";
  r2.appendChild(document.createTextNode("ç‚¹æ•°ï¼š"));
  r2.appendChild(numberInput("star.thB.score", rec, 0, 5));
  thB.appendChild(r2);
  box.appendChild(thB);

  box.appendChild(labelRow("å†¬ã®æ˜Ÿï½œä¸»ä½“ï¼ˆæˆæ¥­æ…‹åº¦ï¼‰", ""));
  const att = document.createElement("div"); att.className="card";
  att.innerHTML = `<div class="note">â€»å†¬ã®æ˜Ÿã®ä¸»ä½“ã¯æˆæ¥­ä¸­ã®æ…‹åº¦ã§æ‰‹å‹•è©•ä¾¡ã€‚</div>`;
  const row3 = document.createElement("div"); row3.className="row";
  row3.appendChild(document.createTextNode("æœ€çµ‚è©•ä¾¡ï¼š"));
  row3.appendChild(gradeSelect(rec.star.attitude.final, (v)=>{ rec.star.attitude.final=v; refreshKPIs(); }));
  att.appendChild(row3);
  box.appendChild(att);

  return box;
}

/** ===== è©•ä¾¡ã‚¿ãƒ–ï¼šç”Ÿãç‰©ï¼ˆã¾ã¨ã‚ï¼‰ ===== */
function renderBio(rec){
  const s = computeBioSuggest(rec);
  const box = document.createElement("div");

  box.appendChild(labelRow("ç”Ÿãç‰©ï¼ˆã¾ã¨ã‚ï¼‰ï½œçŸ¥è­˜ãƒ»æŠ€èƒ½Aï¼ˆè¦³å¯Ÿã‚«ãƒ¼ãƒ‰ï¼‰", `ææ¡ˆï¼š<b>${s.ksA.grade}</b>ï¼ˆ${s.ksA.score}/5ï¼‰`));
  const a = document.createElement("div"); a.className="card";
  a.appendChild(checkItem("bio.ksA.c1","è¦³å¯Ÿæ¡ä»¶ï¼ˆæ—¥ä»˜ãƒ»å­£ç¯€ãƒ»å ´æ‰€ï¼‰ãŒåˆ†ã‹ã‚‹", rec));
  a.appendChild(checkItem("bio.ksA.c2","è¦‹ãŸã“ã¨ä¸­å¿ƒï¼ˆæƒ³åƒã‚„æ„Ÿæƒ³ã¨åŒºåˆ¥ï¼‰", rec));
  a.appendChild(checkItem("bio.ksA.c3","ç¶™ç¶šã—ã¦è¨˜éŒ²ã—ã¦ã„ã‚‹ï¼ˆè¤‡æ•°æ™‚æœŸï¼‰", rec));
  a.appendChild(checkItem("bio.ksA.c4","ä¸å¯§ã«æ›¸ã“ã†ã¨ã—ã¦ã„ã‚‹", rec));
  box.appendChild(a);

  box.appendChild(labelRow("ç”Ÿãç‰©ï¼ˆã¾ã¨ã‚ï¼‰ï½œæ€è€ƒAï¼ˆæ¯”è¼ƒï¼‰", `ææ¡ˆï¼š<b>${s.thA.grade}</b>ï¼ˆ${s.thA.score}/5ï¼‰`));
  const thA = document.createElement("div"); thA.className="card";
  const r1 = document.createElement("div"); r1.className="row";
  r1.appendChild(document.createTextNode("ç‚¹æ•°ï¼š"));
  r1.appendChild(numberInput("bio.thA.score", rec, 0, 5));
  thA.appendChild(r1);
  const advA = document.createElement("label"); advA.className="chk";
  const advChkA = document.createElement("input"); advChkA.type="checkbox"; advChkA.checked=!!rec.bio.thA.multiUsed;
  advChkA.onchange=()=>{ rec.bio.thA.multiUsed = advChkA.checked; refreshKPIs(); renderPanel(); };
  advA.appendChild(advChkA);
  const advTxtA = document.createElement("div");
  advTxtA.innerHTML = `<div><b>2ç¨®é¡ä»¥ä¸Šä½¿ã£ã¦è€ƒå¯Ÿï¼ˆ+1 & Cãªã—ï¼‰</b></div>`;
  advA.appendChild(advTxtA);
  thA.appendChild(advA);
  box.appendChild(thA);

  box.appendChild(labelRow("ç”Ÿãç‰©ï¼ˆã¾ã¨ã‚ï¼‰ï½œæ€è€ƒBï¼ˆé–¢ä¿‚ã¥ã‘ï¼‰", `ææ¡ˆï¼š<b>${s.thB.grade}</b>ï¼ˆ${s.thB.score}/5ï¼‰`));
  const thB = document.createElement("div"); thB.className="card";
  const r2 = document.createElement("div"); r2.className="row";
  r2.appendChild(document.createTextNode("ç‚¹æ•°ï¼š"));
  r2.appendChild(numberInput("bio.thB.score", rec, 0, 5));
  thB.appendChild(r2);
  const advB = document.createElement("label"); advB.className="chk";
  const advChkB = document.createElement("input"); advChkB.type="checkbox"; advChkB.checked=!!rec.bio.thB.multiUsed;
  advChkB.onchange=()=>{ rec.bio.thB.multiUsed = advChkB.checked; refreshKPIs(); renderPanel(); };
  advB.appendChild(advChkB);
  const advTxtB = document.createElement("div");
  advTxtB.innerHTML = `<div><b>2ç¨®é¡ä»¥ä¸Šä½¿ã£ã¦è€ƒå¯Ÿï¼ˆ+1 & Cãªã—ï¼‰</b></div>`;
  advB.appendChild(advTxtB);
  thB.appendChild(advB);
  box.appendChild(thB);

  box.appendChild(labelRow("ä¸»ä½“ï¼ˆè¦³å¯Ÿã‚«ãƒ¼ãƒ‰ï¼‹ã‚·ãƒ³ã‚­ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ä¸­å¿ƒï¼‰", `ææ¡ˆï¼š<b>${s.attitude.grade || "-"}</b>`));
  const att = document.createElement("div"); att.className="card";
  att.appendChild(checkItem("bio.attitude.checks.c1","æå‡ºç‰©ã‚’å®Œæˆã•ã›ã¦ã„ã‚‹", rec));
  att.appendChild(checkItem("bio.attitude.checks.c2","å¯¾è±¡ã‚’è‡ªåˆ†ã§é¸ã‚“ã§å–ã‚Šçµ„ã‚“ã§ã„ã‚‹", rec));
  att.appendChild(checkItem("bio.attitude.checks.c3","ä¿®æ­£ãƒ»ä»˜ã‘è¶³ã—ã®è·¡ãŒã‚ã‚‹", rec));
  att.appendChild(checkItem("bio.attitude.checks.c4","å›³ã‚„å†™çœŸã‚’æ´»ç”¨ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹", rec));
  att.appendChild(checkItem("bio.attitude.checks.c5","æœ€å¾Œã¾ã§ã‚„ã‚Šåˆ‡ã£ã¦ã„ã‚‹", rec));
  const rowF = document.createElement("div"); rowF.className="row";
  rowF.appendChild(document.createTextNode("æœ€çµ‚è©•ä¾¡ï¼š"));
  rowF.appendChild(gradeSelect(rec.bio.attitude.final, (v)=>{ rec.bio.attitude.final=v; refreshKPIs(); }));
  att.appendChild(rowF);
  box.appendChild(att);

  return box;
}

/** ===== è©•ä¾¡ã‚¿ãƒ–ï¼šæ°´ã®ã‚†ããˆ ===== */
function renderWater(rec){
  const s = computeWaterSuggest(rec);
  const box = document.createElement("div");

  box.appendChild(labelRow("æ°´ã®ã‚†ããˆï½œä¸»ä½“ï¼ˆå®‰å…¨å«ã‚€ï¼‰", `ææ¡ˆï¼š<b>${s.attitude.grade || "-"}</b>`));
  const att = document.createElement("div"); att.className="card";
  att.appendChild(checkItem("water.attitude.checks.c1","è¨˜éŒ²ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹", rec));
  att.appendChild(checkItem("water.attitude.checks.c2","ãã®å ´ã§æ›¸ã“ã†ã¨ã—ã¦ã„ã‚‹", rec));
  att.appendChild(checkItem("water.attitude.checks.c3","å®‰å…¨ã«é…æ…®ã—ã¦ã„ã‚‹", rec));
  att.appendChild(checkItem("water.attitude.checks.c4","å½¹å‰²ã‚’æ„è­˜ã—ã¦è¡Œå‹•", rec));
  att.appendChild(checkItem("water.attitude.checks.c5","ç‰‡ä»˜ã‘ã¾ã§ã‚„ã‚Šåˆ‡ã‚‹", rec));
  const severeRow = document.createElement("label"); severeRow.className="chk";
  const severe = document.createElement("input"); severe.type="checkbox"; severe.checked=!!rec.water.attitude.severe;
  severe.onchange=()=>{ rec.water.attitude.severe=severe.checked; refreshKPIs(); renderPanel(); };
  severeRow.appendChild(severe);
  const severeTxt = document.createElement("div");
  severeTxt.innerHTML = `<div><b>é‡å¤§ãªå®‰å…¨é•åï¼ˆCå›ºå®šï¼‰</b></div><div class="small">ã‚ã–ã¨å™¨å…·ç ´æãƒ»å±å®³ãªã©</div>`;
  severeRow.appendChild(severeTxt);
  att.appendChild(severeRow);
  const rowF = document.createElement("div"); rowF.className="row";
  rowF.appendChild(document.createTextNode("æœ€çµ‚è©•ä¾¡ï¼š"));
  rowF.appendChild(gradeSelect(rec.water.attitude.final, (v)=>{ rec.water.attitude.final=v; refreshKPIs(); }));
  att.appendChild(rowF);
  box.appendChild(att);

  const evap = document.createElement("div"); evap.className="card";
  evap.appendChild(labelRow("è’¸ç™ºï½œçŸ¥è­˜ãƒ»æŠ€èƒ½A/Bï¼ˆãƒã‚§ãƒƒã‚¯ï¼‰", `ææ¡ˆï¼šçŸ¥A:${s.evap.ksA.grade} çŸ¥B:${s.evap.ksB.grade} æ€:${s.evap.th.grade}`));
  evap.appendChild(checkItem("water.evap.ksA.c1","æ¡ä»¶ã‚’æ‰ãˆã¦ã„ã‚‹ï¼ˆæ¸©åº¦/å ´æ‰€ãªã©ï¼‰", rec));
  evap.appendChild(checkItem("water.evap.ksA.c2","å¤‰åŒ–ã‚’æ‰ãˆã¦ã„ã‚‹ï¼ˆæ¸›ã£ãŸç­‰ï¼‰", rec));
  evap.appendChild(checkItem("water.evap.ksA.c3","å›³ã‚„è¨€è‘‰ã§è¡¨ã›ã¦ã„ã‚‹", rec));
  evap.appendChild(checkItem("water.evap.ksA.c4","ä¸å¯§ã«è¨˜éŒ²ã—ã¦ã„ã‚‹", rec));
  evap.appendChild(checkItem("water.evap.ksA.c5","æ ¹æ‹ ã«åŸºã¥ãè¨˜éŒ²", rec));
  evap.appendChild(newHr());
  evap.appendChild(checkItem("water.evap.ksB.c1","çµæœã¨åŸå› ã‚’åŒºåˆ¥", rec));
  evap.appendChild(checkItem("water.evap.ksB.c2","æ¯”è¼ƒãŒã§ãã¦ã„ã‚‹", rec));
  evap.appendChild(checkItem("water.evap.ksB.c3","è¨€ã„æ›ãˆ/ã¾ã¨ã‚ãŒã§ãã¦ã„ã‚‹", rec));
  evap.appendChild(checkItem("water.evap.ksB.c4","å®Ÿé¨“çµæœã«æ²¿ã†", rec));
  evap.appendChild(checkItem("water.evap.ksB.c5","ç”¨èªã‚’é©åˆ‡ã«ä½¿ç”¨", rec));
  const rr1 = document.createElement("div"); rr1.className="row";
  rr1.appendChild(document.createTextNode("è€ƒå¯Ÿç‚¹ï¼ˆ0-5ï¼‰ï¼š"));
  rr1.appendChild(numberInput("water.evap.th.score", rec, 0, 5));
  evap.appendChild(rr1);
  box.appendChild(evap);

  const cond = document.createElement("div"); cond.className="card";
  cond.appendChild(labelRow("çµéœ²ï½œçŸ¥è­˜ãƒ»æŠ€èƒ½A/Bï¼ˆãƒã‚§ãƒƒã‚¯ï¼‰", `ææ¡ˆï¼šçŸ¥A:${s.cond.ksA.grade} çŸ¥B:${s.cond.ksB.grade} æ€:${s.cond.th.grade}`));
  cond.appendChild(checkItem("water.cond.ksA.c1","æ¡ä»¶ã‚’æ‰ãˆã¦ã„ã‚‹ï¼ˆå†·ã‚„ã™ç­‰ï¼‰", rec));
  cond.appendChild(checkItem("water.cond.ksA.c2","å¤‰åŒ–ã‚’æ‰ãˆã¦ã„ã‚‹ï¼ˆæ°´æ»´ç­‰ï¼‰", rec));
  cond.appendChild(checkItem("water.cond.ksA.c3","å›³ã‚„è¨€è‘‰ã§è¡¨ã›ã¦ã„ã‚‹", rec));
  cond.appendChild(checkItem("water.cond.ksA.c4","ä¸å¯§ã«è¨˜éŒ²ã—ã¦ã„ã‚‹", rec));
  cond.appendChild(checkItem("water.cond.ksA.c5","æ ¹æ‹ ã«åŸºã¥ãè¨˜éŒ²", rec));
  cond.appendChild(newHr());
  cond.appendChild(checkItem("water.cond.ksB.c1","çµæœã¨åŸå› ã‚’åŒºåˆ¥", rec));
  cond.appendChild(checkItem("water.cond.ksB.c2","æ¯”è¼ƒãŒã§ãã¦ã„ã‚‹", rec));
  cond.appendChild(checkItem("water.cond.ksB.c3","è¨€ã„æ›ãˆ/ã¾ã¨ã‚ãŒã§ãã¦ã„ã‚‹", rec));
  cond.appendChild(checkItem("water.cond.ksB.c4","å®Ÿé¨“çµæœã«æ²¿ã†", rec));
  cond.appendChild(checkItem("water.cond.ksB.c5","ç”¨èªã‚’é©åˆ‡ã«ä½¿ç”¨", rec));
  const rr2 = document.createElement("div"); rr2.className="row";
  rr2.appendChild(document.createTextNode("è€ƒå¯Ÿç‚¹ï¼ˆ0-5ï¼‰ï¼š"));
  rr2.appendChild(numberInput("water.cond.th.score", rec, 0, 5));
  cond.appendChild(rr2);
  box.appendChild(cond);

  return box;
}

/** ===== è©•ä¾¡ã‚¿ãƒ–ï¼šç™ºè¡¨ï¼ˆä¸»ä½“ï¼‰ ===== */
function renderPres(rec){
  const s = computePresSuggest(rec);
  const box = document.createElement("div");
  box.appendChild(labelRow("ç™ºè¡¨ä¼šï½œä¸»ä½“ã®ã¿", `ææ¡ˆï¼š<b>${s.attitude.grade || "-"}</b>`));
  const att = document.createElement("div"); att.className="card";
  att.appendChild(checkItem("pres.attitude.checks.c1","ç™ºè¡¨æº–å‚™ã«é–¢ã‚ã£ã¦ã„ã‚‹", rec));
  att.appendChild(checkItem("pres.attitude.checks.c2","è‡ªåˆ†ã®å½¹å‰²ã‚’æœãŸãã†ã¨ã—ã¦ã„ã‚‹", rec));
  att.appendChild(checkItem("pres.attitude.checks.c3","å‰å‘ãã«å‚åŠ ã—ã¦ã„ã‚‹", rec));
  att.appendChild(checkItem("pres.attitude.checks.c4","ä»²é–“ã¨å”åŠ›ã—ã¦ã„ã‚‹", rec));
  att.appendChild(checkItem("pres.attitude.checks.c5","æœ€å¾Œã¾ã§ã‚„ã‚Šåˆ‡ã£ã¦ã„ã‚‹", rec));
  const rowF = document.createElement("div"); rowF.className="row";
  rowF.appendChild(document.createTextNode("æœ€çµ‚è©•ä¾¡ï¼š"));
  rowF.appendChild(gradeSelect(rec.pres.attitude.final, (v)=>{ rec.pres.attitude.final=v; refreshKPIs(); }));
  att.appendChild(rowF);
  box.appendChild(att);
  return box;
}

function newHr(){
  const d = document.createElement("div");
  d.className="hr";
  return d;
}

/** ===== Start ===== */
init();
</script>
</body>
</html>
<!-- ===== Part5/5 END ===== -->
