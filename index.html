<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>4年理科 評価記録ツール（冬プロ）</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#12141a; --card2:#161a22; --text:#e8eef7; --muted:#a9b3c2;
      --line:#232a36; --accent:#59a8ff; --good:#4ade80; --bad:#fb7185; --warn:#fbbf24;
      --chip:#1c2330; --btn:#1f2a3a;

      --s-miss: rgba(251,113,133,.18); /* 欠 */
      --s-todo: rgba(251,191,36,.14);  /* 未 */
      --s-doing: rgba(89,168,255,.16); /* 途中 */
      --s-done: rgba(74,222,128,.14);  /* 完了 */

      --u-star: rgba(89,168,255,.14);
      --u-bio: rgba(74,222,128,.12);
      --u-water: rgba(251,191,36,.12);
      --u-pres: rgba(168,85,247,.14);
      --u-test: rgba(251,113,133,.12);
      --u-other: rgba(255,255,255,.05);

      /* ===== light theme vars ===== */
      --bgL:#f6f7fb; --cardL:#ffffff; --card2L:#f0f3f9; --textL:#0f172a; --mutedL:#52627a;
      --lineL:#d7dee9; --chipL:#eef2f7; --btnL:#ffffff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0c10,#0a0b10 40%,#07080d);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;z-index:50;background:rgba(10,11,16,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1250px;margin:0 auto;padding:14px 14px 22px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    h1{font-size:16px;margin:0 0 6px 0;letter-spacing:.02em}
    .sub{font-size:12px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .card.soft{background:var(--card2)}
    .grow{flex:1}
    .btn{background:var(--btn);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:12px;font-size:13px;cursor:pointer}
    .btn:hover{border-color:#2f3a4b}
    .btn.primary{background:linear-gradient(180deg,#2a63ff,#1f49ff);border-color:#2a63ff}
    .btn.danger{background:linear-gradient(180deg,#ff3b66,#e11d48);border-color:#ff3b66}
    input,select,textarea{background:#0e1118;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px;font-size:13px}
    textarea{min-height:70px;resize:vertical}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:transparent;color:var(--text);cursor:pointer;font-size:13px}
    .tab.active{background:var(--chip);border-color:#2d3a50}
    .grid{display:grid;gap:12px}
    @media (min-width: 920px){ .grid{grid-template-columns: 340px 1fr} }
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .k{padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.02)}
    .k .t{font-size:12px;color:var(--muted)}
    .k .v{font-size:16px;font-weight:700;margin-top:2px;line-height:1.25}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.04);border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .sec-title{display:flex;justify-content:space-between;align-items:flex-end;gap:10px;margin-bottom:8px}
    .sec-title h2{font-size:14px;margin:0}
    .sec-title .hint{font-size:12px;color:var(--muted)}
    .chk{display:flex;gap:10px;align-items:flex-start;padding:10px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.12)}
    .chk input{margin-top:2px}
    .two{display:grid;gap:12px}
    @media (min-width: 760px){ .two{grid-template-columns: 1fr 1fr} }
    details{border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(255,255,255,.02)}
    summary{cursor:pointer;color:var(--muted);font-size:12px}
    .note{font-size:12px;color:var(--muted);line-height:1.55}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .small{font-size:12px;color:var(--muted)}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table td{padding:10px 10px;background:rgba(255,255,255,.02);border-top:1px solid var(--line);border-bottom:1px solid var(--line);vertical-align:top}
    .table td:first-child{border-left:1px solid var(--line);border-radius:12px 0 0 12px}
    .table td:last-child{border-right:1px solid var(--line);border-radius:0 12px 12px 0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .w-110{width:110px}
    .w-140{width:140px}
    .w-170{width:170px}

    .scrollX{overflow:auto;border:1px solid var(--line);border-radius:14px}
    .ovTable{width:max-content; border-collapse:separate; border-spacing:0; min-width:100%}
    .ovTable th,.ovTable td{border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:8px 8px;font-size:12px;vertical-align:top;background:rgba(255,255,255,.02)}
    .ovTable th{position:sticky;top:0;z-index:5;background:rgba(18,20,26,.98);backdrop-filter:blur(8px);font-weight:700}
    .ovTable .sticky{position:sticky;left:0;z-index:6;background:rgba(18,20,26,.98)}
    .ovTable .sticky2{position:sticky;left:0;z-index:7;background:rgba(18,20,26,.98);font-weight:800}
    .cell{border-radius:10px;padding:6px 8px;border:1px solid rgba(255,255,255,.06)}
    .st-未{background:var(--s-todo)}
    .st-途中{background:var(--s-doing)}
    .st-完了{background:var(--s-done)}
    .st-欠{background:var(--s-miss)}
    .u-star{box-shadow: inset 0 0 0 999px var(--u-star)}
    .u-bio{box-shadow: inset 0 0 0 999px var(--u-bio)}
    .u-water{box-shadow: inset 0 0 0 999px var(--u-water)}
    .u-pres{box-shadow: inset 0 0 0 999px var(--u-pres)}
    .u-test{box-shadow: inset 0 0 0 999px var(--u-test)}
    .u-other{box-shadow: inset 0 0 0 999px var(--u-other)}
    .dot{display:inline-block;width:8px;height:8px;border-radius:999px;margin-right:6px;vertical-align:middle}
    .dot.star{background:#59a8ff}
    .dot.bio{background:#4ade80}
    .dot.water{background:#fbbf24}
    .dot.pres{background:#a855f7}
    .dot.test{background:#fb7185}
    .dot.other{background:#a9b3c2}
    .mini{font-size:11px;color:var(--muted);margin-top:4px}

    /* ===== photo gallery ===== */
    .gallery{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .thumb{width:150px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:rgba(255,255,255,.02)}
    .thumb img{width:100%;height:110px;object-fit:cover;display:block;cursor:pointer}
    .thumb .cap{padding:8px;font-size:11px;color:var(--muted);line-height:1.35}
    .thumb .cap b{color:var(--text)}
    .thumb .actions{display:flex;gap:8px;padding:8px}
    .thumb .actions .btn{padding:6px 8px;border-radius:10px;font-size:12px}
    .photoBar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .photoBar .btn{padding:8px 10px}

    /* ===== theme switch ===== */
    html[data-theme="light"] body{
      background:linear-gradient(180deg,var(--bgL),#eef1f7 40%,#e9edf5);
      color:var(--textL);
    }
    html[data-theme="light"] header{background:rgba(246,247,251,.92)}
    html[data-theme="light"] .card{background:var(--cardL);border-color:var(--lineL)}
    html[data-theme="light"] .card.soft{background:var(--card2L)}
    html[data-theme="light"] .sub,
    html[data-theme="light"] .note,
    html[data-theme="light"] .small,
    html[data-theme="light"] .mini,
    html[data-theme="light"] summary,
    html[data-theme="light"] .pill,
    html[data-theme="light"] .k .t,
    html[data-theme="light"] .sec-title .hint{color:var(--mutedL)}
    html[data-theme="light"] input,
    html[data-theme="light"] select,
    html[data-theme="light"] textarea{
      background:#ffffff;border-color:var(--lineL);color:var(--textL)
    }
    html[data-theme="light"] .btn{background:var(--btnL);border-color:var(--lineL);color:var(--textL)}
    html[data-theme="light"] .tab{border-color:var(--lineL);color:var(--textL)}
    html[data-theme="light"] .tab.active{background:var(--chipL);border-color:#c7d2e3}
    html[data-theme="light"] .ovTable th,
    html[data-theme="light"] .ovTable td{
      background:rgba(15,23,42,.03);border-color:var(--lineL)
    }
    html[data-theme="light"] .ovTable th,
    html[data-theme="light"] .ovTable .sticky,
    html[data-theme="light"] .ovTable .sticky2{background:rgba(255,255,255,.96)}

    /* ===== iPad 横画面最適化 ===== */
    @media (min-width: 1024px) and (orientation: landscape){
      .wrap{max-width:1400px}
      .grid{grid-template-columns: 380px 1fr}
      .ovTable th,.ovTable td{font-size:13px}
      textarea{min-height:80px}
      h1{font-size:17px}
    }
    /* ===== iPad landscape optimization ===== */
@media (orientation: landscape) and (min-width: 900px){
  .wrap{max-width: 1400px}
  h1{font-size:18px}
  .grid{grid-template-columns: 420px 1fr}
  .tabs{gap:10px}
  .tab{padding:11px 14px;font-size:14px}
  .btn{font-size:14px;padding:10px 14px}
  input,select,textarea{font-size:14px}
  .table td{padding:12px 12px}
  .ovTable th,.ovTable td{font-size:13px}
}
@media (orientation: landscape) and (min-width: 1100px){
  .grid{grid-template-columns: 460px 1fr}
}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>4年理科 評価記録ツール（冬の自然探究プロジェクト）</h1>
        <div class="sub">オフライン／端末内保存（localStorage＋写真はIndexedDB）・進捗＆提出物＆評価（提案＋手動調整）</div>
      </div>
      <div class="row">
        <button class="btn" id="btnExport">エクスポート(JSON)</button>
        <button class="btn" id="btnImport">インポート</button>
        <button class="btn" id="btnTheme">テーマ</button>
        <button class="btn danger" id="btnReset">全データ削除</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap grid">
  <div class="card">
    <div class="sec-title">
      <h2>名簿</h2>
      <span class="hint">児童を選んで入力</span>
    </div>

    <div class="row">
      <select id="studentSelect" class="grow"></select>
      <button class="btn" id="btnAddStudent">追加</button>
      <button class="btn" id="btnRenameStudent">名前変更</button>
    </div>
    <div class="row">
      <input id="newStudentName" class="grow" placeholder="追加する児童名（例：山田 太郎）" />
    </div>

    <div class="hr"></div>

    <div class="sec-title">
      <h2>現在の児童：<span id="currentName"></span></h2>
      <span class="hint">提案評価（参考）</span>
    </div>

    <!-- 児童名の変更（リネーム） -->
    <div class="row">
      <input id="renameStudentName" class="grow" placeholder="この児童の名前を変更（例：山田 花子）" />
      <button class="btn" id="btnRenameStudent">名前変更</button>
    </div>
    <div class="note">※名前変更は進捗/評価/提出物に加えて、保存済み写真（IndexedDB）も移行します。</div>

    <div class="hr"></div>

    <div class="kpi">
      <div class="k"><div class="t">冬の星</div><div class="v" id="kStar">-</div></div>
      <div class="k"><div class="t">生き物（まとめ）</div><div class="v" id="kBio">-</div></div>
      <div class="k"><div class="t">水のゆくえ</div><div class="v" id="kWater">-</div></div>
      <div class="k"><div class="t">発表（主体）</div><div class="v" id="kPres">-</div></div>
    </div>

    <div class="hr"></div>

    <div class="sec-title">
      <h2>色分け（単元）</h2>
    </div>
    <div class="note">
      <span class="dot star"></span>星　<span class="dot bio"></span>生き物　<span class="dot water"></span>水　
      <span class="dot pres"></span>発表　<span class="dot test"></span>テスト　<span class="dot other"></span>その他
    </div>

    <div class="hr"></div>

    <div class="sec-title">
      <h2>評価換算ルール（共通）</h2>
    </div>
    <div class="note">
      点数→5段階：5=A / 4=B+ / 3=B / 2=B- / 1,0=C（提案表示）。<br>
      最終調整は各項目の「最終評価」で上書きできます。
    </div>

    <div class="hr"></div>
    <div class="sec-title">
      <h2>グループ同期</h2>
      <span class="hint">自由進度の管理用</span>
    </div>
    <div class="note">
      進捗の各授業枠に「グループ」を入れると、<b>同じ授業枠 & 同じグループ</b>の児童へ
      「状態・計画・実績」が自動反映されます（教師メモは同期しません）。
    </div>
  </div>

  <div class="card soft">
    <div class="tabs" id="tabs"></div>
    <div id="panel"></div>
  </div>
</div>
<script>
const STORAGE_KEY = "rika4_eval_winter_project_v1";

/** ===== theme (dark/light) ===== */
const THEME_KEY = "rika4_theme_v1";
function getInitialTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  if(saved==="light" || saved==="dark") return saved;
  return (window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches) ? "light" : "dark";
}
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem(THEME_KEY, theme);
  const btn = document.getElementById("btnTheme");
  if(btn) btn.textContent = `テーマ：${theme==="light" ? "ライト" : "ダーク"}`;
}

const UNITS = [
  {id:"all",  label:"（全て）"},
  {id:"star", label:"冬の星"},
  {id:"bio",  label:"生き物（まとめ）"},
  {id:"water",label:"水のゆくえ"},
  {id:"pres", label:"発表"},
  {id:"test", label:"テスト"},
  {id:"other",label:"その他"},
];

const defaultSettings = {
  sessions: [
    {id:"L1",  label:"第1時（導入・一斉）",   type:"whole", unit:"other"},
    {id:"L2",  label:"第2時（一斉）",         type:"whole", unit:"other"},
    {id:"L3",  label:"第3時（自由進度）",     type:"free",  unit:"other"},
    {id:"L4",  label:"第4時（自由進度）",     type:"free",  unit:"other"},
    {id:"L5",  label:"第5時（自由進度）",     type:"free",  unit:"other"},
    {id:"L6",  label:"第6時（一斉）",         type:"whole", unit:"other"},
    {id:"L7",  label:"第7時（自由進度）",     type:"free",  unit:"other"},
    {id:"L8",  label:"第8時（自由進度）",     type:"free",  unit:"other"},
    {id:"L9",  label:"第9時（自由進度）",     type:"free",  unit:"other"},
    {id:"L10", label:"第10時（自由進度）",    type:"free",  unit:"other"},
    {id:"L11", label:"第11時（自由進度）",    type:"free",  unit:"other"},
    {id:"L12", label:"第12時（自由進度/まとめ）", type:"free", unit:"other"},
    {id:"T1",  label:"テスト①",              type:"test",  unit:"test"},
    {id:"T2",  label:"テスト②",              type:"test",  unit:"test"},
  ],
  deliverables: [
    {id:"D1", label:"冬の星：観察カード", unit:"star"},
    {id:"D2", label:"生き物：ヘチマ観察カード", unit:"bio"},
    {id:"D3", label:"生き物：ロイロ シンキングツール", unit:"bio"},
    {id:"D4", label:"水のゆくえ：蒸発 記録カード", unit:"water"},
    {id:"D5", label:"水のゆくえ：結露 記録カード", unit:"water"},
    {id:"D6", label:"発表：ふりかえり（任意）", unit:"pres"},
  ]
};

const defaultData = {
  students: ["（児童1）","（児童2）","（児童3）","（児童4）","（児童5）","（児童6）","（児童7）"],
  byStudent: {},
  settings: structuredClone(defaultSettings)
};

function emptyRecord(){
  return {
    progress: { bySession: {} },
    deliverables: { byId: {} },

    star: {
      ksA: { c1:false, c2:false, c3:false, c4:false, obsCount:"2-3" },
      ksB: { c1:false,c2:false,c3:false,c4:false,c5:false },
      thA: { score:0 },
      thB: { score:0 },
      attitude: { suggest:"", final:"" }
    },
    bio: {
      ksA: { c1:false,c2:false,c3:false,c4:false, seasonCount:"2" },
      ksB: { c1:false,c2:false,c3:false,c4:false,c5:false },
      thA: { score:0, multiUsed:false },
      thB: { score:0, multiUsed:false },
      attitude: { checks:{c1:false,c2:false,c3:false,c4:false,c5:false}, suggest:"", final:"" }
    },
    water: {
      evap: {
        ksA:{c1:false,c2:false,c3:false,c4:false,c5:false},
        ksB:{c1:false,c2:false,c3:false,c4:false,c5:false},
        th:{ score:0 }
      },
      cond: {
        ksA:{c1:false,c2:false,c3:false,c4:false,c5:false},
        ksB:{c1:false,c2:false,c3:false,c4:false,c5:false},
        th:{ score:0 }
      },
      attitude: {
        checks:{c1:false,c2:false,c3:false,c4:false,c5:false},
        severe:false,
        suggest:"", final:""
      }
    },
    pres: {
      attitude: {
        checks:{c1:false,c2:false,c3:false,c4:false,c5:false},
        severe:false,
        suggest:"", final:""
      }
    }
  }
}

function ensureSettingsShape(settings){
  settings.sessions = settings.sessions || structuredClone(defaultSettings.sessions);
  settings.deliverables = settings.deliverables || structuredClone(defaultSettings.deliverables);
  settings.sessions.forEach(s=>{ if(!s.unit) s.unit = (s.type==="test" ? "test" : "other"); });
  settings.deliverables.forEach(d=>{ if(!d.unit) d.unit = "other"; });
}

function migrateStudentRecord(rec, settings){
  rec.progress = rec.progress || {bySession:{}};
  rec.progress.bySession = rec.progress.bySession || {};
  settings.sessions.forEach(s=>{
    if(!rec.progress.bySession[s.id]){
      rec.progress.bySession[s.id] = { status:"未", plan:"", done:"", note:"", group:"" };
    } else {
      const v = rec.progress.bySession[s.id];
      if(!v.status) v.status="未";
      if(v.plan==null) v.plan="";
      if(v.done==null) v.done="";
      if(v.note==null) v.note="";
      if(v.group==null) v.group="";
    }
  });

  rec.deliverables = rec.deliverables || {byId:{}};
  rec.deliverables.byId = rec.deliverables.byId || {};
  settings.deliverables.forEach(d=>{
    if(!rec.deliverables.byId[d.id]){
      rec.deliverables.byId[d.id] = { submitted:false, date:"", note:"" };
    } else {
      const v = rec.deliverables.byId[d.id];
      if(v.submitted==null) v.submitted=false;
      if(v.date==null) v.date="";
      if(v.note==null) v.note="";
    }
  });
}

function loadData(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){
      const d = structuredClone(defaultData);
      d.students.forEach(n=> d.byStudent[n] = emptyRecord());
      localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
      return d;
    }
    const d = JSON.parse(raw);
    d.students = d.students || [];
    d.byStudent = d.byStudent || {};
    d.settings = d.settings || structuredClone(defaultSettings);
    ensureSettingsShape(d.settings);
    d.students.forEach(n=>{
      if(!d.byStudent[n]) d.byStudent[n] = emptyRecord();
      migrateStudentRecord(d.byStudent[n], d.settings);
    });
    return d;
  }catch(e){
    console.error(e);
    const d = structuredClone(defaultData);
    d.students.forEach(n=> d.byStudent[n] = emptyRecord());
    return d;
  }
}
function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data)); }

const state = {
  data: loadData(),
  currentStudent: null,
  currentTab: "progress",
  overviewFilterUnit: "all"
};

/** ===== helpers ===== */
const gradeFromScore = (s)=>{
  if(s>=5) return "A";
  if(s===4) return "B+";
  if(s===3) return "B";
  if(s===2) return "B-";
  return "C";
};
const clamp5 = (n)=> Math.max(0, Math.min(5, n|0));
function sumChecks(obj){ return Object.values(obj).filter(Boolean).length; }
function setDeep(obj, path, value){
  const parts = path.split(".");
  let cur = obj;
  for(let i=0;i<parts.length-1;i++){ cur = cur[parts[i]]; }
  cur[parts[parts.length-1]] = value;
}
function unitClass(unitId){
  return unitId==="star"?"u-star":
         unitId==="bio"?"u-bio":
         unitId==="water"?"u-water":
         unitId==="pres"?"u-pres":
         unitId==="test"?"u-test":"u-other";
}
function unitDotClass(unitId){
  return unitId==="star"?"star":
         unitId==="bio"?"bio":
         unitId==="water"?"water":
         unitId==="pres"?"pres":
         unitId==="test"?"test":"other";
}
function unitLabel(unitId){
  return (UNITS.find(u=>u.id===unitId)?.label) || "その他";
}
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
/** ===== student rename (with photo DB migration) ===== */
async function renamePhotosStudent(oldName, newName){
  const db = await openPhotoDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(PHOTO_DB.store, "readwrite");
    const st = tx.objectStore(PHOTO_DB.store);
    const idx = st.index("by_student");
    const range = IDBKeyRange.bound([oldName, 0],[oldName, Number.MAX_SAFE_INTEGER]);
    const req = idx.getAll(range);

    req.onsuccess = ()=>{
      const items = req.result || [];
      items.forEach(p=>{
        st.put({...p, student:newName});
      });
    };
    req.onerror = ()=> reject(req.error);

    tx.oncomplete = ()=>{ db.close(); resolve(true); };
    tx.onerror = ()=>{ db.close(); reject(tx.error); };
    tx.onabort = ()=>{ db.close(); reject(tx.error); };
  });
}

async function renameStudent(oldName, newName){
  newName = (newName || "").trim();
  if(!newName) return alert("新しい名前が空です。");
  if(state.data.students.includes(newName)) return alert("同名の児童がすでにいます。");

  const idx = state.data.students.indexOf(oldName);
  if(idx<0) return alert("変更対象の児童が見つかりません。");
  state.data.students[idx] = newName;

  state.data.byStudent[newName] = state.data.byStudent[oldName];
  delete state.data.byStudent[oldName];

  if(state.currentStudent === oldName) state.currentStudent = newName;

  try{
    if(typeof openPhotoDB === "function") await renamePhotosStudent(oldName, newName);
  }catch(e){
    alert("※児童名は変更できましたが、写真の移行でエラーが出ました：" + e.message);
  }

  saveData();
  renderStudentSelect();
  renderPanel();
  refreshKPIs();
}
/** ===== Photos (IndexedDB) ===== */
const PHOTO_DB = { name:"rika4_photos_db_v1", store:"photos", version:1 };

function openPhotoDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(PHOTO_DB.name, PHOTO_DB.version);
    req.onupgradeneeded = ()=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(PHOTO_DB.store)){
        const st = db.createObjectStore(PHOTO_DB.store, {keyPath:"id"});
        st.createIndex("by_student_session", ["student","sessionId","ts"]);
        st.createIndex("by_student", ["student","ts"]);
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}
function dbTx(db, mode="readonly"){
  return db.transaction(PHOTO_DB.store, mode).objectStore(PHOTO_DB.store);
}

async function addPhoto({student, sessionId, dataUrl, memo=""}){
  const db = await openPhotoDB();
  return new Promise((resolve, reject)=>{
    const st = dbTx(db, "readwrite");
    const ts = Date.now();
    const id = `${student}__${sessionId}__${ts}__${Math.random().toString(16).slice(2)}`;
    const rec = {id, student, sessionId, ts, dataUrl, memo};
    const req = st.add(rec);
    req.onsuccess = ()=>{ db.close(); resolve(rec); };
    req.onerror = ()=>{ db.close(); reject(req.error); };
  });
}
async function listPhotos(student, sessionId){
  const db = await openPhotoDB();
  return new Promise((resolve, reject)=>{
    const st = dbTx(db, "readonly");
    const idx = st.index("by_student_session");
    const range = IDBKeyRange.bound([student, sessionId, 0],[student, sessionId, Number.MAX_SAFE_INTEGER]);
    const req = idx.getAll(range);
    req.onsuccess = ()=>{ db.close(); resolve((req.result||[]).sort((a,b)=>b.ts-a.ts)); };
    req.onerror = ()=>{ db.close(); reject(req.error); };
  });
}
async function deletePhoto(id){
  const db = await openPhotoDB();
  return new Promise((resolve, reject)=>{
    const st = dbTx(db, "readwrite");
    const req = st.delete(id);
    req.onsuccess = ()=>{ db.close(); resolve(true); };
    req.onerror = ()=>{ db.close(); reject(req.error); };
  });
}

/** 画像を縮小して dataURL化（長辺 maxSide px、JPEG品質 quality） */
async function fileToResizedDataURL(file, maxSide=1400, quality=0.82){
  const dataUrl = await new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onload = ()=> resolve(String(fr.result||""));
    fr.onerror = ()=> reject(fr.error);
    fr.readAsDataURL(file);
  });

  const img = await new Promise((resolve, reject)=>{
    const i = new Image();
    i.onload = ()=> resolve(i);
    i.onerror = reject;
    i.src = dataUrl;
  });

  let {width:w, height:h} = img;
  const scale = Math.min(1, maxSide / Math.max(w,h));
  w = Math.round(w*scale);
  h = Math.round(h*scale);

  const canvas = document.createElement("canvas");
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0,0,w,h);

  return canvas.toDataURL("image/jpeg", quality);
}

function labelRow(title, right){
  const d = document.createElement("div");
  d.className="sec-title";
  const h = document.createElement("h2");
  h.textContent = title;
  const r = document.createElement("div");
  r.className="hint";
  if(right) r.innerHTML = right;
  d.appendChild(h); d.appendChild(r);
  return d;
}

/** 写真UI（遅延読み込み） */
function buildPhotoUI(student, sessionId){
  const wrap = document.createElement("div");

  const bar = document.createElement("div");
  bar.className = "photoBar";

  const btnAdd = document.createElement("button");
  btnAdd.className = "btn primary";
  btnAdd.textContent = "写真を追加";

  const btnShow = document.createElement("button");
  btnShow.className = "btn";
  btnShow.textContent = "写真を表示（必要時読み込み）";

  const gal = document.createElement("div");
  gal.className = "gallery";

  async function refreshGallery(){
    gal.innerHTML = "";
    const photos = await listPhotos(student, sessionId);
    if(!photos.length){
      const n = document.createElement("div");
      n.className = "note";
      n.textContent = "（まだ写真はありません）";
      gal.appendChild(n);
      return;
    }
    photos.forEach(p=>{
      const t = document.createElement("div");
      t.className = "thumb";

      const img = document.createElement("img");
      img.src = p.dataUrl;
      img.alt = "photo";
      img.onclick = ()=> window.open(p.dataUrl, "_blank");

      const cap = document.createElement("div");
      cap.className = "cap";
      const d = new Date(p.ts);
      cap.innerHTML = `<b>${d.toLocaleString()}</b><br>${escapeHtml(p.memo||"")}`;

      const actions = document.createElement("div");
      actions.className = "actions";

      const btnMemo = document.createElement("button");
      btnMemo.className = "btn";
      btnMemo.textContent = "メモ編集";
      btnMemo.onclick = async ()=>{
        const memo = prompt("写真メモ（短く）", p.memo||"");
        if(memo==null) return;
        const db = await openPhotoDB();
        await new Promise((resolve, reject)=>{
          const st = dbTx(db, "readwrite");
          const req = st.put({...p, memo});
          req.onsuccess = ()=>{ db.close(); resolve(true); };
          req.onerror = ()=>{ db.close(); reject(req.error); };
        });
        await refreshGallery();
      };

      const btnDel = document.createElement("button");
      btnDel.className = "btn danger";
      btnDel.textContent = "削除";
      btnDel.onclick = async ()=>{
        if(!confirm("この写真を削除しますか？")) return;
        await deletePhoto(p.id);
        await refreshGallery();
      };

      actions.appendChild(btnMemo);
      actions.appendChild(btnDel);

      t.appendChild(img);
      t.appendChild(cap);
      t.appendChild(actions);
      gal.appendChild(t);
    });
  }

  btnShow.onclick = async ()=>{
    btnShow.disabled = true;
    btnShow.textContent = "読み込み中…";
    try{ await refreshGallery(); }
    finally{
      btnShow.disabled = false;
      btnShow.textContent = "写真を再表示";
    }
  };

  btnAdd.onclick = ()=>{
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "image/*";
    inp.capture = "environment";
    inp.onchange = async ()=>{
      const f = inp.files?.[0];
      if(!f) return;
      btnAdd.disabled = true;
      btnAdd.textContent = "保存中…";
      try{
        const resized = await fileToResizedDataURL(f, 1400, 0.82);
        const memo = prompt("写真メモ（任意）", "") || "";
        await addPhoto({student, sessionId, dataUrl: resized, memo});
        await refreshGallery();
      }catch(e){
        alert("写真の保存に失敗しました：" + e.message);
      }finally{
        btnAdd.disabled = false;
        btnAdd.textContent = "写真を追加";
      }
    };
    inp.click();
  };

  bar.appendChild(btnAdd);
  bar.appendChild(btnShow);

  wrap.appendChild(bar);
  wrap.appendChild(gal);
  return wrap;
}

/** 児童名変更時：写真を旧名→新名へ移行 */
async function migratePhotosForRename(oldName, newName){
  const db = await openPhotoDB();
  const photos = await new Promise((resolve, reject)=>{
    const st = dbTx(db, "readonly");
    const idx = st.index("by_student");
    const range = IDBKeyRange.bound([oldName, 0],[oldName, Number.MAX_SAFE_INTEGER]);
    const req = idx.getAll(range);
    req.onsuccess = ()=> resolve(req.result||[]);
    req.onerror = ()=> reject(req.error);
  });
  db.close();

  if(!photos.length) return;

  const db2 = await openPhotoDB();
  await new Promise((resolve, reject)=>{
    const st = dbTx(db2, "readwrite");
    let pending = photos.length * 2;
    const doneOne = ()=>{
      pending--;
      if(pending<=0){ db2.close(); resolve(true); }
    };
    const fail = (err)=>{
      db2.close(); reject(err);
    };

    photos.forEach(p=>{
      const ts = p.ts;
      const newId = `${newName}__${p.sessionId}__${ts}__${Math.random().toString(16).slice(2)}`;
      const putReq = st.put({...p, id:newId, student:newName});
      putReq.onsuccess = doneOne;
      putReq.onerror = ()=> fail(putReq.error);

      const delReq = st.delete(p.id);
      delReq.onsuccess = doneOne;
      delReq.onerror = ()=> fail(delReq.error);
    });
  });
}

/** グループ同期：同じ sessionId & group の児童へ status/plan/done を反映 */
function syncGroupProgress({sessionId, groupId, sourceStudent, patch}){
  if(!groupId) return;
  state.data.students.forEach(name=>{
    if(name===sourceStudent) return;
    const r = state.data.byStudent[name];
    const cell = r?.progress?.bySession?.[sessionId];
    if(!cell) return;
    if((cell.group||"").trim() !== groupId.trim()) return;
    // note（教師メモ）は同期しない
    if(patch.status != null) cell.status = patch.status;
    if(patch.plan != null) cell.plan = patch.plan;
    if(patch.done != null) cell.done = patch.done;
  });
  saveData();
}

/** ===== CSV ===== */
function csvEscape(value){
  const s = String(value ?? "");
  if(/[,"\n\r]/.test(s)) return `"${s.replaceAll('"','""')}"`;
  return s;
}
function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}
function exportProgressCSV(filterUnit="all"){
  const sessions = state.data.settings.sessions.filter(s=> filterUnit==="all" ? true : (s.unit===filterUnit));
  const header = ["児童"];
  sessions.forEach(s=>{
    header.push(`${s.id} 状態`);
    header.push(`${s.id} グループ`);
    header.push(`${s.id} 計画`);
    header.push(`${s.id} 実績`);
    header.push(`${s.id} 教師メモ`);
  });

  const rows = [header];
  state.data.students.forEach(st=>{
    const r = state.data.byStudent[st];
    const row = [st];
    sessions.forEach(s=>{
      const v = r.progress.bySession[s.id] || {status:"未",group:"",plan:"",done:"",note:""};
      row.push(v.status || "");
      row.push(v.group || "");
      row.push(v.plan || "");
      row.push(v.done || "");
      row.push(v.note || "");
    });
    rows.push(row);
  });

  const csv = rows.map(r=> r.map(csvEscape).join(",")).join("\n");
  downloadText(`rika4_progress_${filterUnit}.csv`, csv);
}
function exportDeliverablesCSV(filterUnit="all"){
  const dels = state.data.settings.deliverables.filter(d=> filterUnit==="all" ? true : (d.unit===filterUnit));
  const header = ["児童"];
  dels.forEach(d=>{
    header.push(`${d.id} 提出`);
    header.push(`${d.id} 提出日`);
    header.push(`${d.id} メモ`);
  });

  const rows = [header];
  state.data.students.forEach(st=>{
    const r = state.data.byStudent[st];
    const row = [st];
    dels.forEach(d=>{
      const v = r.deliverables.byId[d.id] || {submitted:false,date:"",note:""};
      row.push(v.submitted ? "提出" : "未提出");
      row.push(v.date || "");
      row.push(v.note || "");
    });
    rows.push(row);
  });

  const csv = rows.map(r=> r.map(csvEscape).join(",")).join("\n");
  downloadText(`rika4_deliverables_${filterUnit}.csv`, csv);
}
